<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia T√©cnicos - Conectar TV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='estilos.css') }}">
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="header-section mb-4">
            <h1 class="text-center mb-3">üìã Control de Asistencia</h1>
            <h5 class="text-center text-muted">Conectar TV</h5>
            <p class="text-center text-muted mb-0" id="fecha-actual"></p>
        </div>

        <!-- Estad√≠sticas principales -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card card-total">
                    <div class="card-body text-center">
                        <div class="stats-icon">üë•</div>
                        <h3 class="mb-0" id="stat-total">{{ total }}</h3>
                        <p class="text-muted mb-0">Total T√©cnicos</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card card-completados">
                    <div class="card-body text-center">
                        <div class="stats-icon">‚úÖ</div>
                        <h3 class="mb-0" id="stat-completados">{{ completados }}</h3>
                        <p class="text-muted mb-0">Completados</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card card-proceso">
                    <div class="card-body text-center">
                        <div class="stats-icon">‚è≥</div>
                        <h3 class="mb-0" id="stat-proceso">{{ en_proceso }}</h3>
                        <p class="text-muted mb-0">En Proceso</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card card-pendientes">
                    <div class="card-body text-center">
                        <div class="stats-icon">‚è∞</div>
                        <h3 class="mb-0" id="stat-pendientes">{{ pendientes }}</h3>
                        <p class="text-muted mb-0">Pendientes</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barra de progreso -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Progreso de Asistencia</h5>
                    <span class="badge bg-primary" id="porcentaje-badge">{{ porcentaje_asistencia }}%</span>
                </div>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         id="barra-progreso"
                         style="width: {{ porcentaje_asistencia }}%"
                         aria-valuenow="{{ porcentaje_asistencia }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        <span id="stat-presentes">{{ presentes }}</span> / <span id="stat-total-barra">{{ total }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <input type="text" id="busqueda" class="form-control" placeholder="üîç Buscar por nombre o c√©dula...">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <select id="filtroSupervisor" class="form-select">
                            <option value="">üìä Todos los supervisores</option>
                            {% for supervisor in supervisores %}
                            <option value="{{ supervisor }}">{{ supervisor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <select id="filtroCiudad" class="form-select">
                            <option value="">üèôÔ∏è Todas las ciudades</option>
                            {% for ciudad in ciudades %}
                            <option value="{{ ciudad }}">{{ ciudad }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <select id="filtroEstado" class="form-select">
                            <option value="">üìå Todos los estados</option>
                            <option value="COMPLETADO">‚úÖ Completados</option>
                            <option value="EN PROCESO">‚è≥ En Proceso</option>
                            <option value="PENDIENTE">‚è∞ Pendientes</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de t√©cnicos -->
        <div class="table-responsive">
            <table class="table table-hover" id="tablaTecnicos">
                <thead class="table-dark">
                    <tr>
                        <th>C√©dula</th>
                        <th>Nombre</th>
                        <th>Ciudad</th>
                        <th>Supervisor</th>
                        <th>Estado</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tecnico in tecnicos %}
                    <tr class="tecnico-row" 
                        data-cedula="{{ tecnico.CEDULA }}"
                        data-nombre="{{ tecnico.NOMBRE_TECNICO }}"
                        data-supervisor="{{ tecnico.SUPERVISOR }}"
                        data-ciudad="{{ tecnico.CIUDAD }}"
                        data-estado="{{ tecnico.ESTADO }}">
                        <td>{{ tecnico.CEDULA }}</td>
                        <td>{{ tecnico.NOMBRE_TECNICO }}</td>
                        <td>{{ tecnico.CIUDAD }}</td>
                        <td>{{ tecnico.SUPERVISOR }}</td>
                        <td>
                            <span class="badge estado-{{ tecnico.ESTADO }}">
                                {{ tecnico.ESTADO }}
                            </span>
                        </td>
                        <td class="hora-entrada">
                            <span class="hora-display">{{ tecnico.HORA_ENTRADA }}</span>
                            {% if tecnico.HORA_ENTRADA %}
                            <button class="btn btn-sm btn-link btn-editar-hora" 
                                    data-cedula="{{ tecnico.CEDULA }}"
                                    data-tipo="entrada"
                                    data-hora="{{ tecnico.HORA_ENTRADA }}"
                                    title="Editar entrada">
                                ‚úèÔ∏è
                            </button>
                            {% endif %}
                        </td>
                        <td class="hora-salida">
                            <span class="hora-display">{{ tecnico.HORA_SALIDA }}</span>
                            {% if tecnico.HORA_SALIDA %}
                            <button class="btn btn-sm btn-link btn-editar-hora" 
                                    data-cedula="{{ tecnico.CEDULA }}"
                                    data-tipo="salida"
                                    data-hora="{{ tecnico.HORA_SALIDA }}"
                                    title="Editar salida">
                                ‚úèÔ∏è
                            </button>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group-vertical btn-group-sm" role="group">
                                <button class="btn btn-success btn-entrada" 
                                        data-cedula="{{ tecnico.CEDULA }}"
                                        {% if tecnico.ESTADO in ['EN PROCESO', 'COMPLETADO'] %}disabled{% endif %}>
                                    ‚úì Entrada
                                </button>
                                <button class="btn btn-danger btn-salida" 
                                        data-cedula="{{ tecnico.CEDULA }}"
                                        {% if tecnico.ESTADO != 'EN PROCESO' %}disabled{% endif %}>
                                    ‚úó Salida
                                </button>
                                {% if tecnico.ESTADO != 'PENDIENTE' %}
                                <button class="btn btn-warning btn-eliminar" 
                                        data-cedula="{{ tecnico.CEDULA }}"
                                        title="Eliminar registro">
                                    üóëÔ∏è Eliminar
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal para editar hora -->
    <div class="modal fade" id="modalEditarHora" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Hora</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nueva hora (HH:MM:SS)</label>
                        <input type="time" step="1" class="form-control" id="inputNuevaHora">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarHora">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mostrar fecha actual
        const hoy = new Date();
        const opciones = { year: 'numeric', month: '2-digit', day: '2-digit' };
        document.getElementById('fecha-actual').textContent = hoy.toLocaleDateString('es-CO', opciones);

        let cedulaEditar = null;
        let tipoEditar = null;
        const modalEditarHora = new bootstrap.Modal(document.getElementById('modalEditarHora'));

        // Filtrado
        document.getElementById('busqueda').addEventListener('input', filtrarTabla);
        document.getElementById('filtroSupervisor').addEventListener('change', filtrarTabla);
        document.getElementById('filtroCiudad').addEventListener('change', filtrarTabla);
        document.getElementById('filtroEstado').addEventListener('change', filtrarTabla);

        function filtrarTabla() {
            const busqueda = document.getElementById('busqueda').value.toLowerCase();
            const supervisor = document.getElementById('filtroSupervisor').value.toLowerCase();
            const ciudad = document.getElementById('filtroCiudad').value.toLowerCase();
            const estadoFiltro = document.getElementById('filtroEstado').value;
            const filas = document.querySelectorAll('.tecnico-row');

            let totalFiltrado = 0;
            let completadosFiltrado = 0;
            let procesoFiltrado = 0;
            let pendientesFiltrado = 0;

            filas.forEach(fila => {
                const nombre = fila.dataset.nombre.toLowerCase();
                const cedula = fila.dataset.cedula.toLowerCase();
                const sup = fila.dataset.supervisor.toLowerCase();
                const ciu = fila.dataset.ciudad.toLowerCase();
                const estado = fila.dataset.estado;

                const coincideBusqueda = nombre.includes(busqueda) || cedula.includes(busqueda);
                const coincideSupervisor = !supervisor || sup.includes(supervisor);
                const coincideCiudad = !ciudad || ciu.includes(ciudad);
                const coincideEstado = !estadoFiltro || estado === estadoFiltro;

                const visible = coincideBusqueda && coincideSupervisor && coincideCiudad && coincideEstado;
                fila.style.display = visible ? '' : 'none';

                if (visible) {
                    totalFiltrado++;
                    if (estado === 'COMPLETADO') completadosFiltrado++;
                    else if (estado === 'EN PROCESO') procesoFiltrado++;
                    else if (estado === 'PENDIENTE') pendientesFiltrado++;
                }
            });

            // Actualizar estad√≠sticas
            document.getElementById('stat-total').textContent = totalFiltrado;
            document.getElementById('stat-completados').textContent = completadosFiltrado;
            document.getElementById('stat-proceso').textContent = procesoFiltrado;
            document.getElementById('stat-pendientes').textContent = pendientesFiltrado;
            
            const presentesFiltrado = completadosFiltrado + procesoFiltrado;
            document.getElementById('stat-presentes').textContent = presentesFiltrado;
            document.getElementById('stat-total-barra').textContent = totalFiltrado;
            
            const porcentaje = totalFiltrado > 0 ? Math.round((presentesFiltrado / totalFiltrado) * 100) : 0;
            document.getElementById('porcentaje-badge').textContent = porcentaje + '%';
            document.getElementById('barra-progreso').style.width = porcentaje + '%';
            document.getElementById('barra-progreso').setAttribute('aria-valuenow', porcentaje);
        }

        // Marcar entrada
        document.querySelectorAll('.btn-entrada').forEach(btn => {
            btn.addEventListener('click', async function() {
                const cedula = this.dataset.cedula;
                
                if (!confirm('¬øConfirmar entrada?')) return;

                try {
                    const response = await fetch('/entrada', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({cedula})
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('‚úì ' + data.message);
                        location.reload();
                    } else {
                        alert('‚úó ' + data.message);
                    }
                } catch (error) {
                    alert('Error de conexi√≥n: ' + error);
                }
            });
        });

        // Marcar salida
        document.querySelectorAll('.btn-salida').forEach(btn => {
            btn.addEventListener('click', async function() {
                const cedula = this.dataset.cedula;
                
                if (!confirm('¬øConfirmar salida?')) return;

                try {
                    const response = await fetch('/salida', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({cedula})
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('‚úì ' + data.message);
                        location.reload();
                    } else {
                        alert('‚úó ' + data.message);
                    }
                } catch (error) {
                    alert('Error de conexi√≥n: ' + error);
                }
            });
        });

        // Editar hora
        document.querySelectorAll('.btn-editar-hora').forEach(btn => {
            btn.addEventListener('click', function() {
                cedulaEditar = this.dataset.cedula;
                tipoEditar = this.dataset.tipo;
                const horaActual = this.dataset.hora;
                
                document.getElementById('inputNuevaHora').value = horaActual;
                modalEditarHora.show();
            });
        });

        document.getElementById('btnGuardarHora').addEventListener('click', async function() {
            const nuevaHora = document.getElementById('inputNuevaHora').value + ':00';
            
            if (!nuevaHora) {
                alert('Debe ingresar una hora v√°lida');
                return;
            }

            try {
                const response = await fetch('/editar', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        cedula: cedulaEditar,
                        tipo: tipoEditar,
                        hora: nuevaHora
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('‚úì ' + data.message);
                    modalEditarHora.hide();
                    location.reload();
                } else {
                    alert('‚úó ' + data.message);
                }
            } catch (error) {
                alert('Error de conexi√≥n: ' + error);
            }
        });

        // Eliminar registro
        document.querySelectorAll('.btn-eliminar').forEach(btn => {
            btn.addEventListener('click', async function() {
                const cedula = this.dataset.cedula;
                
                if (!confirm('¬øEst√° seguro de eliminar este registro? Esta acci√≥n no se puede deshacer.')) return;

                try {
                    const response = await fetch('/eliminar', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({cedula})
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('‚úì ' + data.message);
                        location.reload();
                    } else {
                        alert('‚úó ' + data.message);
                    }
                } catch (error) {
                    alert('Error de conexi√≥n: ' + error);
                }
            });
        });
    </script>
</body>
</html>