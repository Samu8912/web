<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia - Conectar TV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f2f0f8;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0;
            margin: 0;
        }

        .container-fluid {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .header-section h1 {
            color: #667eea;
            font-weight: bold;
        }

        .nav-tabs {
            border-bottom: 2px solid #667eea;
        }

        .nav-tabs .nav-link {
            color: #667eea;
            font-weight: 600;
            border: none;
            padding: 1rem 2rem;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border-radius: 10px 10px 0 0;
        }

        .stats-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            padding: 1.5rem;
            text-align: center;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stats-card p {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0;
        }

        .card-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .card-asiste { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .card-novedad { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .card-no-asiste { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .card-tarde { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }

        .table-responsive {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table thead th {
            border-bottom: 2px solid #667eea;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .badge {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 8px;
        }

        .estado-ASISTE { background-color: #c6f6d5 !important; color: #22543d !important; }
        .estado-NO_ASISTE { background-color: #fed7d7 !important; color: #c53030 !important; }
        .estado-NOVEDAD { background-color: #feebc8 !important; color: #c05621 !important; }
        .estado-LLEGA_TARDE { background-color: #bee3f8 !important; color: #2c5282 !important; }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .modal-content {
            border-radius: 15px;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .container-fluid { padding: 1rem; }
            .stats-card h3 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header-section">
            <h1 class="text-center mb-3">üìã Sistema de Asistencia y Gesti√≥n de Personal</h1>
            <h5 class="text-center text-muted">Conectar TV</h5>
            <p class="text-center text-muted mb-0" id="fecha-actual"></p>
            <div class="text-center mt-3">
                <button id="btnAutorizar" class="btn btn-primary btn-lg">üîê Autorizar Google Sheets</button>
                <button id="btnCerrarSesion" class="btn btn-secondary" style="display:none;">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="asistencia-tab" data-bs-toggle="tab" data-bs-target="#asistencia" type="button">
                    ‚úÖ Asistencia Diaria
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="plan-tab" data-bs-toggle="tab" data-bs-target="#plan-padrino" type="button">
                    üë• Base de Personal
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="valores-tab" data-bs-toggle="tab" data-bs-target="#valores" type="button">
                    ‚öôÔ∏è Valores Permitidos
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabsContent">
            <!-- ASISTENCIA -->
            <div class="tab-pane fade show active" id="asistencia" role="tabpanel">
                <!-- Selector de Fecha -->
                <div class="section-card">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">üìÖ Seleccionar Fecha:</label>
                            <input type="date" id="fechaAsistencia" class="form-control">
                        </div>
                        <div class="col-md-8 text-end">
                            <button id="btnCargarAsistencia" class="btn btn-primary">üîÑ Cargar Asistencia</button>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="row mb-4">
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-total">
                            <div class="stats-icon">üë•</div>
                            <h3 id="stat-total-asist">0</h3>
                            <p>Total Personal</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-asiste">
                            <div class="stats-icon">‚úÖ</div>
                            <h3 id="stat-asiste">0</h3>
                            <p>Asiste</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-tarde">
                            <div class="stats-icon">‚è∞</div>
                            <h3 id="stat-tarde">0</h3>
                            <p>Llega Tarde</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-novedad">
                            <div class="stats-icon">‚ö†Ô∏è</div>
                            <h3 id="stat-novedad">0</h3>
                            <p>Novedad</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-no-asiste">
                            <div class="stats-icon">‚ùå</div>
                            <h3 id="stat-no-asiste">0</h3>
                            <p>No Asiste</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                            <div class="stats-icon">üìä</div>
                            <h3 id="stat-ausentismo">0%</h3>
                            <p>Ausentismo</p>
                        </div>
                    </div>
                </div>

                <!-- Filtros Asistencia -->
                <div class="section-card">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <input type="text" id="busquedaAsist" class="form-control" placeholder="üîç Buscar...">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <select id="filtroSupervisorAsist" class="form-select">
                                <option value="">üìä Todos los supervisores</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <select id="filtroCiudadAsist" class="form-select">
                                <option value="">üèôÔ∏è Todas las ciudades</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <select id="filtroCargoAsist" class="form-select">
                                <option value="">üëî Todos los cargos</option>
                                <option value="TECNICO">T√©cnico</option>
                                <option value="AUXILIAR">Auxiliar</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <select id="filtroEstadoAsist" class="form-select">
                                <option value="">üìå Todos los estados</option>
                                <option value="ASISTE">‚úÖ Asiste</option>
                                <option value="LLEGA_TARDE">‚è∞ Llega Tarde</option>
                                <option value="NOVEDAD">‚ö†Ô∏è Novedad</option>
                                <option value="NO_ASISTE">‚ùå No Asiste</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabla Asistencia -->
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaAsistencia">
                        <thead class="table-dark">
                            <tr>
                                <th>C√©dula</th>
                                <th>Nombre</th>
                                <th>Cargo</th>
                                <th>Ciudad</th>
                                <th>Supervisor</th>
                                <th>Estado</th>
                                <th>Hora Entrada</th>
                                <th>Tipo Novedad</th>
                                <th>Observaciones</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-asistencia">
                            <!-- Din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PLAN PADRINO -->
            <div class="tab-pane fade" id="plan-padrino" role="tabpanel">
                <!-- Bot√≥n Agregar -->
                <div class="section-card">
                    <button id="btnAgregarPersonal" class="btn btn-success btn-lg">‚ûï Agregar Personal</button>
                </div>

                <!-- Filtros Plan Padrino -->
                <div class="section-card">
                    <div class="row g-3">
                        <div class="col-lg-4 col-md-6">
                            <input type="text" id="busquedaPlan" class="form-control" placeholder="üîç Buscar por nombre o c√©dula...">
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <select id="filtroSupervisorPlan" class="form-select">
                                <option value="">üìä Todos los supervisores</option>
                            </select>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <select id="filtroCiudadPlan" class="form-select">
                                <option value="">üèôÔ∏è Todas las ciudades</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabla Plan Padrino -->
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaPlanPadrino">
                        <thead class="table-dark">
                            <tr>
                                <th>C√©dula</th>
                                <th>Nombre</th>
                                <th>Cargo</th>
                                <th>Ciudad</th>
                                <th>Supervisor</th>
                                <th>L√≠der</th>
                                <th>Analista</th>
                                <th>Auxiliares</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-plan">
                            <!-- Din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VALORES PERMITIDOS -->
            <div class="tab-pane fade" id="valores" role="tabpanel">
                <div class="section-card">
                    <h4 class="mb-4">‚öôÔ∏è Gesti√≥n de Valores Permitidos</h4>
                    <p class="text-muted">Configure los valores permitidos para cada campo. Estos valores se usar√°n en los formularios de Base de Personal.</p>
                </div>

                <!-- CARPETA -->
                <div class="section-card">
                    <h5 class="mb-3">üìÅ Carpetas</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevaCarpeta" placeholder="Nueva carpeta...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('CARPETA')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-carpetas" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- CIUDAD -->
                <div class="section-card">
                    <h5 class="mb-3">üèôÔ∏è Ciudades</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevaCiudad" placeholder="Nueva ciudad...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('CIUDAD')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-ciudades" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- SUPERVISOR -->
                <div class="section-card">
                    <h5 class="mb-3">üëî Supervisores</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevoSupervisor" placeholder="Nuevo supervisor...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('SUPERVISOR')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-supervisores" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- LIDER -->
                <div class="section-card">
                    <h5 class="mb-3">‚≠ê L√≠deres</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevoLider" placeholder="Nuevo l√≠der...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('LIDER')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-lideres" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- ANALISTA -->
                <div class="section-card">
                    <h5 class="mb-3">üìä Analistas</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevoAnalista" placeholder="Nuevo analista...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('ANALISTA')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-analistas" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Asistencia -->
    <div class="modal fade" id="modalRegistrarAsistencia" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Asistencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="asist-cedula">
                    <input type="hidden" id="asist-nombre">
                    <input type="hidden" id="asist-cargo">
                    <input type="hidden" id="asist-ciudad">
                    <input type="hidden" id="asist-supervisor">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Estado de Asistencia:</label>
                        <select id="asist-estado" class="form-select">
                            <option value="ASISTE">‚úÖ Asiste</option>
                            <option value="LLEGA_TARDE">‚è∞ Llega Tarde</option>
                            <option value="NOVEDAD">‚ö†Ô∏è Novedad</option>
                            <option value="NO_ASISTE">‚ùå No Asiste</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="div-hora-entrada" style="display:none;">
                        <label class="form-label fw-bold">Hora de Entrada:</label>
                        <input type="time" class="form-control" id="asist-hora">
                    </div>
                    
                    <div class="mb-3" id="div-tipo-novedad" style="display:none;">
                        <label class="form-label fw-bold">Tipo de Novedad:</label>
                        <select id="asist-tipo-novedad" class="form-select">
                            <option value="">Seleccionar...</option>
                            <option value="INCAPACIDAD / EPS">INCAPACIDAD / EPS</option>
                            <option value="AUSENCIA INJUSTIFICADA">AUSENCIA INJUSTIFICADA</option>
                            <option value="VACACIONES">VACACIONES</option>
                            <option value="PERMISO">PERMISO</option>
                            <option value="RETIRO / RENUNCIA">RETIRO / RENUNCIA</option>
                            <option value="SUSPENSI√ìN">SUSPENSI√ìN</option>
                            <option value="MOTO / VEH√çCULO">MOTO / VEH√çCULO</option>
                            <option value="CALAMIDAD / LUTO">CALAMIDAD / LUTO</option>
                            <option value="APOYO OPERATIVO">APOYO OPERATIVO</option>
                            <option value="OTROS">OTROS</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="div-dias-novedad" style="display:none;">
                        <label class="form-label fw-bold">D√≠as de Novedad:</label>
                        <input type="number" class="form-control" id="asist-dias-novedad" min="1" placeholder="N√∫mero de d√≠as">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Observaciones (Opcional):</label>
                        <textarea id="asist-observaciones" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarAsistencia">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar/Editar Personal -->
    <div class="modal fade" id="modalPersonal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalPersonal">Agregar Personal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="personal-modo">
                    <input type="hidden" id="personal-cedula-original">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">C√©dula *</label>
                            <input type="text" class="form-control" id="personal-cedula" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Nombre Completo *</label>
                            <input type="text" class="form-control" id="personal-nombre" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Cargo *</label>
                            <select class="form-select" id="personal-cargo" required>
                                <option value="TECNICO">T√©cnico</option>
                                <option value="AUXILIAR">Auxiliar</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Carpeta</label>
                            <select class="form-select" id="personal-carpeta"></select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Ciudad *</label>
                            <select class="form-select" id="personal-ciudad" required></select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Supervisor *</label>
                            <select class="form-select" id="personal-supervisor" required></select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">L√≠der</label>
                            <select class="form-select" id="personal-lider"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Analista</label>
                            <select class="form-select" id="personal-analista"></select>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="fw-bold">Auxiliares Asignados</h6>
                    <div id="auxiliares-container">
                        <div class="auxiliar-item mb-2">
                            <div class="row">
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" id="btnAgregarAuxiliar">‚ûï Agregar Auxiliar</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarPersonal">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuraci√≥n
        const CONFIG = {
            API_KEY: 'AIzaSyDB0drcnkGdqKyJhsfStbcAQ7qiBqdhc4U',
            CLIENT_ID: '965807081420-jc0gsh5umaief7s262qi22ooa64bvv14.apps.googleusercontent.com',
            SPREADSHEET_ID: '1XJg_kvifS_e3UTztx7uhaNukCsnehuIF0ZhEC7lSFhw',
            HOJA_PLAN: 'BASE',
            HOJA_ASISTENCIA: 'ASISTENCIA',
            HOJA_VALORES: 'VALORES',
            DISCOVERY_DOCS: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets'
        };

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let datosGlobales = { planPadrino: [], asistencia: [], valores: {} };

        // Inicializar fecha actual
        const hoy = new Date();
        document.getElementById('fecha-actual').textContent = hoy.toLocaleDateString('es-CO');
        document.getElementById('fechaAsistencia').valueAsDate = hoy;

        // Modales
        const modalRegistrarAsistencia = new bootstrap.Modal(document.getElementById('modalRegistrarAsistencia'));
        const modalPersonal = new bootstrap.Modal(document.getElementById('modalPersonal'));

        // Inicializar GAPI
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: CONFIG.DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('btnAutorizar').style.display = 'inline-block';
            }
        }

        // Autorizaci√≥n
        document.getElementById('btnAutorizar').addEventListener('click', handleAuthClick);
        document.getElementById('btnCerrarSesion').addEventListener('click', handleSignoutClick);

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                document.getElementById('btnAutorizar').style.display = 'none';
                document.getElementById('btnCerrarSesion').style.display = 'inline-block';
                await cargarPlanPadrino();
                await cargarValores();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('btnAutorizar').style.display = 'inline-block';
                document.getElementById('btnCerrarSesion').style.display = 'none';
            }
        }

        // Cargar Plan Padrino
        async function cargarPlanPadrino() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                const rows = response.result.values || [];
                if (rows.length === 0) {
                    alert('La hoja BASE est√° vac√≠a. Por favor, aseg√∫rate de que tenga los datos');
                    datosGlobales.planPadrino = [];
                } else {
                    datosGlobales.planPadrino = procesarPlanPadrino(rows);
                }
                
                renderizarPlanPadrino(datosGlobales.planPadrino);
                cargarFiltrosPlan();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar BASE: ' + error.message);
            }
        }

        function procesarPlanPadrino(rows) {
            if (rows.length <= 1) return [];
            
            const personal = [];
            const tecnicosMap = new Map();

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cedula = row[0]?.toString().trim();
                if (!cedula) continue;

                if (!tecnicosMap.has(cedula)) {
                    tecnicosMap.set(cedula, {
                        CEDULA: cedula,
                        NOMBRE: row[1] || '',
                        CARGO: row[2] || 'TECNICO',
                        CARPETA: row[3] || '',
                        CIUDAD: row[4] || '',
                        SUPERVISOR: row[5] || '',
                        LIDER: row[8] || '',
                        ANALISTA: row[9] || '',
                        ESTADO: row[17] || 'ACTIVO',
                        auxiliares: []
                    });
                }

                const cedulaAux = row[6]?.toString().trim();
                const nombreAux = row[7]?.toString().trim();
                
                if (cedulaAux && nombreAux) {
                    tecnicosMap.get(cedula).auxiliares.push({
                        cedula: cedulaAux,
                        nombre: nombreAux
                    });
                }
            }

            return Array.from(tecnicosMap.values());
        }

        function renderizarPlanPadrino(personal) {
            const tbody = document.getElementById('tbody-plan');
            tbody.innerHTML = '';

            personal.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'personal-row';
                tr.dataset.cedula = p.CEDULA;
                tr.dataset.nombre = p.NOMBRE.toLowerCase();
                tr.dataset.supervisor = p.SUPERVISOR.toLowerCase();
                tr.dataset.ciudad = p.CIUDAD.toLowerCase();

                const auxText = p.auxiliares.length > 0 
                    ? p.auxiliares.map(a => `${a.nombre} (${a.cedula})`).join('<br>')
                    : '<em class="text-muted">Sin auxiliares</em>';

                tr.innerHTML = `
                    <td>${p.CEDULA}</td>
                    <td>${p.NOMBRE}</td>
                    <td><span class="badge bg-info">${p.CARGO}</span></td>
                    <td>${p.CIUDAD}</td>
                    <td>${p.SUPERVISOR}</td>
                    <td>${p.LIDER}</td>
                    <td>${p.ANALISTA}</td>
                    <td>${auxText}</td>
                    <td>
                        <span class="badge ${p.ESTADO === 'ACTIVO' ? 'bg-success' : 'bg-secondary'}">${p.ESTADO}</span><br>
                        <button class="btn btn-sm btn-primary btn-editar-personal mt-1" data-cedula="${p.CEDULA}">‚úèÔ∏è Editar</button>
                        <button class="btn btn-sm btn-danger btn-eliminar-personal mt-1" data-cedula="${p.CEDULA}">üóëÔ∏è Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.btn-editar-personal').forEach(btn => {
                btn.addEventListener('click', editarPersonal);
            });
            document.querySelectorAll('.btn-eliminar-personal').forEach(btn => {
                btn.addEventListener('click', eliminarPersonal);
            });
        }

        // Cargar Asistencia
        document.getElementById('btnCargarAsistencia').addEventListener('click', cargarAsistencia);

        async function cargarAsistencia() {
            try {
                const fecha = document.getElementById('fechaAsistencia').value;
                if (!fecha) {
                    alert('Seleccione una fecha');
                    return;
                }

                // Cargar plan padrino si no est√° cargado
                if (datosGlobales.planPadrino.length === 0) {
                    await cargarPlanPadrino();
                }

                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_ASISTENCIA}!A:J`,
                });

                const rows = response.result.values || [];
                if (rows.length === 0) {
                    // Crear encabezados
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_ASISTENCIA}!A1:J1`,
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['FECHA', 'CEDULA', 'NOMBRE', 'CARGO', 'SUPERVISOR', 'CIUDAD', 'ESTADO', 'HORA_ENTRADA', 'TIPO_NOVEDAD', 'OBSERVACIONES']]
                        }
                    });
                }

                const asistenciaHoy = procesarAsistencia(rows, fecha);
                renderizarAsistencia(asistenciaHoy);
                cargarFiltrosAsistencia();

            } catch (error) {
                console.error('Error:', error);
                alert('Error al cargar asistencia: ' + error.message);
            }
        }

        function procesarAsistencia(rows, fecha) {
            const asistenciaMap = new Map();
            
            // Cargar registros existentes del d√≠a
            if (rows.length > 1) {
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const fechaReg = row[0];
                    const cedula = row[1]?.toString().trim();
                    
                    if (fechaReg === fecha && cedula) {
                        asistenciaMap.set(cedula, {
                            CEDULA: cedula,
                            NOMBRE: row[2] || '',
                            CARGO: row[3] || '',
                            SUPERVISOR: row[4] || '',
                            CIUDAD: row[5] || '',
                            ESTADO: row[6] || 'NO_ASISTE',
                            HORA_ENTRADA: row[7] || '',
                            TIPO_NOVEDAD: row[8] || '',
                            OBSERVACIONES: row[9] || ''
                        });
                    }
                }
            }

            // Agregar personal del plan padrino que no tiene registro
            const personal = [];
            datosGlobales.planPadrino.forEach(p => {
                if (asistenciaMap.has(p.CEDULA)) {
                    personal.push(asistenciaMap.get(p.CEDULA));
                } else {
                    personal.push({
                        CEDULA: p.CEDULA,
                        NOMBRE: p.NOMBRE,
                        CARGO: p.CARGO,
                        SUPERVISOR: p.SUPERVISOR,
                        CIUDAD: p.CIUDAD,
                        ESTADO: 'NO_ASISTE',
                        HORA_ENTRADA: '',
                        TIPO_NOVEDAD: '',
                        OBSERVACIONES: ''
                    });
                }

                // Agregar auxiliares
                p.auxiliares.forEach(aux => {
                    if (asistenciaMap.has(aux.cedula)) {
                        personal.push(asistenciaMap.get(aux.cedula));
                    } else {
                        personal.push({
                            CEDULA: aux.cedula,
                            NOMBRE: aux.nombre,
                            CARGO: 'AUXILIAR',
                            SUPERVISOR: p.SUPERVISOR,
                            CIUDAD: p.CIUDAD,
                            ESTADO: 'NO_ASISTE',
                            HORA_ENTRADA: '',
                            TIPO_NOVEDAD: '',
                            OBSERVACIONES: ''
                        });
                    }
                });
            });

            return personal;
        }

        function renderizarAsistencia(personal) {
            const tbody = document.getElementById('tbody-asistencia');
            tbody.innerHTML = '';

            // Calcular estad√≠sticas
            const total = personal.length;
            const asiste = personal.filter(p => p.ESTADO === 'ASISTE').length;
            const tarde = personal.filter(p => p.ESTADO === 'LLEGA_TARDE').length;
            const novedad = personal.filter(p => p.ESTADO === 'NOVEDAD').length;
            const noAsiste = personal.filter(p => p.ESTADO === 'NO_ASISTE').length;
            const ausentismo = total > 0 ? Math.round(((novedad + noAsiste) / total) * 100) : 0;

            document.getElementById('stat-total-asist').textContent = total;
            document.getElementById('stat-asiste').textContent = asiste;
            document.getElementById('stat-tarde').textContent = tarde;
            document.getElementById('stat-novedad').textContent = novedad;
            document.getElementById('stat-no-asiste').textContent = noAsiste;
            document.getElementById('stat-ausentismo').textContent = ausentismo + '%';

            personal.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'asistencia-row';
                tr.dataset.cedula = p.CEDULA;
                tr.dataset.nombre = p.NOMBRE.toLowerCase();
                tr.dataset.supervisor = p.SUPERVISOR.toLowerCase();
                tr.dataset.ciudad = p.CIUDAD.toLowerCase();
                tr.dataset.cargo = p.CARGO;
                tr.dataset.estado = p.ESTADO;

                tr.innerHTML = `
                    <td>${p.CEDULA}</td>
                    <td>${p.NOMBRE}</td>
                    <td><span class="badge bg-secondary">${p.CARGO}</span></td>
                    <td>${p.CIUDAD}</td>
                    <td>${p.SUPERVISOR}</td>
                    <td><span class="badge estado-${p.ESTADO}">${p.ESTADO.replace('_', ' ')}</span></td>
                    <td>${p.HORA_ENTRADA}</td>
                    <td>${p.TIPO_NOVEDAD}</td>
                    <td>${p.OBSERVACIONES}</td>
                    <td>
                        <button class="btn btn-sm btn-primary btn-registrar-asist" 
                                data-cedula="${p.CEDULA}"
                                data-nombre="${p.NOMBRE}"
                                data-cargo="${p.CARGO}"
                                data-ciudad="${p.CIUDAD}"
                                data-supervisor="${p.SUPERVISOR}">
                            üìù Registrar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.btn-registrar-asist').forEach(btn => {
                btn.addEventListener('click', abrirModalRegistrar);
            });
        }

        // Modal Registrar Asistencia
        function abrirModalRegistrar() {
            document.getElementById('asist-cedula').value = this.dataset.cedula;
            document.getElementById('asist-nombre').value = this.dataset.nombre;
            document.getElementById('asist-cargo').value = this.dataset.cargo;
            document.getElementById('asist-ciudad').value = this.dataset.ciudad;
            document.getElementById('asist-supervisor').value = this.dataset.supervisor;
            
            document.getElementById('asist-estado').value = 'ASISTE';
            document.getElementById('asist-hora').value = '';
            document.getElementById('asist-tipo-novedad').value = '';
            document.getElementById('asist-observaciones').value = '';
            
            document.getElementById('div-hora-entrada').style.display = 'none';
            document.getElementById('div-tipo-novedad').style.display = 'none';
            
            modalRegistrarAsistencia.show();
        }

        document.getElementById('asist-estado').addEventListener('change', function() {
            const estado = this.value;
            document.getElementById('div-hora-entrada').style.display = estado === 'LLEGA_TARDE' ? 'block' : 'none';
            document.getElementById('div-tipo-novedad').style.display = estado === 'NOVEDAD' ? 'block' : 'none';
            document.getElementById('div-dias-novedad').style.display = 'none';
        });

        document.getElementById('asist-tipo-novedad').addEventListener('change', function() {
            const tipoNovedad = this.value;
            const novedadesConDias = ['INCAPACIDAD / EPS', 'VACACIONES', 'CALAMIDAD / LUTO'];
            document.getElementById('div-dias-novedad').style.display = novedadesConDias.includes(tipoNovedad) ? 'block' : 'none';
        });

        document.getElementById('btnGuardarAsistencia').addEventListener('click', async function() {
            const fecha = document.getElementById('fechaAsistencia').value;
            const cedula = document.getElementById('asist-cedula').value;
            const nombre = document.getElementById('asist-nombre').value;
            const cargo = document.getElementById('asist-cargo').value;
            const ciudad = document.getElementById('asist-ciudad').value;
            const supervisor = document.getElementById('asist-supervisor').value;
            const estado = document.getElementById('asist-estado').value;
            const hora = document.getElementById('asist-hora').value || '';
            const tipoNovedad = document.getElementById('asist-tipo-novedad').value || '';
            const diasNovedad = document.getElementById('asist-dias-novedad').value || '';
            const observaciones = document.getElementById('asist-observaciones').value || '';

            if (estado === 'LLEGA_TARDE' && !hora) {
                alert('Debe especificar la hora de entrada');
                return;
            }

            if (estado === 'NOVEDAD' && !tipoNovedad) {
                alert('Debe especificar el tipo de novedad');
                return;
            }

            const novedadesConDias = ['INCAPACIDAD / EPS', 'VACACIONES', 'CALAMIDAD / LUTO'];
            if (estado === 'NOVEDAD' && novedadesConDias.includes(tipoNovedad) && !diasNovedad) {
                alert('Debe especificar el n√∫mero de d√≠as');
                return;
            }

            try {
                // Actualizar estado en BASE si es novedad
                if (estado === 'NOVEDAD') {
                    await actualizarEstadoEnBase(cedula, tipoNovedad);
                }

                // Buscar si ya existe registro
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_ASISTENCIA}!A:K`,
                });

                const rows = response.result.values || [];
                let filaExistente = -1;

                for (let i = 1; i < rows.length; i++) {
                    if (rows[i][0] === fecha && rows[i][1] === cedula) {
                        filaExistente = i + 1;
                        break;
                    }
                }

                const observacionesCompletas = diasNovedad ? `${observaciones} [${diasNovedad} d√≠as]`.trim() : observaciones;
                const valores = [[fecha, cedula, nombre, cargo, supervisor, ciudad, estado, hora, tipoNovedad, observacionesCompletas]];

                if (filaExistente > 0) {
                    // Actualizar
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_ASISTENCIA}!A${filaExistente}:J${filaExistente}`,
                        valueInputOption: 'RAW',
                        resource: { values: valores }
                    });
                } else {
                    // Agregar
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_ASISTENCIA}!A:J`,
                        valueInputOption: 'RAW',
                        resource: { values: valores }
                    });
                }

                alert('‚úÖ Asistencia registrada correctamente');
                modalRegistrarAsistencia.hide();
                await cargarAsistencia();

            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar: ' + error.message);
            }
        });

        async function actualizarEstadoEnBase(cedula, tipoNovedad) {
            try {
                const mapeoEstados = {
                    'INCAPACIDAD / EPS': 'INCAPACITADO',
                    'VACACIONES': 'VACACIONES',
                    'RETIRO / RENUNCIA': 'RETIRADO',
                    'SUSPENSI√ìN': 'SUSPENDIDO',
                    'CALAMIDAD / LUTO': 'CALAMIDAD'
                };

                const nuevoEstado = mapeoEstados[tipoNovedad] || 'ACTIVO';

                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                const rows = response.result.values || [];
                
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i][0] === cedula) {
                        // Asegurar que el array tenga 18 elementos
                        while (rows[i].length < 18) {
                            rows[i].push('');
                        }
                        rows[i][17] = nuevoEstado; // Columna R (√≠ndice 17)
                    }
                }

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A1:R${rows.length}`,
                    valueInputOption: 'RAW',
                    resource: { values: rows }
                });

            } catch (error) {
                console.error('Error actualizando estado:', error);
            }
        }

        // Modal Personal
        document.getElementById('btnAgregarPersonal').addEventListener('click', function() {
            cargarDropdownsPersonal();
            
            document.getElementById('tituloModalPersonal').textContent = 'Agregar Personal';
            document.getElementById('personal-modo').value = 'agregar';
            document.getElementById('personal-cedula-original').value = '';
            
            document.getElementById('personal-cedula').value = '';
            document.getElementById('personal-nombre').value = '';
            document.getElementById('personal-cargo').value = 'TECNICO';
            document.getElementById('personal-carpeta').value = '';
            document.getElementById('personal-ciudad').value = '';
            document.getElementById('personal-supervisor').value = '';
            document.getElementById('personal-lider').value = '';
            document.getElementById('personal-analista').value = '';
            
            document.getElementById('auxiliares-container').innerHTML = `
                <div class="auxiliar-item mb-2">
                    <div class="row">
                        <div class="col-md-5">
                            <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            
            modalPersonal.show();
        });

        function editarPersonal() {
            const cedula = this.dataset.cedula;
            const persona = datosGlobales.planPadrino.find(p => p.CEDULA === cedula);
            
            if (!persona) return;

            cargarDropdownsPersonal();

            document.getElementById('tituloModalPersonal').textContent = 'Editar Personal';
            document.getElementById('personal-modo').value = 'editar';
            document.getElementById('personal-cedula-original').value = cedula;
            
            document.getElementById('personal-cedula').value = persona.CEDULA;
            document.getElementById('personal-nombre').value = persona.NOMBRE;
            document.getElementById('personal-cargo').value = persona.CARGO;
            document.getElementById('personal-carpeta').value = persona.CARPETA || '';
            document.getElementById('personal-ciudad').value = persona.CIUDAD;
            document.getElementById('personal-supervisor').value = persona.SUPERVISOR;
            document.getElementById('personal-lider').value = persona.LIDER;
            document.getElementById('personal-analista').value = persona.ANALISTA;
            
            const container = document.getElementById('auxiliares-container');
            container.innerHTML = '';
            
            if (persona.auxiliares.length > 0) {
                persona.auxiliares.forEach(aux => {
                    container.innerHTML += `
                        <div class="auxiliar-item mb-2">
                            <div class="row">
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar" value="${aux.cedula}">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar" value="${aux.nombre}">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = `
                    <div class="auxiliar-item mb-2">
                        <div class="row">
                            <div class="col-md-5">
                                <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                            </div>
                            <div class="col-md-5">
                                <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modalPersonal.show();
        }

        document.getElementById('btnAgregarAuxiliar').addEventListener('click', function() {
            const container = document.getElementById('auxiliares-container');
            const div = document.createElement('div');
            div.className = 'auxiliar-item mb-2';
            div.innerHTML = `
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });

        function eliminarAuxiliar(btn) {
            btn.closest('.auxiliar-item').remove();
        }

        document.getElementById('btnGuardarPersonal').addEventListener('click', async function() {
            const modo = document.getElementById('personal-modo').value;
            const cedulaOriginal = document.getElementById('personal-cedula-original').value;
            
            const cedula = document.getElementById('personal-cedula').value.trim();
            const nombre = document.getElementById('personal-nombre').value.trim();
            const cargo = document.getElementById('personal-cargo').value;
            const carpeta = document.getElementById('personal-carpeta').value.trim();
            const ciudad = document.getElementById('personal-ciudad').value.trim();
            const supervisor = document.getElementById('personal-supervisor').value.trim();
            const lider = document.getElementById('personal-lider').value.trim();
            const analista = document.getElementById('personal-analista').value.trim();

            if (!cedula || !nombre || !ciudad || !supervisor) {
                alert('Complete los campos obligatorios');
                return;
            }

            try {
                // Recopilar auxiliares
                const auxiliares = [];
                document.querySelectorAll('.auxiliar-item').forEach(item => {
                    const cedAux = item.querySelector('.auxiliar-cedula').value.trim();
                    const nomAux = item.querySelector('.auxiliar-nombre').value.trim();
                    if (cedAux && nomAux) {
                        auxiliares.push({ cedula: cedAux, nombre: nomAux });
                    }
                });

                // Obtener datos actuales
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                let rows = response.result.values || [];

                // Eliminar registros antiguos si es edici√≥n
                if (modo === 'editar') {
                    rows = rows.filter((row, idx) => idx === 0 || row[0] !== cedulaOriginal);
                }

                // Agregar nuevos registros
                if (auxiliares.length === 0) {
                    const newRow = [cedula, nombre, cargo, carpeta, ciudad, supervisor, '', '', lider, analista];
                    // Rellenar hasta columna R (√≠ndice 17)
                    while (newRow.length < 18) {
                        newRow.push('');
                    }
                    newRow[17] = 'ACTIVO'; // Columna R
                    rows.push(newRow);
                } else {
                    auxiliares.forEach(aux => {
                        const newRow = [cedula, nombre, cargo, carpeta, ciudad, supervisor, aux.cedula, aux.nombre, lider, analista];
                        // Rellenar hasta columna R (√≠ndice 17)
                        while (newRow.length < 18) {
                            newRow.push('');
                        }
                        newRow[17] = 'ACTIVO'; // Columna R
                        rows.push(newRow);
                    });
                }

                // Actualizar hoja completa
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A1:R${rows.length}`,
                    valueInputOption: 'RAW',
                    resource: { values: rows }
                });

                alert('‚úÖ Personal guardado correctamente');
                modalPersonal.hide();
                await cargarPlanPadrino();

            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar: ' + error.message);
            }
        });

        async function eliminarPersonal() {
            const cedula = this.dataset.cedula;
            
            if (!confirm('¬øEst√° seguro de eliminar este personal y todos sus auxiliares asociados?')) return;

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                let rows = response.result.values || [];
                
                // Filtrar eliminando todas las filas con esa c√©dula (incluyendo encabezados se mantienen)
                const filasEliminadas = rows.filter((row, idx) => {
                    if (idx === 0) return true; // Mantener encabezados
                    return row[0]?.toString().trim() !== cedula;
                });

                console.log('Filas antes:', rows.length);
                console.log('Filas despu√©s:', filasEliminadas.length);

                if (rows.length === filasEliminadas.length) {
                    alert('No se encontr√≥ el registro a eliminar');
                    return;
                }

                // Limpiar toda la hoja primero
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A2:R`,
                });

                // Actualizar con los datos filtrados
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A1:R${filasEliminadas.length}`,
                    valueInputOption: 'RAW',
                    resource: { values: filasEliminadas }
                });

                alert('‚úÖ Personal eliminado correctamente');
                await cargarPlanPadrino();

            } catch (error) {
                console.error('Error completo:', error);
                alert('Error al eliminar: ' + error.message);
            }
        }

        // Filtros Plan Padrino
        document.getElementById('busquedaPlan').addEventListener('input', filtrarPlan);
        document.getElementById('filtroSupervisorPlan').addEventListener('change', filtrarPlan);
        document.getElementById('filtroCiudadPlan').addEventListener('change', filtrarPlan);

        function filtrarPlan() {
            const busqueda = document.getElementById('busquedaPlan').value.toLowerCase();
            const supervisor = document.getElementById('filtroSupervisorPlan').value.toLowerCase();
            const ciudad = document.getElementById('filtroCiudadPlan').value.toLowerCase();

            document.querySelectorAll('.personal-row').forEach(fila => {
                const nombre = fila.dataset.nombre;
                const cedula = fila.dataset.cedula.toLowerCase();
                const sup = fila.dataset.supervisor;
                const ciu = fila.dataset.ciudad;

                const visible = (nombre.includes(busqueda) || cedula.includes(busqueda)) &&
                                (!supervisor || sup.includes(supervisor)) &&
                                (!ciudad || ciu.includes(ciudad));

                fila.style.display = visible ? '' : 'none';
            });
        }

        function cargarFiltrosPlan() {
            const supervisores = [...new Set(datosGlobales.planPadrino.map(p => p.SUPERVISOR))].filter(s => s).sort();
            const ciudades = [...new Set(datosGlobales.planPadrino.map(p => p.CIUDAD))].filter(c => c).sort();

            const selectSup = document.getElementById('filtroSupervisorPlan');
            const selectCiu = document.getElementById('filtroCiudadPlan');

            selectSup.innerHTML = '<option value="">üìä Todos los supervisores</option>';
            supervisores.forEach(s => selectSup.innerHTML += `<option value="${s}">${s}</option>`);

            selectCiu.innerHTML = '<option value="">üèôÔ∏è Todas las ciudades</option>';
            ciudades.forEach(c => selectCiu.innerHTML += `<option value="${c}">${c}</option>`);
        }

        // ========== VALORES PERMITIDOS ==========
        async function cargarValores() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_VALORES}!A:E`,
                });

                const rows = response.result.values || [];
                
                if (rows.length === 0) {
                    // Crear encabezados si no existen
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_VALORES}!A1:E1`,
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['CARPETA', 'CIUDAD', 'SUPERVISOR', 'LIDER', 'ANALISTA']]
                        }
                    });
                    datosGlobales.valores = {CARPETA: [], CIUDAD: [], SUPERVISOR: [], LIDER: [], ANALISTA: []};
                } else {
                    datosGlobales.valores = {
                        CARPETA: [],
                        CIUDAD: [],
                        SUPERVISOR: [],
                        LIDER: [],
                        ANALISTA: []
                    };

                    // Procesar cada columna
                    const maxRows = Math.max(...rows.map(r => r.length));
                    const numRows = rows.length;

                    for (let col = 0; col < 5; col++) {
                        const columnas = ['CARPETA', 'CIUDAD', 'SUPERVISOR', 'LIDER', 'ANALISTA'];
                        for (let row = 1; row < numRows; row++) {
                            const valor = rows[row][col]?.toString().trim();
                            if (valor) {
                                datosGlobales.valores[columnas[col]].push(valor);
                            }
                        }
                    }
                }

                renderizarValores();
            } catch (error) {
                console.error('Error cargando valores:', error);
                alert('Error al cargar valores permitidos: ' + error.message);
            }
        }

        function renderizarValores() {
            // Carpetas
            const listaCarpetas = document.getElementById('lista-carpetas');
            listaCarpetas.innerHTML = '';
            datosGlobales.valores.CARPETA.forEach(v => {
                listaCarpetas.innerHTML += `<span class="valor-badge">${v}<button onclick="eliminarValor('CARPETA', '${v}')">√ó</button></span>`;
            });

            // Ciudades
            const listaCiudades = document.getElementById('lista-ciudades');
            listaCiudades.innerHTML = '';
            datosGlobales.valores.CIUDAD.forEach(v => {
                listaCiudades.innerHTML += `<span class="valor-badge">${v}<button onclick="eliminarValor('CIUDAD', '${v}')">√ó</button></span>`;
            });

            // Supervisores
            const listaSupervisores = document.getElementById('lista-supervisores');
            listaSupervisores.innerHTML = '';
            datosGlobales.valores.SUPERVISOR.forEach(v => {
                listaSupervisores.innerHTML += `<span class="valor-badge">${v}<button onclick="eliminarValor('SUPERVISOR', '${v}')">√ó</button></span>`;
            });

            // L√≠deres
            const listaLideres = document.getElementById('lista-lideres');
            listaLideres.innerHTML = '';
            datosGlobales.valores.LIDER.forEach(v => {
                listaLideres.innerHTML += `<span class="valor-badge">${v}<button onclick="eliminarValor('LIDER', '${v}')">√ó</button></span>`;
            });

            // Analistas
            const listaAnalistas = document.getElementById('lista-analistas');
            listaAnalistas.innerHTML = '';
            datosGlobales.valores.ANALISTA.forEach(v => {
                listaAnalistas.innerHTML += `<span class="valor-badge">${v}<button onclick="eliminarValor('ANALISTA', '${v}')">√ó</button></span>`;
            });
        }

        async function agregarValor(tipo) {
            const inputs = {
                'CARPETA': 'nuevaCarpeta',
                'CIUDAD': 'nuevaCiudad',
                'SUPERVISOR': 'nuevoSupervisor',
                'LIDER': 'nuevoLider',
                'ANALISTA': 'nuevoAnalista'
            };

            const input = document.getElementById(inputs[tipo]);
            const valor = input.value.trim();

            if (!valor) {
                alert('Ingrese un valor');
                return;
            }

            if (datosGlobales.valores[tipo].includes(valor)) {
                alert('Este valor ya existe');
                return;
            }

            try {
                datosGlobales.valores[tipo].push(valor);
                await guardarValores();
                input.value = '';
                renderizarValores();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al agregar valor: ' + error.message);
            }
        }

        async function eliminarValor(tipo, valor) {
            if (!confirm(`¬øEliminar "${valor}"?`)) return;

            try {
                datosGlobales.valores[tipo] = datosGlobales.valores[tipo].filter(v => v !== valor);
                await guardarValores();
                renderizarValores();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar valor: ' + error.message);
            }
        }

        async function guardarValores() {
            try {
                // Preparar datos en columnas
                const maxLength = Math.max(
                    datosGlobales.valores.CARPETA.length,
                    datosGlobales.valores.CIUDAD.length,
                    datosGlobales.valores.SUPERVISOR.length,
                    datosGlobales.valores.LIDER.length,
                    datosGlobales.valores.ANALISTA.length
                );

                const rows = [['CARPETA', 'CIUDAD', 'SUPERVISOR', 'LIDER', 'ANALISTA']];

                for (let i = 0; i < maxLength; i++) {
                    rows.push([
                        datosGlobales.valores.CARPETA[i] || '',
                        datosGlobales.valores.CIUDAD[i] || '',
                        datosGlobales.valores.SUPERVISOR[i] || '',
                        datosGlobales.valores.LIDER[i] || '',
                        datosGlobales.valores.ANALISTA[i] || ''
                    ]);
                }

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_VALORES}!A1:E${rows.length}`,
                    valueInputOption: 'RAW',
                    resource: { values: rows }
                });
            } catch (error) {
                throw error;
            }
        }

        // Cargar dropdowns en modal de personal
        function cargarDropdownsPersonal() {
            // Carpeta
            const selectCarpeta = document.getElementById('personal-carpeta');
            selectCarpeta.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.CARPETA.forEach(v => {
                selectCarpeta.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // Ciudad
            const selectCiudad = document.getElementById('personal-ciudad');
            selectCiudad.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.CIUDAD.forEach(v => {
                selectCiudad.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // Supervisor
            const selectSupervisor = document.getElementById('personal-supervisor');
            selectSupervisor.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.SUPERVISOR.forEach(v => {
                selectSupervisor.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // L√≠der
            const selectLider = document.getElementById('personal-lider');
            selectLider.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.LIDER.forEach(v => {
                selectLider.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // Analista
            const selectAnalista = document.getElementById('personal-analista');
            selectAnalista.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.ANALISTA.forEach(v => {
                selectAnalista.innerHTML += `<option value="${v}">${v}</option>`;
            });
        }

        // Filtros Asistencia
        document.getElementById('busquedaAsist').addEventListener('input', filtrarAsistencia);
        document.getElementById('filtroSupervisorAsist').addEventListener('change', filtrarAsistencia);
        document.getElementById('filtroCiudadAsist').addEventListener('change', filtrarAsistencia);
        document.getElementById('filtroCargoAsist').addEventListener('change', filtrarAsistencia);
        document.getElementById('filtroEstadoAsist').addEventListener('change', filtrarAsistencia);

        function filtrarAsistencia() {
            const busqueda = document.getElementById('busquedaAsist').value.toLowerCase();
            const supervisor = document.getElementById('filtroSupervisorAsist').value.toLowerCase();
            const ciudad = document.getElementById('filtroCiudadAsist').value.toLowerCase();
            const cargo = document.getElementById('filtroCargoAsist').value;
            const estado = document.getElementById('filtroEstadoAsist').value;

            let totalFiltrado = 0;
            let asisteFiltrado = 0;
            let tardeFiltrado = 0;
            let novedadFiltrado = 0;
            let noAsisteFiltrado = 0;

            document.querySelectorAll('.asistencia-row').forEach(fila => {
                const nombre = fila.dataset.nombre;
                const cedula = fila.dataset.cedula.toLowerCase();
                const sup = fila.dataset.supervisor;
                const ciu = fila.dataset.ciudad;
                const car = fila.dataset.cargo;
                const est = fila.dataset.estado;

                const visible = (nombre.includes(busqueda) || cedula.includes(busqueda)) &&
                                (!supervisor || sup.includes(supervisor)) &&
                                (!ciudad || ciu.includes(ciudad)) &&
                                (!cargo || car === cargo) &&
                                (!estado || est === estado);

                fila.style.display = visible ? '' : 'none';

                if (visible) {
                    totalFiltrado++;
                    if (est === 'ASISTE') asisteFiltrado++;
                    else if (est === 'LLEGA_TARDE') tardeFiltrado++;
                    else if (est === 'NOVEDAD') novedadFiltrado++;
                    else if (est === 'NO_ASISTE') noAsisteFiltrado++;
                }
            });

            document.getElementById('stat-total-asist').textContent = totalFiltrado;
            document.getElementById('stat-asiste').textContent = asisteFiltrado;
            document.getElementById('stat-tarde').textContent = tardeFiltrado;
            document.getElementById('stat-novedad').textContent = novedadFiltrado;
            document.getElementById('stat-no-asiste').textContent = noAsisteFiltrado;

            const ausentismo = totalFiltrado > 0 ? Math.round(((novedadFiltrado + noAsisteFiltrado) / totalFiltrado) * 100) : 0;
            document.getElementById('stat-ausentismo').textContent = ausentismo + '%';
        }

        function cargarFiltrosAsistencia() {
            const supervisores = [...new Set(datosGlobales.planPadrino.map(p => p.SUPERVISOR))].filter(s => s).sort();
            const ciudades = [...new Set(datosGlobales.planPadrino.map(p => p.CIUDAD))].filter(c => c).sort();

            const selectSup = document.getElementById('filtroSupervisorAsist');
            const selectCiu = document.getElementById('filtroCiudadAsist');

            selectSup.innerHTML = '<option value="">üìä Todos los supervisores</option>';
            supervisores.forEach(s => selectSup.innerHTML += `<option value="${s}">${s}</option>`);

            selectCiu.innerHTML = '<option value="">üèôÔ∏è Todas las ciudades</option>';
            ciudades.forEach(c => selectCiu.innerHTML += `<option value="${c}">${c}</option>`);
        }
    </script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</body>
</html>
