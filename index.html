<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia - Conectar TV</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0f4c81; /* Azul corporativo serio */
            --secondary-color: #2563eb; /* Azul brillante para acentos */
            --bg-body: #f3f4f6;
            --surface-color: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
        }

        .container-fluid {
            max-width: 1600px;
            padding: 2rem;
        }

        /* Tarjetas y Secciones */
        .header-section, .section-card, .table-responsive, .modal-content {
            background: var(--surface-color);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            transition: transform 0.2s ease;
        }

        .header-section {
            padding: 2.5rem;
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-left: 5px solid var(--primary-color);
        }

        /* T√≠tulos */
        h1, h3, h4, h5 {
            font-weight: 700;
            letter-spacing: -0.025em;
            color: #111827;
        }

        .header-section h1 {
            color: var(--primary-color);
        }

        /* Tabs Modernos */
        .nav-tabs {
            border-bottom: none;
            gap: 10px;
            padding-bottom: 1rem;
        }

        .nav-tabs .nav-link {
            border: none;
            background: white;
            color: var(--text-muted);
            font-weight: 600;
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover {
            color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white !important;
            box-shadow: var(--shadow-md);
        }

        /* Stats Cards - Redise√±adas */
        .stats-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stats-card h3 {
            font-size: 2.2rem;
            margin: 0.5rem 0;
            color: #111827;
        }

        .stats-card p {
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        /* Indicadores de color sutiles en lugar de fondos completos */
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
        }

        .card-total::before { background: var(--primary-color); }
        .card-asiste::before { background: var(--success); }
        .card-tarde::before { background: var(--info); }
        .card-novedad::before { background: var(--warning); }
        .card-no-asiste::before { background: var(--danger); }
        
        /* Iconos de stats m√°s grandes y sutiles */
        .stats-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }

        /* Tablas */
        .table-responsive {
            padding: 0; /* Reset padding para que el borde coincida */
            overflow: hidden; /* Para respetar border-radius */
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: #f8fafc;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            font-size: 0.9rem;
            border-bottom: 1px solid #f3f4f6;
            color: #4b5563;
        }

        .table-hover tbody tr:hover {
            background-color: #f9fafb;
        }

        /* Badges */
        .badge {
            padding: 0.5em 0.8em;
            font-weight: 600;
            border-radius: 6px;
            letter-spacing: 0.025em;
        }
        
        .estado-ASISTE { background-color: #d1fae5 !important; color: #065f46 !important; }
        .estado-NO_ASISTE { background-color: #fee2e2 !important; color: #991b1b !important; }
        .estado-NOVEDAD { background-color: #fef3c7 !important; color: #92400e !important; }
        .estado-LLEGA_TARDE { background-color: #dbeafe !important; color: #1e40af !important; }

        /* Formularios e Inputs */
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.2s;
            background-color: #f9fafb;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            background-color: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Botones */
        .btn {
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
        }
        
        .btn-primary:hover {
            background-color: #0c3b66;
            transform: translateY(-1px);
        }

        .btn-success {
            background-color: var(--success);
            border: none;
        }

        /* Utilidades */
        .valor-badge {
            display: inline-flex;
            align-items: center;
            background: #f3f4f6;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.9rem;
            border: 1px solid #e5e7eb;
        }
        
        .valor-badge button {
            background: none;
            border: none;
            color: #9ca3af;
            margin-left: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            line-height: 1;
        }
        
        .valor-badge button:hover { color: var(--danger); }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        @media (max-width: 768px) {
            .container-fluid { padding: 1rem; }
            .header-section { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header-section d-flex flex-column flex-md-row justify-content-between align-items-center" id="header-principal" style="display:none;">
            <div class="mb-3 mb-md-0">
                <h1 class="mb-1">üìã Sistema de Asistencia</h1>
                <p class="text-muted mb-0">Conectar TV | Gesti√≥n de Personal</p>
            </div>
            
            <div class="text-center text-md-end">
                <div class="mb-2">
                    <span class="badge bg-light text-dark border p-2" id="usuario-rol" style="font-size: 0.9rem;">Cargando...</span>
                    <span class="badge bg-light text-secondary border p-2 ms-2" id="fecha-actual"></span>
                </div>
                <div>
                    <button id="btnAutorizar" class="btn btn-primary btn-sm">üîê Autorizar Google</button>
                    <button id="btnCerrarSesion" class="btn btn-outline-secondary btn-sm" style="display:none;">Desvincular Google</button>
                    <button id="btnCerrarSesionUsuario" class="btn btn-outline-danger btn-sm" style="display:none;">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>

<!-- Login -->
<div class="header-section" id="login-section">
    <h1 class="text-center mb-4">üîê Iniciar Sesi√≥n</h1>
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="mb-3">
                <label class="form-label fw-bold">Usuario:</label>
                <select class="form-select" id="login-usuario">
                    <option value="">Seleccionar...</option>
                    <option value="GestionLider">Gesti√≥n L√≠der</option>
                    <option value="GestionAsistencia">Gesti√≥n Asistencia</option>
                </select>
            </div>
            <div class="mb-3" id="password-container">
                <label class="form-label fw-bold">Contrase√±a:</label>
                <input type="password" class="form-control" id="login-password" placeholder="Ingrese contrase√±a">
            </div>
            <button class="btn btn-primary w-100 btn-lg" id="btnLogin">Continuar</button>
            <div class="alert alert-danger mt-3" id="login-error" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- Selecci√≥n de Supervisor -->
<div class="header-section" id="selector-supervisor" style="display:none;">
    <h1 class="text-center mb-4">üëî Seleccionar Supervisor</h1>
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="mb-3">
                <label class="form-label fw-bold">Seleccione su perfil:</label>
                <select class="form-select" id="select-supervisor" size="10">
                    <!-- Se llenar√° din√°micamente -->
                </select>
            </div>
            <button class="btn btn-primary w-100 btn-lg" id="btnSeleccionarSupervisor">Ingresar</button>
            <button class="btn btn-secondary w-100 mt-2" id="btnVolverLogin">Volver</button>
        </div>
    </div>
</div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist" style="display:none;">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="asistencia-tab" data-bs-toggle="tab" data-bs-target="#asistencia" type="button">
                    ‚úÖ Asistencia Diaria
                </button>
            </li>
            <li class="nav-item" role="presentation" id="tab-plan">
                <button class="nav-link" id="plan-tab" data-bs-toggle="tab" data-bs-target="#plan-padrino" type="button">
                    üë• Base de Personal
                </button>
            </li>
            <li class="nav-item" role="presentation" id="tab-valores">
                <button class="nav-link" id="valores-tab" data-bs-toggle="tab" data-bs-target="#valores" type="button">
                    ‚öôÔ∏è Valores Permitidos
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabsContent" style="display:none;">
            <!-- ASISTENCIA -->
            <div class="tab-pane fade show active" id="asistencia" role="tabpanel">
                <!-- Selector de Fecha -->
                <div class="section-card">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">üìÖ Seleccionar Fecha:</label>
                            <input type="date" id="fechaAsistencia" class="form-control">
                        </div>
                        <div class="col-md-8 text-end" id="controles-analista">
                            <button id="btnExportarAsistencia" class="btn btn-success">üì• Exportar a Excel</button>
                        </div>
                        <div class="col-md-8 text-end" id="controles-supervisor" style="display:none;">
                        <button class="btn btn-success me-2" id="btnAgregarPersonalTemporal">
                            ‚ûï Agregar Personal Temporal
                        </button>
                        <button class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#columnas-selector">
                            üëÅÔ∏è Mostrar/Ocultar Columnas
                        </button>
                        <button id="btnExportarAsistencia2" class="btn btn-success">üì• Exportar</button>
                    </div>
                    </div>
                    
                    <!-- Selector de columnas para supervisor -->
                    <div class="collapse mt-3" id="columnas-selector">
                        <div class="card card-body">
                            <h6 class="fw-bold mb-3">Seleccionar columnas visibles:</h6>
                            <div class="row">
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-cedula" data-col="0">
                                        <label class="form-check-label" for="col-cedula">C√©dula</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-nombre" data-col="1" checked disabled>
                                        <label class="form-check-label" for="col-nombre">Nombre *</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-cargo" data-col="2">
                                        <label class="form-check-label" for="col-cargo">Cargo</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-ciudad" data-col="3">
                                        <label class="form-check-label" for="col-ciudad">Ciudad</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-supervisor" data-col="4">
                                        <label class="form-check-label" for="col-supervisor">Supervisor</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-estado" data-col="5" checked>
                                        <label class="form-check-label" for="col-estado">Estado</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-hora" data-col="6">
                                        <label class="form-check-label" for="col-hora">Hora Entrada</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-tipo-novedad" data-col="7">
                                        <label class="form-check-label" for="col-tipo-novedad">Tipo Novedad</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-observaciones" data-col="8">
                                        <label class="form-check-label" for="col-observaciones">Observaciones</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
    <div class="form-check">
        <input class="form-check-input columna-toggle" type="checkbox" id="col-supervisor-respaldo" data-col="9">
        <label class="form-check-label" for="col-supervisor-respaldo">Supervisor Respaldo</label>
    </div>
</div>
                            </div>
                            <small class="text-muted mt-2">* Columnas obligatorias que no se pueden ocultar</small>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="row mb-4 g-3">
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="stats-card card-total h-100">
                            <div class="stats-icon text-primary">üë•</div>
                            <h3 id="stat-total-asist">0</h3>
                            <p>Total Personal</p>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="stats-card card-asiste h-100">
                            <div class="stats-icon text-success">‚úÖ</div>
                            <h3 id="stat-asiste">0</h3>
                            <p>Asiste</p>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="stats-card card-tarde h-100">
                            <div class="stats-icon text-info">‚è∞</div>
                            <h3 id="stat-tarde">0</h3>
                            <p>Llega Tarde</p>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="stats-card card-novedad h-100">
                            <div class="stats-icon text-warning">‚ö†Ô∏è</div>
                            <h3 id="stat-novedad">0</h3>
                            <p>Novedad</p>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="stats-card card-no-asiste h-100">
                            <div class="stats-icon text-danger">‚ùå</div>
                            <h3 id="stat-no-asiste">0</h3>
                            <p>No Asiste</p>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6">
                        <div class="stats-card h-100" style="border-top: 4px solid #6b7280;">
                            <div class="stats-icon text-secondary">üìä</div>
                            <h3 id="stat-ausentismo">0%</h3>
                            <p>Ausentismo</p>
                        </div>
                    </div>
                </div>

                <!-- Filtros Asistencia -->
                <div class="section-card">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <input type="text" id="busquedaAsist" class="form-control" placeholder="üîç Buscar...">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <input type="text" id="filtroSupervisorAsist" class="form-control" list="lista-supervisores-asist" placeholder="üìä Supervisor...">
                            <datalist id="lista-supervisores-asist"></datalist>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <input type="text" id="filtroCiudadAsist" class="form-control" list="lista-ciudades-asist" placeholder="üèôÔ∏è Ciudad...">
                            <datalist id="lista-ciudades-asist"></datalist>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <select id="filtroCargoAsist" class="form-select">
                                <option value="">üëî Todos los cargos</option>
                                <option value="TECNICO">T√©cnico</option>
                                <option value="AUXILIAR">Auxiliar</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <select id="filtroEstadoAsist" class="form-select">
                                <option value="">üìå Todos los estados</option>
                                <option value="ASISTE">‚úÖ Asiste</option>
                                <option value="LLEGA_TARDE">‚è∞ Llega Tarde</option>
                                <option value="NOVEDAD">‚ö†Ô∏è Novedad</option>
                                <option value="NO_ASISTE">‚ùå No Asiste</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabla Asistencia -->
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaAsistencia">
                        <thead class="table-dark">
                            <tr>
                                <th data-col="0">C√©dula</th>
                                <th data-col="1">Nombre</th>
                                <th data-col="2">Cargo</th>
                                <th data-col="3">Ciudad</th>
                                <th data-col="4">Supervisor</th>
                                <th data-col="5">Estado</th>
                                <th data-col="6">Hora Entrada</th>
                                <th data-col="7">Tipo Novedad</th>
                                <th data-col="8">Observaciones</th>
                                <th data-col="9">Supervisor Respaldo</th>
                                <th data-col="10">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-asistencia">
                            <!-- Din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PLAN PADRINO -->
            <div class="tab-pane fade" id="plan-padrino" role="tabpanel">
                <!-- Bot√≥n Agregar -->
                <div class="section-card" id="btn-agregar-personal-container">
                    <button id="btnAgregarPersonal" class="btn btn-success btn-lg">‚ûï Agregar Personal</button>
                    <button id="btnExportarPlan" class="btn btn-primary btn-lg">üì• Exportar a Excel</button>
                </div>

                <!-- Filtros Plan Padrino -->
                <div class="section-card">
                    <div class="row g-3">
                        <div class="col-lg-4 col-md-6">
                            <input type="text" id="busquedaPlan" class="form-control" placeholder="üîç Buscar por nombre o c√©dula...">
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <input type="text" id="filtroSupervisorPlan" class="form-control" list="lista-supervisores-plan" placeholder="üìä Supervisor...">
                            <datalist id="lista-supervisores-plan"></datalist>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <input type="text" id="filtroCiudadPlan" class="form-control" list="lista-ciudades-plan" placeholder="üèôÔ∏è Ciudad...">
                            <datalist id="lista-ciudades-plan"></datalist>
                        </div>
                    </div>
                </div>

                <!-- Tabla Plan Padrino -->
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaPlanPadrino">
                        <thead class="table-dark">
                            <tr>
                                <th>C√©dula</th>
                                <th>Nombre</th>
                                <th>Cargo</th>
                                <th>Ciudad</th>
                                <th>Supervisor</th>
                                <th>L√≠der</th>
                                <th>Analista</th>
                                <th>Auxiliares</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-plan">
                            <!-- Din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VALORES PERMITIDOS -->
            <div class="tab-pane fade" id="valores" role="tabpanel">
                <div class="section-card">
                    <h4 class="mb-4">‚öôÔ∏è Gesti√≥n de Valores Permitidos</h4>
                    <p class="text-muted">Configure los valores permitidos para cada campo. Estos valores se usar√°n en los formularios de Base de Personal.</p>
                </div>

                <!-- CARPETA -->
                <div class="section-card">
                    <h5 class="mb-3">üìÅ Carpetas</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevaCarpeta" placeholder="Nueva carpeta...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('CARPETA')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-carpetas" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- CIUDAD -->
                <div class="section-card">
                    <h5 class="mb-3">üèôÔ∏è Ciudades</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevaCiudad" placeholder="Nueva ciudad...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('CIUDAD')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-ciudades" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- SUPERVISOR -->
                <div class="section-card">
                    <h5 class="mb-3">üëî Supervisores</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevoSupervisor" placeholder="Nuevo supervisor...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('SUPERVISOR')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-supervisores" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- LIDER -->
                <div class="section-card">
                    <h5 class="mb-3">‚≠ê L√≠deres</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevoLider" placeholder="Nuevo l√≠der...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('LIDER')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-lideres" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- ANALISTA -->
                <div class="section-card">
                    <h5 class="mb-3">üìä Analistas</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevoAnalista" placeholder="Nuevo analista...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('ANALISTA')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-analistas" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Asistencia -->
    <div class="modal fade" id="modalRegistrarAsistencia" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Asistencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="asist-cedula">
                    <input type="hidden" id="asist-nombre">
                    <input type="hidden" id="asist-cargo">
                    <input type="hidden" id="asist-ciudad">
                    <input type="hidden" id="asist-supervisor">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Estado de Asistencia:</label>
                        <select id="asist-estado" class="form-select">
                            <option value="ASISTE">‚úÖ Asiste</option>
                            <option value="LLEGA_TARDE">‚è∞ Llega Tarde</option>
                            <option value="NOVEDAD">‚ö†Ô∏è Novedad</option>
                            <option value="NO_ASISTE">‚ùå No Asiste</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="div-hora-entrada" style="display:none;">
                        <label class="form-label fw-bold">Hora de Entrada:</label>
                        <input type="time" class="form-control" id="asist-hora">
                    </div>
                    
                    <div class="mb-3" id="div-tipo-novedad" style="display:none;">
                        <label class="form-label fw-bold">Tipo de Novedad:</label>
                        <select id="asist-tipo-novedad" class="form-select">
                            <option value="">Seleccionar...</option>
                            <option value="INCAPACIDAD / EPS">INCAPACIDAD / EPS</option>
                            <option value="AUSENCIA INJUSTIFICADA">AUSENCIA INJUSTIFICADA</option>
                            <option value="VACACIONES">VACACIONES</option>
                            <option value="PERMISO">PERMISO</option>
                            <option value="RETIRO / RENUNCIA">RETIRO / RENUNCIA</option>
                            <option value="SUSPENSI√ìN">SUSPENSI√ìN</option>
                            <option value="MOTO / VEH√çCULO">MOTO / VEH√çCULO</option>
                            <option value="CALAMIDAD / LUTO">CALAMIDAD / LUTO</option>
                            <option value="APOYO OPERATIVO">APOYO OPERATIVO</option>
                            <option value="OTROS">OTROS</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="div-dias-novedad" style="display:none;">
                        <label class="form-label fw-bold">D√≠as de Novedad:</label>
                        <input type="number" class="form-control" id="asist-dias-novedad" min="1" placeholder="N√∫mero de d√≠as">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Compa√±ero de Trabajo (Opcional):</label>
                        <p class="text-muted small">Especifica si trabaja con un auxiliar o t√©cnico adicional</p>
                        <input type="text" 
                            id="asist-companero" 
                            class="form-control" 
                            list="lista-companeros-asist"
                            placeholder="üîç Buscar compa√±ero...">
                        <datalist id="lista-companeros-asist"></datalist>
                        <small class="text-muted">Empieza a escribir para ver sugerencias</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Observaciones (Opcional):</label>
                        <textarea id="asist-observaciones" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarAsistencia">Guardar</button>
                </div>
            </div>
        </div>
    </div>
<!-- Modal Agregar Personal Temporal -->
<div class="modal fade" id="modalPersonalTemporal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ûï Agregar Personal Temporal a Mi Lista</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Agrega t√©cnicos/auxiliares de otros supervisores a tu lista de forma temporal para el d√≠a de hoy. 
                    Aparecer√°s como "Supervisor de Respaldo" en el reporte.
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Buscar Personal:</label>
                    <input type="text" class="form-control" id="buscar-personal-temp" placeholder="üîç Buscar por nombre o c√©dula...">
                </div>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Seleccionar</th>
                                <th>C√©dula</th>
                                <th>Nombre</th>
                                <th>Cargo</th>
                                <th>Supervisor Original</th>
                                <th>Ciudad</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-personal-temp">
                            <!-- Din√°mico -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-3">
                    <strong>Personal seleccionado:</strong>
                    <div id="lista-personal-seleccionado" class="mt-2">
                        <em class="text-muted">Ninguno seleccionado</em>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarPersonalTemporal">Agregar a Mi Lista</button>
            </div>
        </div>
    </div>
</div>
    <!-- Modal Agregar/Editar Personal -->
    <div class="modal fade" id="modalPersonal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalPersonal">Agregar Personal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="personal-modo">
                    <input type="hidden" id="personal-cedula-original">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">C√©dula *</label>
                            <input type="text" class="form-control" id="personal-cedula" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Nombre Completo *</label>
                            <input type="text" class="form-control" id="personal-nombre" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Cargo *</label>
                            <select class="form-select" id="personal-cargo" required>
                                <option value="TECNICO">T√©cnico</option>
                                <option value="AUXILIAR">Auxiliar</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Carpeta</label>
                            <select class="form-select" id="personal-carpeta"></select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Ciudad *</label>
                            <select class="form-select" id="personal-ciudad" required></select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Supervisor *</label>
                            <select class="form-select" id="personal-supervisor" required></select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">L√≠der</label>
                            <select class="form-select" id="personal-lider"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Analista</label>
                            <select class="form-select" id="personal-analista"></select>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="fw-bold">Auxiliares Asignados</h6>
                    <div id="auxiliares-container">
                        <div class="auxiliar-item mb-2">
                            <div class="row">
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" id="btnAgregarAuxiliar">‚ûï Agregar Auxiliar</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarPersonal">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Configuraci√≥n
        const CONFIG = {
            API_KEY: 'AIzaSyDB0drcnkGdqKyJhsfStbcAQ7qiBqdhc4U',
            CLIENT_ID: '965807081420-jc0gsh5umaief7s262qi22ooa64bvv14.apps.googleusercontent.com',
            SPREADSHEET_ID: '1XJg_kvifS_e3UTztx7uhaNukCsnehuIF0ZhEC7lSFhw',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbx83CW2uLt0lvgnLaQOVtvxLrcut5Z0WJmLA0LkPosjKd2I_XOu4a0h55Dc0xxNtZWg/exec',
            HOJA_PLAN: 'BASE',
            HOJA_ASISTENCIA: 'ASISTENCIA',
            HOJA_VALORES: 'VALORES',
            HOJA_ROTACION: 'ROTACION SUPERVISOR',
            DISCOVERY_DOCS: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets'
        };
        let personalTemporalHoy = []; // Lista de c√©dulas con respaldo temporal para hoy
        const modalPersonalTemporal = new bootstrap.Modal(document.getElementById('modalPersonalTemporal'));
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let datosGlobales = { planPadrino: [], asistencia: [], valores: {} };
        let usuarioActual = null;
        let intervaloActualizacion = null;
        let estadoFiltrosAsistencia = {
            busqueda: '',
            supervisor: '',
            ciudad: '',
            cargo: '',
            estado: ''
        };
        let estadoFiltrosPlan = {
            busqueda: '',
            supervisor: '',
            ciudad: ''
        };

        // Funci√≥n helper para llamar a Apps Script
        async function llamarAppsScript(action, data = {}) {
            try {
                const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action, ...data }),
                    redirect: 'follow'
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error llamando Apps Script:', error);
                throw error;
            }
        }

        // Funci√≥n para leer datos usando Apps Script (GET)
        async function leerDatosSheet(action) {
            try {
                const url = `${CONFIG.APPS_SCRIPT_URL}?action=${action}&_=${new Date().getTime()}`;
                const response = await fetch(url, {
                    method: 'GET',
                    redirect: 'follow',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    return result.data;
                } else {
                    throw new Error(result.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error leyendo datos:', error);
                console.error('Action:', action);
                console.error('URL:', CONFIG.APPS_SCRIPT_URL);
                throw error;
            }
        }
// ========== FUNCIONES PARA ROTACI√ìN TEMPORAL ==========
async function cargarRotacionesDia(fecha, supervisor) {
    try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SPREADSHEET_ID,
            range: `${CONFIG.HOJA_ROTACION}!A:E`,
        });

        const rows = response.result.values || [];
        const cedulas = [];
        
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (row[0] === fecha && row[1] === supervisor) {
                cedulas.push(row[2]); // C√©dula del personal
            }
        }
        
        return cedulas;
    } catch (error) {
        console.error('Error cargando rotaciones:', error);
        return [];
    }
}

async function guardarRotacion(fecha, supervisor, cedula, nombre, supervisorOriginal) {
    try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SPREADSHEET_ID,
            range: `${CONFIG.HOJA_ROTACION}!A:E`,
        });

        const rows = response.result.values || [];
        
        // Verificar si ya existe
        for (let i = 1; i < rows.length; i++) {
            if (rows[i][0] === fecha && rows[i][1] === supervisor && rows[i][2] === cedula) {
                console.log('Rotaci√≥n ya existe');
                return;
            }
        }
        
        // Agregar nuevo registro
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: CONFIG.SPREADSHEET_ID,
            range: `${CONFIG.HOJA_ROTACION}!A:E`,
            valueInputOption: 'RAW',
            insertDataOption: 'INSERT_ROWS',
            resource: {
                values: [[fecha, supervisor, cedula, nombre, supervisorOriginal]]
            }
        });
        
        console.log('Rotaci√≥n guardada exitosamente');
    } catch (error) {
        console.error('Error guardando rotaci√≥n:', error);
        throw error;
    }
}

async function eliminarRotacion(fecha, supervisor, cedula) {
    try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SPREADSHEET_ID,
            range: `${CONFIG.HOJA_ROTACION}!A:E`,
        });

        const rows = response.result.values || [];
        
        // Encontrar la fila a eliminar
        let filaAEliminar = -1;
        for (let i = 1; i < rows.length; i++) {
            if (rows[i][0] === fecha && rows[i][1] === supervisor && rows[i][2] === cedula) {
                filaAEliminar = i;
                break;
            }
        }
        
        if (filaAEliminar === -1) {
            console.log('Rotaci√≥n no encontrada');
            return;
        }
        
        // Obtener sheetId
        const metadataResponse = await gapi.client.sheets.spreadsheets.get({
            spreadsheetId: CONFIG.SPREADSHEET_ID
        });

        const sheets = metadataResponse.result.sheets;
        const rotacionSheet = sheets.find(s => s.properties.title === CONFIG.HOJA_ROTACION);
        
        if (!rotacionSheet) {
            throw new Error('No se encontr√≥ la hoja ROTACION SUPERVISOR');
        }

        const sheetId = rotacionSheet.properties.sheetId;
        
        // Eliminar fila
        await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: CONFIG.SPREADSHEET_ID,
            resource: {
                requests: [{
                    deleteDimension: {
                        range: {
                            sheetId: sheetId,
                            dimension: 'ROWS',
                            startIndex: filaAEliminar,
                            endIndex: filaAEliminar + 1
                        }
                    }
                }]
            }
        });
        
        console.log('Rotaci√≥n eliminada exitosamente');
    } catch (error) {
        console.error('Error eliminando rotaci√≥n:', error);
        throw error;
    }
}
       // Credenciales de usuarios
const USUARIOS = {
    analista: {
        usuario: 'GestionLider',
        password: '4658*',
        rol: 'ANALISTA',
        requierePassword: true
    },
    supervisor: {
        usuario: 'GestionAsistencia',
        password: '',
        rol: 'SUPERVISOR',
        requierePassword: false,
        requiereSeleccion: true
    }
};

        // Inicializar fecha actual
        const hoy = new Date();
        document.getElementById('fecha-actual').textContent = hoy.toLocaleDateString('es-CO');
        document.getElementById('fechaAsistencia').valueAsDate = hoy;

        // Modales
        const modalRegistrarAsistencia = new bootstrap.Modal(document.getElementById('modalRegistrarAsistencia'));
        const modalPersonal = new bootstrap.Modal(document.getElementById('modalPersonal'));

        // ========== GESTI√ìN DE SESI√ìN CON LOCALSTORAGE ==========
        function guardarSesion() {
            if (usuarioActual) {
                const sesion = {
                    usuario: usuarioActual,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('sesionUsuario', JSON.stringify(sesion));
            }

            const token = gapi.client.getToken();
            if (token) {
                localStorage.setItem('googleToken', JSON.stringify(token));
            }
        }

        function cargarSesionGuardada() {
            // Cargar sesi√≥n de usuario
            const sesionGuardada = localStorage.getItem('sesionUsuario');
            if (sesionGuardada) {
                const sesion = JSON.parse(sesionGuardada);
                const ahora = new Date().getTime();
                const unDia = 24 * 60 * 60 * 1000;

                // Si la sesi√≥n tiene menos de 1 d√≠a
                if (ahora - sesion.timestamp < unDia) {
                    usuarioActual = sesion.usuario;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('header-principal').style.display = 'block';
                    document.getElementById('mainTabs').style.display = 'flex';
                    document.getElementById('mainTabsContent').style.display = 'block';
                    document.getElementById('usuario-rol').textContent = `üë§ ${sesion.usuario.rol}`;
                    document.getElementById('btnCerrarSesionUsuario').style.display = 'inline-block';
                    configurarPermisos();
                } else {
                    // Sesi√≥n expirada
                    localStorage.removeItem('sesionUsuario');
                }
            }

            // Cargar token de Google
            const tokenGuardado = localStorage.getItem('googleToken');
            if (tokenGuardado && gapiInited) {
                try {
                    const tokenData = JSON.parse(tokenGuardado);
                    gapi.client.setToken(tokenData.token);
                    document.getElementById('btnAutorizar').style.display = 'none';
                    document.getElementById('btnCerrarSesion').style.display = 'inline-block';
                    
                    // Cargar datos si hay usuario
// Cargar datos si hay usuario
if (usuarioActual) {
    // Si es supervisor, necesita cargar primero para filtrar
    if (usuarioActual.rol === 'SUPERVISOR') {
        cargarPlanPadrino().then(async () => {
            cargarValores();
            
            // NUEVO: Cargar personal temporal del d√≠a actual
            const fechaHoy = document.getElementById('fechaAsistencia').value;
            if (fechaHoy && usuarioActual.supervisorAsignado) {
                personalTemporalHoy = await cargarRotacionesDia(fechaHoy, usuarioActual.supervisorAsignado);
                console.log('Personal temporal cargado desde sesi√≥n guardada:', personalTemporalHoy);
            }
            
            iniciarActualizacionAutomatica();
        });
    } else {
        cargarPlanPadrino();
        cargarValores();
        iniciarActualizacionAutomatica();
    }
}
                } catch (error) {
                    console.error('Error cargando token guardado:', error);
                    localStorage.removeItem('googleToken');
                }
            }
        }

        function cerrarSesionCompleta() {
            usuarioActual = null;
            localStorage.removeItem('sesionUsuario');
            localStorage.removeItem('googleToken');
            
            if (intervaloActualizacion) {
                clearInterval(intervaloActualizacion);
                intervaloActualizacion = null;
            }
            
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('header-principal').style.display = 'none';
            document.getElementById('mainTabs').style.display = 'none';
            document.getElementById('mainTabsContent').style.display = 'none';
            document.getElementById('btnCerrarSesionUsuario').style.display = 'none';
            
            handleSignoutClick();
        }

// Cambiar a select en lugar de input
document.getElementById('login-usuario').addEventListener('change', function() {
    const usuario = this.value;
    const passwordContainer = document.getElementById('password-container');
    
    if (usuario === 'GestionAsistencia') {
        passwordContainer.style.display = 'none';
    } else {
        passwordContainer.style.display = 'block';
    }
});

document.getElementById('btnLogin').addEventListener('click', async function() {
    const usuario = document.getElementById('login-usuario').value.trim();
    const password = document.getElementById('login-password').value.trim();
    
    const errorDiv = document.getElementById('login-error');
    errorDiv.style.display = 'none';

    if (!usuario) {
        errorDiv.textContent = 'Seleccione un usuario';
        errorDiv.style.display = 'block';
        return;
    }

    // Validar credenciales
    let usuarioValido = null;
    for (const key in USUARIOS) {
        if (USUARIOS[key].usuario === usuario) {
            if (USUARIOS[key].requierePassword) {
                if (USUARIOS[key].password === password) {
                    usuarioValido = USUARIOS[key];
                    break;
                }
            } else {
                usuarioValido = USUARIOS[key];
                break;
            }
        }
    }

    if (!usuarioValido) {
        errorDiv.textContent = 'Credenciales incorrectas';
        errorDiv.style.display = 'block';
        return;
    }

    // Si requiere selecci√≥n de supervisor, cargar datos primero
    if (usuarioValido.requiereSeleccion) {
        try {
            // Mostrar mensaje de carga
            this.disabled = true;
            this.textContent = 'Cargando...';
            
            // Cargar plan padrino para obtener supervisores
            await cargarPlanPadrinoParaLogin();
            
            // Ahora s√≠ mostrar selector
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('selector-supervisor').style.display = 'block';
            cargarSupervisores();
            
            // Restaurar bot√≥n
            this.disabled = false;
            this.textContent = 'Continuar';
            
        } catch (error) {
            console.error('Error cargando datos:', error);
            errorDiv.textContent = 'Error al cargar datos. Intente nuevamente.';
            errorDiv.style.display = 'block';
            this.disabled = false;
            this.textContent = 'Continuar';
        }
    } else {
        // Login directo para analista
        completarLogin(usuarioValido);
    }
});

// Nueva funci√≥n para cargar solo la base sin renderizar
async function cargarPlanPadrinoParaLogin() {
    try {
        const rows = await leerDatosSheet('leerBase');

        if (rows.length === 0) {
            console.warn('La hoja BASE est√° vac√≠a');
            datosGlobales.planPadrino = [];
        } else {
            datosGlobales.planPadrino = procesarPlanPadrino(rows);
        }
    } catch (error) {
        console.error('Error al cargar BASE:', error);
        throw error;
    }
}

// Bot√≥n para seleccionar supervisor
document.getElementById('btnSeleccionarSupervisor').addEventListener('click', function() {
    const supervisorSeleccionado = document.getElementById('select-supervisor').value;
    
    if (!supervisorSeleccionado) {
        alert('Seleccione un supervisor');
        return;
    }
    
    const usuarioSupervisor = {
        usuario: 'GestionAsistencia',
        password: '',
        rol: 'SUPERVISOR',
        supervisorAsignado: supervisorSeleccionado
    };
    
    completarLogin(usuarioSupervisor);
});

// Bot√≥n volver
document.getElementById('btnVolverLogin').addEventListener('click', function() {
    document.getElementById('selector-supervisor').style.display = 'none';
    document.getElementById('login-section').style.display = 'block';
    document.getElementById('login-usuario').value = '';
    document.getElementById('login-password').value = '';
});

// Funci√≥n para cargar lista de supervisores
function cargarSupervisores() {
    const select = document.getElementById('select-supervisor');
    select.innerHTML = '';
    
    // Verificar que haya datos
    if (!datosGlobales.planPadrino || datosGlobales.planPadrino.length === 0) {
        const option = document.createElement('option');
        option.textContent = 'No hay supervisores disponibles';
        option.disabled = true;
        select.appendChild(option);
        return;
    }
    
    // Obtener supervisores √∫nicos de la base de personal
    const supervisores = [...new Set(datosGlobales.planPadrino.map(p => p.SUPERVISOR))].filter(s => s).sort();
    
    if (supervisores.length === 0) {
        const option = document.createElement('option');
        option.textContent = 'No hay supervisores registrados';
        option.disabled = true;
        select.appendChild(option);
        return;
    }
    
    supervisores.forEach(sup => {
        const option = document.createElement('option');
        option.value = sup;
        option.textContent = sup;
        select.appendChild(option);
    });
}

async function completarLogin(usuario) {
    usuarioActual = usuario;
    document.getElementById('selector-supervisor').style.display = 'none';
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('header-principal').style.display = 'block';
    document.getElementById('mainTabs').style.display = 'flex';
    document.getElementById('mainTabsContent').style.display = 'block';
    
    if (usuario.supervisorAsignado) {
        document.getElementById('usuario-rol').textContent = `üë§ SUPERVISOR: ${usuario.supervisorAsignado}`;
    } else {
        document.getElementById('usuario-rol').textContent = `üë§ ${usuario.rol}`;
    }
    
    document.getElementById('btnCerrarSesionUsuario').style.display = 'inline-block';

    configurarPermisos();
    guardarSesion();
    
    // Cargar datos seg√∫n el rol
    if (usuario.rol === 'ANALISTA') {
        // Analista: cargar todo normalmente
        cargarPlanPadrino();
        cargarValores();
    } else if (usuario.rol === 'SUPERVISOR') {
        // Supervisor: los datos ya est√°n cargados, solo cargar valores
        cargarValores();
        
        // NUEVO: Cargar personal temporal del d√≠a actual
        const fechaHoy = document.getElementById('fechaAsistencia').value;
        if (fechaHoy && usuario.supervisorAsignado) {
            personalTemporalHoy = await cargarRotacionesDia(fechaHoy, usuario.supervisorAsignado);
            console.log('Personal temporal cargado al login:', personalTemporalHoy);
        }
        
        // Renderizar la base si no est√° renderizada
        if (datosGlobales.planPadrino.length > 0) {
            renderizarPlanPadrino(datosGlobales.planPadrino);
        }
    }
    
    // Limpiar campos
    document.getElementById('login-usuario').value = '';
    document.getElementById('login-password').value = '';
}

        // Permitir login con Enter
        document.getElementById('login-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnLogin').click();
            }
        });

        // Cerrar sesi√≥n de usuario
        document.getElementById('btnCerrarSesionUsuario').addEventListener('click', function() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                cerrarSesionCompleta();
            }
        });

        function configurarPermisos() {
            if (usuarioActual.rol === 'SUPERVISOR') {
                // Ocultar tabs que no puede usar
                document.getElementById('tab-plan').style.display = 'none';
                document.getElementById('tab-valores').style.display = 'none';
                
                // Mostrar controles de supervisor y ocultar de analista
                document.getElementById('controles-supervisor').style.display = 'block';
                document.getElementById('controles-analista').style.display = 'none';
                
                // Configurar columnas por defecto (solo Nombre, Cargo y Acciones)
                aplicarColumnasVisibles();
                
                // Asegurar que est√© en Asistencia
                document.getElementById('asistencia-tab').click();
            } else {
                // Mostrar todo para ANALISTA
                document.getElementById('tab-plan').style.display = 'block';
                document.getElementById('tab-valores').style.display = 'block';
                document.getElementById('controles-supervisor').style.display = 'none';
                document.getElementById('controles-analista').style.display = 'block';
                
                // Mostrar todas las columnas para analista
                document.querySelectorAll('#tablaAsistencia th, #tablaAsistencia td').forEach(el => {
                    el.style.display = '';
                });
            }
        }

        // Aplicar visibilidad de columnas seg√∫n checkboxes
        function aplicarColumnasVisibles() {
            const checkboxes = document.querySelectorAll('.columna-toggle');
            
            checkboxes.forEach(checkbox => {
                const colIndex = checkbox.dataset.col;
                const isVisible = checkbox.checked;
                
                // Aplicar a headers
                document.querySelectorAll(`#tablaAsistencia th[data-col="${colIndex}"]`).forEach(th => {
                    th.style.display = isVisible ? '' : 'none';
                });
                
                // Aplicar a celdas
                document.querySelectorAll(`#tablaAsistencia td[data-col="${colIndex}"]`).forEach(td => {
                    td.style.display = isVisible ? '' : 'none';
                });
            });
        }

        // Event listeners para checkboxes de columnas
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.columna-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', aplicarColumnasVisibles);
            });
        });

        // Inicializar GAPI
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: CONFIG.DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('btnAutorizar').style.display = 'inline-block';
                // Intentar cargar sesi√≥n guardada
                cargarSesionGuardada();
            }
        }

        // Autorizaci√≥n
        document.getElementById('btnAutorizar').addEventListener('click', handleAuthClick);
        document.getElementById('btnCerrarSesion').addEventListener('click', handleSignoutClick);

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                document.getElementById('btnAutorizar').style.display = 'none';
                document.getElementById('btnCerrarSesion').style.display = 'inline-block';
                
                // Guardar token con timestamp
                const tokenData = {
                    token: gapi.client.getToken(),
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('googleToken', JSON.stringify(tokenData));
                
                await cargarPlanPadrino();
                await cargarValores();
                
                // Iniciar actualizaci√≥n autom√°tica
                iniciarActualizacionAutomatica();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // Verificar y renovar token si es necesario
        async function verificarYRenovarToken() {
            const tokenGuardado = localStorage.getItem('googleToken');
            if (!tokenGuardado) return false;

            try {
                const tokenData = JSON.parse(tokenGuardado);
                const ahora = new Date().getTime();
                const unaHora = 60 * 60 * 1000;

                // Si el token tiene m√°s de 50 minutos, renovarlo
                if (ahora - tokenData.timestamp > (50 * 60 * 1000)) {
                    console.log('Token antiguo, renovando...');
                    return new Promise((resolve) => {
                        tokenClient.callback = async (resp) => {
                            if (resp.error !== undefined) {
                                resolve(false);
                                return;
                            }
                            const nuevoTokenData = {
                                token: gapi.client.getToken(),
                                timestamp: new Date().getTime()
                            };
                            localStorage.setItem('googleToken', JSON.stringify(nuevoTokenData));
                            resolve(true);
                        };
                        tokenClient.requestAccessToken({prompt: ''});
                    });
                }
                return true;
            } catch (error) {
                console.error('Error verificando token:', error);
                return false;
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('googleToken');
                document.getElementById('btnAutorizar').style.display = 'inline-block';
                document.getElementById('btnCerrarSesion').style.display = 'none';
            }
            
            if (intervaloActualizacion) {
                clearInterval(intervaloActualizacion);
                intervaloActualizacion = null;
            }
        }

        // ========== ACTUALIZACI√ìN AUTOM√ÅTICA EN TIEMPO REAL ==========
        function iniciarActualizacionAutomatica() {
            // Actualizar cada 2 segundos
            if (intervaloActualizacion) {
                clearInterval(intervaloActualizacion);
            }
            
            intervaloActualizacion = setInterval(async () => {
                try {
                    // Solo actualizar si hay token v√°lido o estamos usando Apps Script
                    const tabActiva = document.querySelector('.tab-pane.active');
                    
                    if (tabActiva && tabActiva.id === 'asistencia') {
                        // Si est√° en asistencia
                        const fecha = document.getElementById('fechaAsistencia').value;
                        if (fecha) {
                            await cargarAsistencia(true);
                        }
                    } else if (tabActiva && tabActiva.id === 'plan-padrino') {
                        // Si est√° en plan padrino
                        await cargarPlanPadrino(true);
                    }
                } catch (error) {
                    console.error('Error en actualizaci√≥n autom√°tica:', error);
                }
            }, 2000); // 2 segundos
        }

        // Cargar Plan Padrino
        async function cargarPlanPadrino(silencioso = false) {
            try {
                const rows = await leerDatosSheet('leerBase');

                if (rows.length === 0) {
                    console.warn('La hoja BASE est√° vac√≠a');
                    datosGlobales.planPadrino = [];
                } else {
                    datosGlobales.planPadrino = procesarPlanPadrino(rows);
                }
                
                renderizarPlanPadrino(datosGlobales.planPadrino);
                
                // Siempre cargar las opciones de filtros
                cargarFiltrosPlan();
                
                // Si es silencioso, restaurar valores guardados
                if (silencioso) {
                    restaurarFiltrosPlan();
                }
            } catch (error) {
                console.error('Error al cargar BASE:', error);
                // No mostrar alert en actualizaciones autom√°ticas
                if (!intervaloActualizacion || datosGlobales.planPadrino.length === 0) {
                    alert('Error al cargar BASE: ' + error.message);
                }
            }
        }

        function procesarPlanPadrino(rows) {
    if (rows.length <= 1) return [];
    
    const personal = [];
    const tecnicosMap = new Map();

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cedula = row[0]?.toString().trim();
        if (!cedula) continue;

        if (!tecnicosMap.has(cedula)) {
            tecnicosMap.set(cedula, {
                CEDULA: cedula,
                NOMBRE: row[1] || '',
                CARGO: row[2] || 'TECNICO',
                CARPETA: row[3] || '',
                CIUDAD: row[4] || '',
                SUPERVISOR: row[5] || '',
                LIDER: row[8] || '',
                ANALISTA: row[9] || '',
                ESTADO: row[17] || 'ACTIVO',
                auxiliares: []
            });
        }

        const cedulaAux = row[6]?.toString().trim();
        const nombreAux = row[7]?.toString().trim();
        const estadoAux = row[18] || 'ACTIVO'; // NUEVO: Columna S para estado auxiliar
        
        if (cedulaAux && nombreAux) {
            tecnicosMap.get(cedula).auxiliares.push({
                cedula: cedulaAux,
                nombre: nombreAux,
                estado: estadoAux // NUEVO
            });
        }
    }

    return Array.from(tecnicosMap.values());
}

        function renderizarPlanPadrino(personal) {
            const tbody = document.getElementById('tbody-plan');
            tbody.innerHTML = '';

            personal.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'personal-row';
                tr.dataset.cedula = p.CEDULA;
                tr.dataset.nombre = p.NOMBRE.toLowerCase();
                tr.dataset.supervisor = p.SUPERVISOR.toLowerCase();
                tr.dataset.ciudad = p.CIUDAD.toLowerCase();

                const auxText = p.auxiliares.length > 0 
                    ? p.auxiliares.map(a => `${a.nombre} (${a.cedula})`).join('<br>')
                    : '<em class="text-muted">Sin auxiliares</em>';

                // Botones solo para ANALISTA
                const botonesAccion = usuarioActual && usuarioActual.rol === 'ANALISTA' 
                    ? `<button class="btn btn-sm btn-primary btn-editar-personal mt-1" data-cedula="${p.CEDULA}">‚úèÔ∏è Editar</button>
                       <button class="btn btn-sm btn-danger btn-eliminar-personal mt-1" data-cedula="${p.CEDULA}">üóëÔ∏è Eliminar</button>`
                    : '<em class="text-muted">Sin permisos</em>';

                tr.innerHTML = `
                    <td>${p.CEDULA}</td>
                    <td>${p.NOMBRE}</td>
                    <td><span class="badge bg-info">${p.CARGO}</span></td>
                    <td>${p.CIUDAD}</td>
                    <td>${p.SUPERVISOR}</td>
                    <td>${p.LIDER}</td>
                    <td>${p.ANALISTA}</td>
                    <td>${auxText}</td>
                    <td>
                        <span class="badge ${p.ESTADO === 'ACTIVO' ? 'bg-success' : 'bg-secondary'}">${p.ESTADO}</span><br>
                        ${botonesAccion}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Solo agregar event listeners para ANALISTA
            if (usuarioActual && usuarioActual.rol === 'ANALISTA') {
                document.querySelectorAll('.btn-editar-personal').forEach(btn => {
                    btn.addEventListener('click', editarPersonal);
                });
                document.querySelectorAll('.btn-eliminar-personal').forEach(btn => {
                    btn.addEventListener('click', eliminarPersonal);
                });
            }

            // Aplicar filtros despu√©s de renderizar
            filtrarPlan();
        }

        // Cargar Asistencia
        document.getElementById('fechaAsistencia').addEventListener('change', async function() {
    const fecha = this.value;
    
    // Cargar rotaciones del d√≠a si es supervisor
    if (usuarioActual && usuarioActual.rol === 'SUPERVISOR' && usuarioActual.supervisorAsignado) {
        personalTemporalHoy = await cargarRotacionesDia(fecha, usuarioActual.supervisorAsignado);
        console.log('Personal temporal cargado:', personalTemporalHoy);
    } else {
        personalTemporalHoy = [];
    }
    
    cargarAsistencia();
});

        async function cargarAsistencia(silencioso = false) {
            try {
                const fecha = document.getElementById('fechaAsistencia').value;
                if (!fecha) {
                    if (!silencioso) alert('Seleccione una fecha');
                    return;
                }

                // Cargar plan padrino si no est√° cargado
                if (datosGlobales.planPadrino.length === 0) {
                    await cargarPlanPadrino();
                }

                const rows = await leerDatosSheet('leerAsistencia');

                const asistenciaHoy = procesarAsistencia(rows, fecha);
                renderizarAsistencia(asistenciaHoy);
                
                // Siempre cargar las opciones de filtros
                cargarFiltrosAsistencia();
                
                // Si es silencioso, restaurar valores guardados
                if (silencioso) {
                    restaurarFiltrosAsistencia();
                }

            } catch (error) {
                console.error('Error al cargar asistencia:', error);
                if (!silencioso) alert('Error al cargar asistencia: ' + error.message);
            }
        }

        function procesarAsistencia(rows, fecha) {
    const asistenciaMap = new Map();
    
    // AGREGAR: Guardar todos los registros para verificar novedades
    datosGlobales.asistenciaCompleta = rows;
    
    // Cargar registros existentes del d√≠a
    if (rows.length > 1) {
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const fechaReg = row[0];
            const cedula = row[1]?.toString().trim();
            
            if (fechaReg === fecha && cedula) {
    asistenciaMap.set(cedula, {
        CEDULA: cedula,
        NOMBRE: row[2] || '',
        CARGO: row[3] || '',
        SUPERVISOR: row[4] || '',
        CIUDAD: row[5] || '',
        ESTADO: row[6] || 'NO_ASISTE',
        HORA_ENTRADA: row[7] || '',
        TIPO_NOVEDAD: row[8] || '',
        OBSERVACIONES: row[9] || '',
        SUPERVISOR_RESPALDO: row[10] || '', // Columna K
        DIAS_NOVEDAD: row[11] || '', // NUEVO: Columna L
        FECHA_INICIO_INCAPACIDAD: row[12] || '' // NUEVO: Columna M
    });
}
        }
    }

    // Agregar personal del plan padrino que no tiene registro
    const personal = [];
    datosGlobales.planPadrino.forEach(p => {
    // NUEVO FILTRO: Solo verificar estado ACTIVO y novedad temporal activa
    // Ya NO verificar columnas R/S de BASE
    const tieneIncapacidadActiva = tieneNovedadActiva(p.CEDULA, fecha);
    
    if (p.ESTADO !== 'ACTIVO') {
        return; // Solo filtrar por estado ACTIVO/INACTIVO de BASE
    }
    
    // Si tiene novedad activa seg√∫n registros de asistencia, NO agregarlo a la lista
    if (tieneIncapacidadActiva) {
        return;
    }
        
        if (asistenciaMap.has(p.CEDULA)) {
            personal.push(asistenciaMap.get(p.CEDULA));
        } else {
            personal.push({
                CEDULA: p.CEDULA,
                NOMBRE: p.NOMBRE,
                CARGO: p.CARGO,
                SUPERVISOR: p.SUPERVISOR,
                CIUDAD: p.CIUDAD,
                ESTADO: 'NO_ASISTE',
                HORA_ENTRADA: '',
                TIPO_NOVEDAD: '',
                OBSERVACIONES: ''
            });
        }

// Agregar auxiliares (tambi√©n verificar novedades Y estado)
// Agregar auxiliares (tambi√©n verificar novedades Y estado)
p.auxiliares.forEach(aux => {
    const tieneIncapacidadActiva = tieneNovedadActiva(aux.cedula, fecha);
    
    if (aux.estado !== 'ACTIVO') {
        return;
    }
    
    if (tieneIncapacidadActiva) {
        return;
    }
    
    if (asistenciaMap.has(aux.cedula)) {
        personal.push(asistenciaMap.get(aux.cedula));
    } else {
        personal.push({
            CEDULA: aux.cedula,
            NOMBRE: aux.nombre,
            CARGO: 'AUXILIAR',
            SUPERVISOR: p.SUPERVISOR,
            CIUDAD: p.CIUDAD,
            ESTADO: 'NO_ASISTE',
            HORA_ENTRADA: '',
            TIPO_NOVEDAD: '',
            OBSERVACIONES: ''
        });
    }
});
    });

    return personal;
}
// Funci√≥n para verificar si una persona tiene novedad activa en una fecha
// Funci√≥n para verificar si una persona tiene novedad activa en una fecha
function tieneNovedadActiva(cedula, fechaConsulta) {
    const registros = datosGlobales.asistenciaCompleta || [];
    
    for (let i = 1; i < registros.length; i++) {
        const row = registros[i];
        const cedulaRegistro = row[1]?.toString().trim();
        const estado = row[6];
        const diasNovedad = parseInt(row[11]) || 0; // NUEVO: Columna L
        const fechaInicioIncapacidad = row[12]; // NUEVO: Columna M
        
        if (cedulaRegistro === cedula && estado === 'NOVEDAD' && diasNovedad > 0 && fechaInicioIncapacidad) {
            // Convertir fechas
            const fechaInicio = new Date(fechaInicioIncapacidad);
            const fechaFin = new Date(fechaInicio);
            fechaFin.setDate(fechaFin.getDate() + diasNovedad - 1);
            
            const fechaConsultaObj = new Date(fechaConsulta);
            
            // Verificar si la fecha de consulta est√° dentro del rango
            if (fechaConsultaObj >= fechaInicio && fechaConsultaObj <= fechaFin) {
                return true;
            }
        }
    }
    
    return false;
}


function renderizarAsistencia(personal) {
    // GUARDAR para exportaci√≥n
    datosGlobales.asistenciaActual = personal;
    
    // FILTRAR por supervisor si es un usuario supervisor
    if (usuarioActual && usuarioActual.rol === 'SUPERVISOR' && usuarioActual.supervisorAsignado) {
        personal = personal.filter(p => 
            p.SUPERVISOR === usuarioActual.supervisorAsignado || 
            p.SUPERVISOR_RESPALDO === usuarioActual.supervisorAsignado ||
            personalTemporalHoy.includes(p.CEDULA) // NUEVO: incluir personal temporal
        );
    }
    const tbody = document.getElementById('tbody-asistencia');
    tbody.innerHTML = '';

            // Calcular estad√≠sticas
            const total = personal.length;
            const asiste = personal.filter(p => p.ESTADO === 'ASISTE').length;
            const tarde = personal.filter(p => p.ESTADO === 'LLEGA_TARDE').length;
            const novedad = personal.filter(p => p.ESTADO === 'NOVEDAD').length;
            const noAsiste = personal.filter(p => p.ESTADO === 'NO_ASISTE').length;
            const ausentismo = total > 0 ? Math.round(((novedad + noAsiste) / total) * 100) : 0;

            document.getElementById('stat-total-asist').textContent = total;
            document.getElementById('stat-asiste').textContent = asiste;
            document.getElementById('stat-tarde').textContent = tarde;
            document.getElementById('stat-novedad').textContent = novedad;
            document.getElementById('stat-no-asiste').textContent = noAsiste;
            document.getElementById('stat-ausentismo').textContent = ausentismo + '%';

            personal.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'asistencia-row';
                tr.dataset.cedula = p.CEDULA;
                tr.dataset.nombre = p.NOMBRE.toLowerCase();
                tr.dataset.supervisor = p.SUPERVISOR.toLowerCase();
                tr.dataset.ciudad = p.CIUDAD.toLowerCase();
                tr.dataset.cargo = p.CARGO;
                tr.dataset.estado = p.ESTADO;

                // Verificar si es personal temporal del supervisor
const esPersonalTemporal = usuarioActual && usuarioActual.rol === 'SUPERVISOR' && personalTemporalHoy.includes(p.CEDULA);

// Bot√≥n para quitar personal temporal
let botonQuitar = '';
if (esPersonalTemporal) {
    botonQuitar = `<button class="btn btn-sm btn-danger btn-quitar-temporal mt-1" 
                          data-cedula="${p.CEDULA}"
                          data-nombre="${p.NOMBRE}">
                        ‚ùå Quitar
                   </button>`;
}

                    // Determinar supervisor de respaldo
const supervisorRespaldo = p.SUPERVISOR_RESPALDO || (esPersonalTemporal && usuarioActual ? usuarioActual.supervisorAsignado : '');

tr.innerHTML = `
    <td data-col="0">${p.CEDULA}</td>
    <td data-col="1">${p.NOMBRE}${esPersonalTemporal ? ' <span class="badge bg-warning text-dark">TEMPORAL</span>' : ''}</td>
    <td data-col="2"><span class="badge bg-secondary">${p.CARGO}</span></td>
    <td data-col="3">${p.CIUDAD}</td>
    <td data-col="4">${p.SUPERVISOR}</td>
    <td data-col="5"><span class="badge estado-${p.ESTADO}">${p.ESTADO.replace('_', ' ')}</span></td>
    <td data-col="6">${p.HORA_ENTRADA}</td>
    <td data-col="7">${p.TIPO_NOVEDAD}</td>
    <td data-col="8">${p.OBSERVACIONES}</td>
    <td data-col="9">${supervisorRespaldo ? `<span class="badge bg-info">${supervisorRespaldo}</span>` : '<span class="text-muted">-</span>'}</td>
    <td data-col="10">
                            <button class="btn btn-sm btn-primary btn-registrar-asist" 
                                    data-cedula="${p.CEDULA}"
                                    data-nombre="${p.NOMBRE}"
                                    data-cargo="${p.CARGO}"
                                    data-ciudad="${p.CIUDAD}"
                                    data-supervisor="${p.SUPERVISOR}">
                                üìù Registrar
                            </button>
                            ${botonQuitar}
                        </td>
                    `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.btn-registrar-asist').forEach(btn => {
                btn.addEventListener('click', abrirModalRegistrar);
            });
// Event listener para quitar personal temporal
// Event listener para quitar personal temporal
document.querySelectorAll('.btn-quitar-temporal').forEach(btn => {
    btn.addEventListener('click', async function() {
        const cedula = this.dataset.cedula;
        const nombre = this.dataset.nombre;
        
        if (!confirm(`¬øQuitar a ${nombre} de tu lista temporal?\n\nEsto eliminar√° el registro de asistencia del d√≠a si no tiene ning√∫n estado registrado, o quitar√° tu nombre como supervisor de respaldo si ya tiene asistencia registrada.`)) return;
        
        try {
            const fecha = document.getElementById('fechaAsistencia').value;
            const supervisor = usuarioActual.supervisorAsignado;
            
            // 1. Eliminar de la hoja ROTACION SUPERVISOR
            await eliminarRotacion(fecha, supervisor, cedula);
            
            // 2. Buscar y actualizar/eliminar en ASISTENCIA
            const response = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: `${CONFIG.HOJA_ASISTENCIA}!A:K`,
            });

            const rows = response.result.values || [];
            let filaEncontrada = -1;
            let registroExistente = null;
            
            // Buscar el registro en ASISTENCIA
            for (let i = 1; i < rows.length; i++) {
                if (rows[i][0] === fecha && rows[i][1] === cedula) {
                    filaEncontrada = i;
                    registroExistente = rows[i];
                    break;
                }
            }
            
            if (filaEncontrada > 0 && registroExistente) {
                const estado = registroExistente[6] || 'NO_ASISTE';
                const tieneAsistenciaRegistrada = estado !== 'NO_ASISTE' && estado !== '';
                
                if (tieneAsistenciaRegistrada) {
                    // Si ya tiene asistencia registrada, solo quitar supervisor de respaldo
                    console.log('Personal tiene asistencia registrada, solo quitando supervisor de respaldo');
                    rows[filaEncontrada][10] = ''; // Limpiar columna K (SUPERVISOR_RESPALDO)
                    
                    // Actualizar la fila
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_ASISTENCIA}!A${filaEncontrada + 1}:K${filaEncontrada + 1}`,
                        valueInputOption: 'RAW',
                        resource: { values: [rows[filaEncontrada]] }
                    });
                } else {
                    // Si NO tiene asistencia registrada (est√° en NO_ASISTE), eliminar toda la fila
                    console.log('Personal sin asistencia registrada, eliminando fila completa');
                    
                    // Obtener sheetId de la hoja ASISTENCIA
                    const metadataResponse = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: CONFIG.SPREADSHEET_ID
                    });

                    const sheets = metadataResponse.result.sheets;
                    const asistenciaSheet = sheets.find(s => s.properties.title === CONFIG.HOJA_ASISTENCIA);
                    
                    if (!asistenciaSheet) {
                        throw new Error('No se encontr√≥ la hoja ASISTENCIA');
                    }

                    const sheetId = asistenciaSheet.properties.sheetId;
                    
                    // Eliminar la fila
                    await gapi.client.sheets.spreadsheets.batchUpdate({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        resource: {
                            requests: [{
                                deleteDimension: {
                                    range: {
                                        sheetId: sheetId,
                                        dimension: 'ROWS',
                                        startIndex: filaEncontrada,
                                        endIndex: filaEncontrada + 1
                                    }
                                }
                            }]
                        }
                    });
                }
            } else {
                console.log('No se encontr√≥ registro en ASISTENCIA para esta persona en esta fecha');
            }
            
            // 3. Eliminar de la lista local
            personalTemporalHoy = personalTemporalHoy.filter(c => c !== cedula);
            
            alert('‚úÖ Personal eliminado de tu lista temporal correctamente');
            
            // 4. Recargar asistencia
            await cargarAsistencia();
        } catch (error) {
            console.error('Error quitando personal temporal:', error);
            alert('‚ùå Error al quitar personal: ' + error.message);
        }
    });
});
            // Aplicar visibilidad de columnas si es supervisor
            if (usuarioActual && usuarioActual.rol === 'SUPERVISOR') {
                aplicarColumnasVisibles();
            }
        }

        // Modal Registrar Asistencia
        function abrirModalRegistrar() {
            document.getElementById('asist-cedula').value = this.dataset.cedula;
            document.getElementById('asist-nombre').value = this.dataset.nombre;
            document.getElementById('asist-cargo').value = this.dataset.cargo;
            document.getElementById('asist-ciudad').value = this.dataset.ciudad;
            document.getElementById('asist-supervisor').value = this.dataset.supervisor;
            
            // LIMPIAR TODOS LOS CAMPOS
            document.getElementById('asist-estado').value = 'ASISTE';
            document.getElementById('asist-hora').value = '';
            document.getElementById('asist-tipo-novedad').value = '';
            document.getElementById('asist-dias-novedad').value = '';
            document.getElementById('asist-companero').value = '';
            document.getElementById('asist-observaciones').value = '';
            
            // Cargar lista de compa√±eros
            cargarListaCompaneros();
            
            // OCULTAR CAMPOS CONDICIONALES
            document.getElementById('div-hora-entrada').style.display = 'none';
            document.getElementById('div-tipo-novedad').style.display = 'none';
            document.getElementById('div-dias-novedad').style.display = 'none';
            
            modalRegistrarAsistencia.show();
        }
        function cargarListaCompaneros() {
    const datalist = document.getElementById('lista-companeros-asist');
    datalist.innerHTML = '';
    
    // Crear lista combinada de todo el personal ACTIVO (t√©cnicos y auxiliares)
    const todosCompaneros = [];
    
    datosGlobales.planPadrino.forEach(p => {
        // Solo incluir personal ACTIVO
        if (p.ESTADO !== 'ACTIVO') {
            return;
        }
        
        // Agregar t√©cnico
        todosCompaneros.push({
            nombre: p.NOMBRE,
            cedula: p.CEDULA,
            cargo: p.CARGO,
            ciudad: p.CIUDAD
        });
        
        // Agregar sus auxiliares
        p.auxiliares.forEach(aux => {
            todosCompaneros.push({
                nombre: aux.nombre,
                cedula: aux.cedula,
                cargo: 'AUXILIAR',
                ciudad: p.CIUDAD
            });
        });
    });
    
    // Ordenar alfab√©ticamente
    todosCompaneros.sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    // Agregar opciones al datalist
    todosCompaneros.forEach(comp => {
        const option = document.createElement('option');
        option.value = `${comp.nombre} (${comp.cedula}) - ${comp.cargo} - ${comp.ciudad}`;
        datalist.appendChild(option);
    });
}
// Abrir modal de personal temporal
document.getElementById('btnAgregarPersonalTemporal').addEventListener('click', function() {
    if (!usuarioActual || !usuarioActual.supervisorAsignado) {
        alert('Error: No se detect√≥ supervisor asignado');
        return;
    }
    
    cargarPersonalDisponibleTemporal();
    modalPersonalTemporal.show();
});

// Cargar personal de otros supervisores
function cargarPersonalDisponibleTemporal() {
    const tbody = document.getElementById('tbody-personal-temp');
    tbody.innerHTML = '';
    
    const miSupervisor = usuarioActual.supervisorAsignado;
    const personalOtrosSupervisores = [];
    
    // Obtener todos los t√©cnicos de otros supervisores
    datosGlobales.planPadrino.forEach(p => {
        if (p.ESTADO === 'ACTIVO' && p.SUPERVISOR !== miSupervisor) {
            personalOtrosSupervisores.push({
                cedula: p.CEDULA,
                nombre: p.NOMBRE,
                cargo: p.CARGO,
                supervisor: p.SUPERVISOR,
                ciudad: p.CIUDAD
            });
            
            // Agregar auxiliares de ese t√©cnico
            p.auxiliares.forEach(aux => {
                if (aux.estado === 'ACTIVO') {
                    personalOtrosSupervisores.push({
                        cedula: aux.cedula,
                        nombre: aux.nombre,
                        cargo: 'AUXILIAR',
                        supervisor: p.SUPERVISOR,
                        ciudad: p.CIUDAD
                    });
                }
            });
        }
    });
    
    // Ordenar alfab√©ticamente
    personalOtrosSupervisores.sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    // Renderizar tabla
    personalOtrosSupervisores.forEach(persona => {
        const yaSeleccionado = personalTemporalHoy.includes(persona.cedula);
        
        const tr = document.createElement('tr');
        tr.className = 'personal-temp-row';
        tr.dataset.cedula = persona.cedula;
        tr.dataset.nombre = persona.nombre.toLowerCase();
        tr.dataset.supervisor = persona.supervisor.toLowerCase();
        
        tr.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input checkbox-personal-temp" 
                       value="${persona.cedula}" 
                       data-nombre="${persona.nombre}"
                       data-supervisor="${persona.supervisor}"
                       ${yaSeleccionado ? 'checked' : ''}>
            </td>
            <td>${persona.cedula}</td>
            <td>${persona.nombre}</td>
            <td><span class="badge bg-secondary">${persona.cargo}</span></td>
            <td>${persona.supervisor}</td>
            <td>${persona.ciudad}</td>
        `;
        
        tbody.appendChild(tr);
    });
    
    // Event listener para b√∫squeda
    document.getElementById('buscar-personal-temp').addEventListener('input', filtrarPersonalTemporal);
    
    // Event listeners para checkboxes
    document.querySelectorAll('.checkbox-personal-temp').forEach(checkbox => {
        checkbox.addEventListener('change', actualizarListaSeleccionados);
    });
    
    actualizarListaSeleccionados();
}

// Filtrar personal temporal
function filtrarPersonalTemporal() {
    const busqueda = document.getElementById('buscar-personal-temp').value.toLowerCase();
    
    document.querySelectorAll('.personal-temp-row').forEach(fila => {
        const nombre = fila.dataset.nombre;
        const cedula = fila.querySelector('td:nth-child(2)').textContent.toLowerCase();
        const supervisor = fila.dataset.supervisor;
        
        const visible = nombre.includes(busqueda) || cedula.includes(busqueda) || supervisor.includes(busqueda);
        fila.style.display = visible ? '' : 'none';
    });
}

// Actualizar lista de seleccionados
function actualizarListaSeleccionados() {
    const checkboxes = document.querySelectorAll('.checkbox-personal-temp:checked');
    const container = document.getElementById('lista-personal-seleccionado');
    
    if (checkboxes.length === 0) {
        container.innerHTML = '<em class="text-muted">Ninguno seleccionado</em>';
        return;
    }
    
    container.innerHTML = '';
    checkboxes.forEach(checkbox => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary me-2 mb-2';
        badge.style.fontSize = '0.9rem';
        badge.innerHTML = `${checkbox.dataset.nombre} <small>(${checkbox.dataset.supervisor})</small>`;
        container.appendChild(badge);
    });
}

// Guardar personal temporal
document.getElementById('btnGuardarPersonalTemporal').addEventListener('click', async function() {
    const checkboxes = document.querySelectorAll('.checkbox-personal-temp:checked');
    
    if (checkboxes.length === 0) {
        alert('Seleccione al menos un personal');
        return;
    }
    
    const fecha = document.getElementById('fechaAsistencia').value;
    const miSupervisor = usuarioActual.supervisorAsignado;
    
    try {
        this.disabled = true;
        this.textContent = 'Guardando...';
        
        // Obtener registros actuales de asistencia
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SPREADSHEET_ID,
            range: `${CONFIG.HOJA_ASISTENCIA}!A:K`,
        });

        const rows = response.result.values || [];
        
        // Asegurar encabezados
        if (rows.length === 0) {
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: `${CONFIG.HOJA_ASISTENCIA}!A1:K1`,
                valueInputOption: 'RAW',
                resource: {
                    values: [['FECHA', 'CEDULA', 'NOMBRE', 'CARGO', 'SUPERVISOR', 'CIUDAD', 'ESTADO', 'HORA_ENTRADA', 'TIPO_NOVEDAD', 'OBSERVACIONES', 'SUPERVISOR_RESPALDO']]
                }
            });
        }
        
        const nuevosRegistros = [];
        
        for (const checkbox of checkboxes) {
            const cedula = checkbox.value;
            
            // Verificar si ya existe registro para hoy
            const existe = rows.some((row, idx) => 
                idx > 0 && row[0] === fecha && row[1] === cedula
            );
            
            if (!existe) {
                // Buscar datos completos del personal
                let persona = null;
                
                for (const p of datosGlobales.planPadrino) {
                    if (p.CEDULA === cedula) {
                        persona = {
                            cedula: p.CEDULA,
                            nombre: p.NOMBRE,
                            cargo: p.CARGO,
                            supervisor: p.SUPERVISOR,
                            ciudad: p.CIUDAD
                        };
                        break;
                    }
                    
                    // Buscar en auxiliares
                    for (const aux of p.auxiliares) {
                        if (aux.cedula === cedula) {
                            persona = {
                                cedula: aux.cedula,
                                nombre: aux.nombre,
                                cargo: 'AUXILIAR',
                                supervisor: p.SUPERVISOR,
                                ciudad: p.CIUDAD
                            };
                            break;
                        }
                    }
                    if (persona) break;
                }
                
                if (persona) {
                    nuevosRegistros.push([
                        fecha,
                        persona.cedula,
                        persona.nombre,
                        persona.cargo,
                        persona.supervisor,
                        persona.ciudad,
                        'NO_ASISTE',
                        '',
                        '',
                        '',
                        miSupervisor // Supervisor de respaldo
                    ]);
                    
                    // Guardar en ROTACION SUPERVISOR
                    await guardarRotacion(fecha, miSupervisor, persona.cedula, persona.nombre, persona.supervisor);
                    personalTemporalHoy.push(cedula);
                }
            } else {
                // Actualizar supervisor de respaldo en registro existente
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i][0] === fecha && rows[i][1] === cedula) {
                        rows[i][10] = miSupervisor; // Agregar respaldo
                    }
                }
                
                // Guardar en ROTACION SUPERVISOR
                let persona = null;
                for (const p of datosGlobales.planPadrino) {
                    if (p.CEDULA === cedula) {
                        persona = { cedula: p.CEDULA, nombre: p.NOMBRE, supervisor: p.SUPERVISOR };
                        break;
                    }
                    for (const aux of p.auxiliares) {
                        if (aux.cedula === cedula) {
                            persona = { cedula: aux.cedula, nombre: aux.nombre, supervisor: p.SUPERVISOR };
                            break;
                        }
                    }
                    if (persona) break;
                }
                
                if (persona) {
                    await guardarRotacion(fecha, miSupervisor, persona.cedula, persona.nombre, persona.supervisor);
                }
                
                personalTemporalHoy.push(cedula);
            }
        }
        
        // Agregar nuevos registros si hay
        if (nuevosRegistros.length > 0) {
            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: `${CONFIG.HOJA_ASISTENCIA}!A:K`,
                valueInputOption: 'RAW',
                insertDataOption: 'INSERT_ROWS',
                resource: { values: nuevosRegistros }
            });
        }
        
        // Actualizar registros existentes con respaldo
        if (rows.length > 1) {
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: `${CONFIG.HOJA_ASISTENCIA}!A1:K${rows.length}`,
                valueInputOption: 'RAW',
                resource: { values: rows }
            });
        }
        
        alert(`‚úÖ Se agregaron ${checkboxes.length} personas a tu lista temporal`);
        modalPersonalTemporal.hide();
        
        // Recargar asistencia
        await cargarAsistencia();
        
    } catch (error) {
        console.error('Error guardando personal temporal:', error);
        alert('Error al guardar: ' + error.message);
    } finally {
        this.disabled = false;
        this.textContent = 'Agregar a Mi Lista';
    }
});
        document.getElementById('asist-estado').addEventListener('change', function() {
            const estado = this.value;
            document.getElementById('div-hora-entrada').style.display = estado === 'LLEGA_TARDE' ? 'block' : 'none';
            document.getElementById('div-tipo-novedad').style.display = estado === 'NOVEDAD' ? 'block' : 'none';
            document.getElementById('div-dias-novedad').style.display = 'none';
        });

        document.getElementById('asist-tipo-novedad').addEventListener('change', function() {
            const tipoNovedad = this.value;
            const novedadesConDias = ['INCAPACIDAD / EPS', 'VACACIONES', 'CALAMIDAD / LUTO'];
            document.getElementById('div-dias-novedad').style.display = novedadesConDias.includes(tipoNovedad) ? 'block' : 'none';
        });

        document.getElementById('btnGuardarAsistencia').addEventListener('click', async function() {
    const fecha = document.getElementById('fechaAsistencia').value;
    const cedula = document.getElementById('asist-cedula').value;
    const nombre = document.getElementById('asist-nombre').value;
    const cargo = document.getElementById('asist-cargo').value;
    const ciudad = document.getElementById('asist-ciudad').value;
    const supervisor = document.getElementById('asist-supervisor').value;
    const estado = document.getElementById('asist-estado').value;
    const hora = document.getElementById('asist-hora').value || '';
    const tipoNovedad = document.getElementById('asist-tipo-novedad').value || '';
    const diasNovedad = parseInt(document.getElementById('asist-dias-novedad').value) || '';
    const observaciones = document.getElementById('asist-observaciones').value || '';
    const companero = document.getElementById('asist-companero').value || '';

    if (estado === 'LLEGA_TARDE' && !hora) {
        alert('Debe especificar la hora de entrada');
        return;
    }

    if (estado === 'NOVEDAD' && !tipoNovedad) {
        alert('Debe especificar el tipo de novedad');
        return;
    }

    const novedadesConDias = ['INCAPACIDAD / EPS', 'VACACIONES', 'CALAMIDAD / LUTO'];
    if (estado === 'NOVEDAD' && novedadesConDias.includes(tipoNovedad) && !diasNovedad) {
        alert('Debe especificar el n√∫mero de d√≠as');
        return;
    }

    try {
        // Actualizar estado en BASE si es novedad
        if (estado === 'NOVEDAD') {
            await actualizarEstadoEnBase(cedula, tipoNovedad);
        }

        // Buscar si ya existe registro
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SPREADSHEET_ID,
            range: `${CONFIG.HOJA_ASISTENCIA}!A:M`, // AMPLIADO: hasta columna M
        });

        const rows = response.result.values || [];
        
        // Asegurar que existan encabezados
        if (rows.length === 0) {
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: `${CONFIG.HOJA_ASISTENCIA}!A1:M1`,
                valueInputOption: 'RAW',
                resource: {
                    values: [['FECHA', 'CEDULA', 'NOMBRE', 'CARGO', 'SUPERVISOR', 'CIUDAD', 'ESTADO', 
                             'HORA_ENTRADA', 'TIPO_NOVEDAD', 'OBSERVACIONES', 'SUPERVISOR_RESPALDO',
                             'DIAS_NOVEDAD', 'FECHA_INICIO_INCAPACIDAD']] // NUEVAS COLUMNAS L y M
                }
            });
        }
        
        // NUEVO: Si es incapacidad con m√∫ltiples d√≠as, crear registros para cada d√≠a
        if (estado === 'NOVEDAD' && novedadesConDias.includes(tipoNovedad) && diasNovedad > 1) {
            const valoresMultiples = [];
            const [year, month, day] = fecha.split('-');
            const fechaInicio = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            const fechaInicioStr = fecha; // Guardar fecha de inicio
            
            for (let i = 0; i < diasNovedad; i++) {
                const fechaActual = new Date(fechaInicio);
                fechaActual.setDate(fechaActual.getDate() + i);
                const fechaStr = fechaActual.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                
                let observacionesCompletas = observaciones;
                observacionesCompletas += ` [D√≠a ${i + 1} de ${diasNovedad}]`;
                if (companero) {
                    observacionesCompletas += ` | Compa√±ero: ${companero}`;
                }
                observacionesCompletas = observacionesCompletas.trim();
                
                valoresMultiples.push([
                    fechaStr, cedula, nombre, cargo, supervisor, ciudad, estado, hora, tipoNovedad, 
                    observacionesCompletas, '', diasNovedad, fechaInicioStr
                ]);
            }
            
            // Eliminar registros existentes para estas fechas/c√©dula
            for (let i = rows.length - 1; i >= 1; i--) {
                const fechaRow = rows[i][0];
                const cedulaRow = rows[i][1];
                
                // Verificar si esta fila debe ser reemplazada
                const debeReemplazar = valoresMultiples.some(v => v[0] === fechaRow && v[1] === cedulaRow);
                if (debeReemplazar) {
                    rows.splice(i, 1);
                }
            }
            
            // Agregar los nuevos registros
            rows.push(...valoresMultiples);
            
            // Actualizar todo el sheet
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: `${CONFIG.HOJA_ASISTENCIA}!A1:M${rows.length}`,
                valueInputOption: 'RAW',
                resource: { values: rows }
            });
            
            alert(`‚úÖ Incapacidad registrada para ${diasNovedad} d√≠as`);
        } else {
            // Flujo normal para un solo d√≠a o sin d√≠as especificados
            let filaExistente = -1;

            for (let i = 1; i < rows.length; i++) {
                if (rows[i][0] === fecha && rows[i][1] === cedula) {
                    filaExistente = i + 1;
                    break;
                }
            }

            let observacionesCompletas = observaciones;
            if (diasNovedad) {
                observacionesCompletas += ` [${diasNovedad} d√≠a(s)]`;
            }
            if (companero) {
                observacionesCompletas += ` | Compa√±ero: ${companero}`;
            }
            observacionesCompletas = observacionesCompletas.trim();
            
            const valores = [[fecha, cedula, nombre, cargo, supervisor, ciudad, estado, hora, tipoNovedad, 
                            observacionesCompletas, '', diasNovedad || '', fecha]]; // NUEVAS COLUMNAS

            if (filaExistente > 0) {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_ASISTENCIA}!A${filaExistente}:M${filaExistente}`,
                    valueInputOption: 'RAW',
                    resource: { values: valores }
                });
            } else {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_ASISTENCIA}!A:M`,
                    valueInputOption: 'RAW',
                    insertDataOption: 'INSERT_ROWS',
                    resource: { values: valores }
                });
            }
            
            alert('‚úÖ Asistencia registrada correctamente');
        }

        modalRegistrarAsistencia.hide();
        await cargarAsistencia();

    } catch (error) {
        console.error('Error completo al guardar:', error);
        console.error('Detalle del error:', error.result || error.message || error);
        alert('Error al guardar: ' + (error.result?.error?.message || error.message || 'Error desconocido. Revisa la consola para m√°s detalles.'));
    }
});

        async function actualizarEstadoEnBase(cedula, tipoNovedad) {
    try {
        console.log('Actualizando estado en BASE:', cedula, tipoNovedad);
        
        // NUEVO: Solo actualizar BASE para novedades PERMANENTES
        const novedadesTemporales = ['INCAPACIDAD / EPS', 'VACACIONES', 'CALAMIDAD / LUTO', 'PERMISO'];
        
        if (novedadesTemporales.includes(tipoNovedad)) {
            console.log('‚ö†Ô∏è Novedad temporal - NO se actualiza BASE (solo registros de asistencia)');
            return; // NO modificar BASE para novedades temporales
        }
        
        // Solo para novedades permanentes (ej: RENUNCIA, DESPIDO, etc)
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SPREADSHEET_ID,
            range: `${CONFIG.HOJA_PLAN}!A:S`,
        });

        const rows = response.result.values || [];
        
        let filasActualizadas = 0;
        for (let i = 1; i < rows.length; i++) {
            const cedulaTecnico = rows[i][0]?.toString().trim();
            const cedulaAux = rows[i][6]?.toString().trim();
            
            while (rows[i].length < 19) {
                rows[i].push('');
            }
            
            if (cedulaTecnico === cedula) {
                rows[i][17] = tipoNovedad; // Columna R para t√©cnico
                filasActualizadas++;
            }
            
            if (cedulaAux === cedula) {
                rows[i][18] = tipoNovedad; // Columna S para auxiliar
                filasActualizadas++;
            }
        }
        
        if (filasActualizadas > 0) {
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: CONFIG.SPREADSHEET_ID,
                range: `${CONFIG.HOJA_PLAN}!A1:S${rows.length}`,
                valueInputOption: 'RAW',
                resource: { values: rows }
            });
            
            console.log(`‚úì Estado actualizado en ${filasActualizadas} fila(s) de BASE`);
        }
    } catch (error) {
        console.error('Error actualizando estado en BASE:', error);
    }
}

        // Modal Personal
        document.getElementById('btnAgregarPersonal').addEventListener('click', function() {
            // Solo ANALISTA puede agregar
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            cargarDropdownsPersonal();
            
            document.getElementById('tituloModalPersonal').textContent = 'Agregar Personal';
            document.getElementById('personal-modo').value = 'agregar';
            document.getElementById('personal-cedula-original').value = '';
            
            document.getElementById('personal-cedula').value = '';
            document.getElementById('personal-nombre').value = '';
            document.getElementById('personal-cargo').value = 'TECNICO';
            document.getElementById('personal-carpeta').value = '';
            document.getElementById('personal-ciudad').value = '';
            document.getElementById('personal-supervisor').value = '';
            document.getElementById('personal-lider').value = '';
            document.getElementById('personal-analista').value = '';
            
            document.getElementById('auxiliares-container').innerHTML = `
                <div class="auxiliar-item mb-2">
                    <div class="row">
                        <div class="col-md-5">
                            <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            
            modalPersonal.show();
        });

        function editarPersonal() {
            // Solo ANALISTA puede editar
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            const cedula = this.dataset.cedula;
            const persona = datosGlobales.planPadrino.find(p => p.CEDULA === cedula);
            
            if (!persona) return;

            cargarDropdownsPersonal();

            document.getElementById('tituloModalPersonal').textContent = 'Editar Personal';
            document.getElementById('personal-modo').value = 'editar';
            document.getElementById('personal-cedula-original').value = cedula;
            
            document.getElementById('personal-cedula').value = persona.CEDULA;
            document.getElementById('personal-nombre').value = persona.NOMBRE;
            document.getElementById('personal-cargo').value = persona.CARGO;
            document.getElementById('personal-carpeta').value = persona.CARPETA || '';
            document.getElementById('personal-ciudad').value = persona.CIUDAD;
            document.getElementById('personal-supervisor').value = persona.SUPERVISOR;
            document.getElementById('personal-lider').value = persona.LIDER;
            document.getElementById('personal-analista').value = persona.ANALISTA;
            
            const container = document.getElementById('auxiliares-container');
            container.innerHTML = '';
            
            if (persona.auxiliares.length > 0) {
                persona.auxiliares.forEach(aux => {
                    container.innerHTML += `
                        <div class="auxiliar-item mb-2">
                            <div class="row">
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar" value="${aux.cedula}">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar" value="${aux.nombre}">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = `
                    <div class="auxiliar-item mb-2">
                        <div class="row">
                            <div class="col-md-5">
                                <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                            </div>
                            <div class="col-md-5">
                                <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modalPersonal.show();
        }

        document.getElementById('btnAgregarAuxiliar').addEventListener('click', function() {
            const container = document.getElementById('auxiliares-container');
            const div = document.createElement('div');
            div.className = 'auxiliar-item mb-2';
            div.innerHTML = `
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });

        function eliminarAuxiliar(btn) {
            btn.closest('.auxiliar-item').remove();
        }

        document.getElementById('btnGuardarPersonal').addEventListener('click', async function() {
            const modo = document.getElementById('personal-modo').value;
            const cedulaOriginal = document.getElementById('personal-cedula-original').value;
            
            const cedula = document.getElementById('personal-cedula').value.trim();
            const nombre = document.getElementById('personal-nombre').value.trim();
            const cargo = document.getElementById('personal-cargo').value;
            const carpeta = document.getElementById('personal-carpeta').value.trim();
            const ciudad = document.getElementById('personal-ciudad').value.trim();
            const supervisor = document.getElementById('personal-supervisor').value.trim();
            const lider = document.getElementById('personal-lider').value.trim();
            const analista = document.getElementById('personal-analista').value.trim();

            if (!cedula || !nombre || !ciudad || !supervisor) {
                alert('Complete los campos obligatorios');
                return;
            }

            try {
                // Recopilar auxiliares
                const auxiliares = [];
                document.querySelectorAll('.auxiliar-item').forEach(item => {
                    const cedAux = item.querySelector('.auxiliar-cedula').value.trim();
                    const nomAux = item.querySelector('.auxiliar-nombre').value.trim();
                    if (cedAux && nomAux) {
                        auxiliares.push({ cedula: cedAux, nombre: nomAux });
                    }
                });

                // Obtener datos actuales
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                let rows = response.result.values || [];

                // Eliminar registros antiguos si es edici√≥n
                if (modo === 'editar') {
                    rows = rows.filter((row, idx) => idx === 0 || row[0] !== cedulaOriginal);
                }

                // Agregar nuevos registros
                if (auxiliares.length === 0) {
                    const newRow = [cedula, nombre, cargo, carpeta, ciudad, supervisor, '', '', lider, analista];
                    // Rellenar hasta columna R (√≠ndice 17)
                    while (newRow.length < 18) {
                        newRow.push('');
                    }
                    newRow[17] = 'ACTIVO'; // Columna R
                    rows.push(newRow);
                } else {
                    auxiliares.forEach(aux => {
                        const newRow = [cedula, nombre, cargo, carpeta, ciudad, supervisor, aux.cedula, aux.nombre, lider, analista];
                        // Rellenar hasta columna R (√≠ndice 17)
                        while (newRow.length < 18) {
                            newRow.push('');
                        }
                        newRow[17] = 'ACTIVO'; // Columna R
                        rows.push(newRow);
                    });
                }

                // Actualizar hoja completa
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A1:R${rows.length}`,
                    valueInputOption: 'RAW',
                    resource: { values: rows }
                });

                alert('‚úÖ Personal guardado correctamente');
                modalPersonal.hide();
                await cargarPlanPadrino();

            } catch (error) {
                console.error('Error completo al guardar asistencia:', error);
                console.error('Detalle del error:', error.result || error.message || error);
                alert('Error al guardar: ' + (error.result?.error?.message || error.message || 'Error desconocido. Revisa la consola.'));
            }
        });

        async function eliminarPersonal() {
            // Solo ANALISTA puede eliminar
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            const cedula = this.dataset.cedula;
            
            console.log('=== INICIANDO ELIMINACI√ìN ===');
            console.log('C√©dula a eliminar:', cedula);
            
            if (!confirm('¬øEst√° seguro de eliminar este personal y todos sus auxiliares asociados?')) return;

            try {
                // Obtener datos
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                const rows = response.result.values || [];
                console.log('Total de filas le√≠das:', rows.length);
                
                // Encontrar todas las filas a eliminar
                const filasAEliminar = [];
                for (let i = 1; i < rows.length; i++) {
                    const cedulaFila = rows[i][0]?.toString().trim();
                    console.log(`Fila ${i}: c√©dula="${cedulaFila}" comparando con "${cedula}"`);
                    if (cedulaFila === cedula) {
                        console.log(`‚úì Coincidencia encontrada en fila ${i}`);
                        filasAEliminar.push(i);
                    }
                }

                console.log('Filas a eliminar:', filasAEliminar);

                if (filasAEliminar.length === 0) {
                    alert('No se encontr√≥ el registro. Revisa la consola para ver los datos.');
                    return;
                }

                // Obtener el sheetId
                const metadataResponse = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID
                });

                const sheets = metadataResponse.result.sheets;
                console.log('Hojas disponibles:', sheets.map(s => s.properties.title));
                
                const baseSheet = sheets.find(s => s.properties.title === CONFIG.HOJA_PLAN);
                
                if (!baseSheet) {
                    alert('No se encontr√≥ la hoja BASE');
                    return;
                }

                const sheetId = baseSheet.properties.sheetId;
                console.log('SheetId de BASE:', sheetId);

                // Crear requests para eliminar (de abajo hacia arriba)
                const requests = [];
                for (let i = filasAEliminar.length - 1; i >= 0; i--) {
                    const filaIndex = filasAEliminar[i];
                    console.log(`Preparando eliminaci√≥n de fila ${filaIndex}`);
                    requests.push({
                        deleteDimension: {
                            range: {
                                sheetId: sheetId,
                                dimension: 'ROWS',
                                startIndex: filaIndex,
                                endIndex: filaIndex + 1
                            }
                        }
                    });
                }

                console.log('Requests a ejecutar:', JSON.stringify(requests, null, 2));

                // Ejecutar eliminaci√≥n
                const deleteResponse = await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    resource: { requests: requests }
                });

                console.log('Respuesta de eliminaci√≥n:', deleteResponse);
                alert('‚úÖ Personal eliminado correctamente');
                await cargarPlanPadrino();

            } catch (error) {
                console.error('Error completo:', error);
                console.error('Error detallado:', JSON.stringify(error, null, 2));
                alert('Error al eliminar: ' + (error.result?.error?.message || error.message));
            }
        }

        // Filtros Plan Padrino
        document.getElementById('busquedaPlan').addEventListener('input', function() {
            estadoFiltrosPlan.busqueda = this.value;
            filtrarPlan();
        });
        document.getElementById('filtroSupervisorPlan').addEventListener('input', function() {
            estadoFiltrosPlan.supervisor = this.value;
            filtrarPlan();
        });
        document.getElementById('filtroCiudadPlan').addEventListener('input', function() {
            estadoFiltrosPlan.ciudad = this.value;
            filtrarPlan();
        });

        function filtrarPlan() {
            const busqueda = estadoFiltrosPlan.busqueda.toLowerCase();
            const supervisor = estadoFiltrosPlan.supervisor.toLowerCase();
            const ciudad = estadoFiltrosPlan.ciudad.toLowerCase();

            document.querySelectorAll('.personal-row').forEach(fila => {
                const nombre = fila.dataset.nombre;
                const cedula = fila.dataset.cedula.toLowerCase();
                const sup = fila.dataset.supervisor;
                const ciu = fila.dataset.ciudad;

                const visible = (nombre.includes(busqueda) || cedula.includes(busqueda)) &&
                                (!supervisor || sup.includes(supervisor)) &&
                                (!ciudad || ciu.includes(ciudad));

                fila.style.display = visible ? '' : 'none';
            });
        }

        function cargarFiltrosPlan() {
            const supervisores = [...new Set(datosGlobales.planPadrino.map(p => p.SUPERVISOR))].filter(s => s).sort();
            const ciudades = [...new Set(datosGlobales.planPadrino.map(p => p.CIUDAD))].filter(c => c).sort();

            const datalistSup = document.getElementById('lista-supervisores-plan');
            const datalistCiu = document.getElementById('lista-ciudades-plan');
            
            // Guardar valores actuales
            const valorActualSup = document.getElementById('filtroSupervisorPlan').value;
            const valorActualCiu = document.getElementById('filtroCiudadPlan').value;

            datalistSup.innerHTML = '';
            supervisores.forEach(s => {
                datalistSup.innerHTML += `<option value="${s}">`;
            });

            datalistCiu.innerHTML = '';
            ciudades.forEach(c => {
                datalistCiu.innerHTML += `<option value="${c}">`;
            });
            
            // Restaurar valores si exist√≠an
            if (valorActualSup) document.getElementById('filtroSupervisorPlan').value = valorActualSup;
            if (valorActualCiu) document.getElementById('filtroCiudadPlan').value = valorActualCiu;
        }

        function restaurarFiltrosPlan() {
            // Restaurar valores de los filtros sin recargar opciones
            document.getElementById('busquedaPlan').value = estadoFiltrosPlan.busqueda;
            document.getElementById('filtroSupervisorPlan').value = estadoFiltrosPlan.supervisor;
            document.getElementById('filtroCiudadPlan').value = estadoFiltrosPlan.ciudad;
            
            // Aplicar filtros
            filtrarPlan();
        }

        // ========== EXPORTAR A EXCEL ==========
        document.getElementById('btnExportarAsistencia').addEventListener('click', function() {
            exportarTablaAExcel('tablaAsistencia', 'Asistencia');
        });
        
        document.getElementById('btnExportarAsistencia2').addEventListener('click', function() {
            exportarTablaAExcel('tablaAsistencia', 'Asistencia');
        });

        document.getElementById('btnExportarPlan').addEventListener('click', function() {
            exportarTablaAExcel('tablaPlanPadrino', 'Base_Personal');
        });

        function exportarTablaAExcel(idTabla, nombreArchivo) {
    try {
        const tabla = document.getElementById(idTabla);
        const filas = tabla.querySelectorAll('tbody tr');
        
        // Verificar si hay filas visibles
        const filasVisibles = Array.from(filas).filter(fila => fila.style.display !== 'none');
        
        if (filasVisibles.length === 0) {
            alert('No hay datos para exportar');
            return;
        }

        // Crear datos para Excel
        const datos = [];
        
        // Determinar si es exportaci√≥n de asistencia
        const esAsistencia = idTabla === 'tablaAsistencia';
        
        // Obtener encabezados base
        const encabezados = [];
        tabla.querySelectorAll('thead th').forEach((th, index) => {
            // No incluir la columna de Acciones
            if (index < tabla.querySelectorAll('thead th').length - 1) {
                encabezados.push(th.textContent.trim());
            }
        });
        
        // Agregar columnas adicionales para asistencia
if (esAsistencia) {
    encabezados.push('Fecha Registro');
    encabezados.push('Supervisor de Respaldo');
    encabezados.push('C√©dula Auxiliar');
    encabezados.push('Nombre Auxiliar');
}
        
        datos.push(encabezados);

        // Obtener fecha seleccionada (solo para asistencia)
        const fechaRegistro = esAsistencia ? document.getElementById('fechaAsistencia').value : '';

        // Obtener filas visibles
        filasVisibles.forEach(fila => {
            const filaData = [];
            fila.querySelectorAll('td').forEach((td, index) => {
                // No incluir la columna de Acciones (√∫ltima columna)
                if (index < encabezados.length - (esAsistencia ? 4 : 1)) {
                    // Extraer solo texto, sin HTML
                    let texto = td.textContent.trim();
                    // Limpiar espacios m√∫ltiples y saltos de l√≠nea
                    texto = texto.replace(/\s+/g, ' ');
                    filaData.push(texto);
                }
            });
            
            // Agregar datos adicionales para asistencia
            // Agregar datos adicionales para asistencia
// Agregar datos adicionales para asistencia
if (esAsistencia) {
    // Agregar fecha de registro
    filaData.push(fechaRegistro);
    
    // NUEVO: Buscar supervisor de respaldo en la hoja ROTACION SUPERVISOR
    const cedula = fila.querySelectorAll('td')[0]?.textContent.trim() || '';
    let supervisorRespaldo = '';
    
    // Buscar en los datos de asistencia actuales si tiene supervisor de respaldo
    if (datosGlobales.asistenciaActual) {
        const personaAsist = datosGlobales.asistenciaActual.find(p => p.CEDULA === cedula);
        if (personaAsist && personaAsist.SUPERVISOR_RESPALDO) {
            supervisorRespaldo = personaAsist.SUPERVISOR_RESPALDO;
        }
    }
    
    // Si no se encontr√≥ en memoria, verificar si est√° en la lista temporal del d√≠a
    if (!supervisorRespaldo && usuarioActual && usuarioActual.rol === 'SUPERVISOR') {
        if (personalTemporalHoy.includes(cedula)) {
            supervisorRespaldo = usuarioActual.supervisorAsignado || '';
        }
    }
    
    filaData.push(supervisorRespaldo);
    
    // Extraer informaci√≥n de auxiliar de las observaciones
    const observaciones = fila.querySelectorAll('td')[8]?.textContent.trim() || '';
    let cedulaAuxiliar = '';
    let nombreAuxiliar = '';
    let companeroManual = '';
    
    // Buscar patr√≥n: "| Compa√±ero: NOMBRE (CEDULA) - CARGO - CIUDAD"
    const regexCompanero = /\|\s*Compa√±ero:\s*([^(]+)\s*\((\d+)\)\s*-\s*[^-]+\s*-\s*[^\|]+/;
    const match = observaciones.match(regexCompanero);
    
    if (match) {
        // Formato correcto encontrado - extraer datos estructurados
        nombreAuxiliar = match[1].trim();
        cedulaAuxiliar = match[2].trim();
    } else {
        // Buscar si hay algo escrito manualmente despu√©s de "Compa√±ero:"
        const regexManual = /\|\s*Compa√±ero:\s*(.+?)(?:\||$)/;
        const matchManual = observaciones.match(regexManual);
        
        if (matchManual) {
            // Hay texto manual - dejarlo en observaciones y columnas vac√≠as
            companeroManual = matchManual[1].trim();
            // Las columnas de c√©dula y nombre quedan vac√≠as para que backoffice lo procese
            cedulaAuxiliar = '';
            nombreAuxiliar = '';
        }
    }
    
    filaData.push(cedulaAuxiliar);
    filaData.push(nombreAuxiliar);
}
            
            datos.push(filaData);
        });

        // Crear libro de Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(datos);

        // Ajustar ancho de columnas
        const colWidths = encabezados.map(() => ({wch: 15}));
        ws['!cols'] = colWidths;

        // Agregar hoja al libro
        XLSX.utils.book_append_sheet(wb, ws, 'Datos');

        // Generar nombre de archivo con fecha
        const fecha = new Date().toISOString().split('T')[0];
        const nombreFinal = `${nombreArchivo}_${fecha}.xlsx`;

        // Descargar archivo
        XLSX.writeFile(wb, nombreFinal);

        alert(`‚úÖ Archivo exportado: ${nombreFinal}`);
    } catch (error) {
        console.error('Error al exportar:', error);
        alert('Error al exportar: ' + error.message);
    }
}

        // ========== VALORES PERMITIDOS ==========
        async function cargarValores() {
            try {
                const rows = await leerDatosSheet('leerValores');
                
                if (rows.length === 0) {
                    datosGlobales.valores = {CARPETA: [], CIUDAD: [], SUPERVISOR: [], LIDER: [], ANALISTA: []};
                } else {
                    datosGlobales.valores = {
                        CARPETA: [],
                        CIUDAD: [],
                        SUPERVISOR: [],
                        LIDER: [],
                        ANALISTA: []
                    };

                    const numRows = rows.length;

                    for (let col = 0; col < 5; col++) {
                        const columnas = ['CARPETA', 'CIUDAD', 'SUPERVISOR', 'LIDER', 'ANALISTA'];
                        for (let row = 1; row < numRows; row++) {
                            const valor = rows[row][col]?.toString().trim();
                            if (valor) {
                                datosGlobales.valores[columnas[col]].push(valor);
                            }
                        }
                    }
                }

                renderizarValores();
            } catch (error) {
                console.error('Error cargando valores:', error);
                alert('Error al cargar valores permitidos: ' + error.message);
            }
        }

        function renderizarValores() {
            const puedeEditar = usuarioActual && usuarioActual.rol === 'ANALISTA';
            
            // Carpetas
            const listaCarpetas = document.getElementById('lista-carpetas');
            listaCarpetas.innerHTML = '';
            datosGlobales.valores.CARPETA.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('CARPETA', '${v}')">√ó</button>` : '';
                listaCarpetas.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });

            // Ciudades
            const listaCiudades = document.getElementById('lista-ciudades');
            listaCiudades.innerHTML = '';
            datosGlobales.valores.CIUDAD.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('CIUDAD', '${v}')">√ó</button>` : '';
                listaCiudades.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });

            // Supervisores
            const listaSupervisores = document.getElementById('lista-supervisores');
            listaSupervisores.innerHTML = '';
            datosGlobales.valores.SUPERVISOR.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('SUPERVISOR', '${v}')">√ó</button>` : '';
                listaSupervisores.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });

            // L√≠deres
            const listaLideres = document.getElementById('lista-lideres');
            listaLideres.innerHTML = '';
            datosGlobales.valores.LIDER.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('LIDER', '${v}')">√ó</button>` : '';
                listaLideres.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });

            // Analistas
            const listaAnalistas = document.getElementById('lista-analistas');
            listaAnalistas.innerHTML = '';
            datosGlobales.valores.ANALISTA.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('ANALISTA', '${v}')">√ó</button>` : '';
                listaAnalistas.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });
        }

        async function agregarValor(tipo) {
            // Solo ANALISTA puede agregar valores
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            const inputs = {
                'CARPETA': 'nuevaCarpeta',
                'CIUDAD': 'nuevaCiudad',
                'SUPERVISOR': 'nuevoSupervisor',
                'LIDER': 'nuevoLider',
                'ANALISTA': 'nuevoAnalista'
            };

            const input = document.getElementById(inputs[tipo]);
            const valor = input.value.trim();

            if (!valor) {
                alert('Ingrese un valor');
                return;
            }

            if (datosGlobales.valores[tipo].includes(valor)) {
                alert('Este valor ya existe');
                return;
            }

            try {
                datosGlobales.valores[tipo].push(valor);
                await guardarValores();
                input.value = '';
                renderizarValores();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al agregar valor: ' + error.message);
            }
        }

        async function eliminarValor(tipo, valor) {
            // Solo ANALISTA puede eliminar valores
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            if (!confirm(`¬øEliminar "${valor}"?`)) return;

            try {
                datosGlobales.valores[tipo] = datosGlobales.valores[tipo].filter(v => v !== valor);
                await guardarValores();
                renderizarValores();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar valor: ' + error.message);
            }
        }

        async function guardarValores() {
            try {
                // Preparar datos en columnas
                const maxLength = Math.max(
                    datosGlobales.valores.CARPETA.length,
                    datosGlobales.valores.CIUDAD.length,
                    datosGlobales.valores.SUPERVISOR.length,
                    datosGlobales.valores.LIDER.length,
                    datosGlobales.valores.ANALISTA.length
                );

                const rows = [['CARPETA', 'CIUDAD', 'SUPERVISOR', 'LIDER', 'ANALISTA']];

                for (let i = 0; i < maxLength; i++) {
                    rows.push([
                        datosGlobales.valores.CARPETA[i] || '',
                        datosGlobales.valores.CIUDAD[i] || '',
                        datosGlobales.valores.SUPERVISOR[i] || '',
                        datosGlobales.valores.LIDER[i] || '',
                        datosGlobales.valores.ANALISTA[i] || ''
                    ]);
                }

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_VALORES}!A1:E${rows.length}`,
                    valueInputOption: 'RAW',
                    resource: { values: rows }
                });
            } catch (error) {
                throw error;
            }
        }

        // Cargar dropdowns en modal de personal
        function cargarDropdownsPersonal() {
            // Carpeta
            const selectCarpeta = document.getElementById('personal-carpeta');
            selectCarpeta.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.CARPETA.forEach(v => {
                selectCarpeta.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // Ciudad
            const selectCiudad = document.getElementById('personal-ciudad');
            selectCiudad.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.CIUDAD.forEach(v => {
                selectCiudad.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // Supervisor
            const selectSupervisor = document.getElementById('personal-supervisor');
            selectSupervisor.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.SUPERVISOR.forEach(v => {
                selectSupervisor.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // L√≠der
            const selectLider = document.getElementById('personal-lider');
            selectLider.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.LIDER.forEach(v => {
                selectLider.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // Analista
            const selectAnalista = document.getElementById('personal-analista');
            selectAnalista.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.ANALISTA.forEach(v => {
                selectAnalista.innerHTML += `<option value="${v}">${v}</option>`;
            });
        }

        // Filtros Asistencia
        document.getElementById('busquedaAsist').addEventListener('input', function() {
            estadoFiltrosAsistencia.busqueda = this.value;
            filtrarAsistencia();
        });
        document.getElementById('filtroSupervisorAsist').addEventListener('input', function() {
            estadoFiltrosAsistencia.supervisor = this.value;
            filtrarAsistencia();
        });
        document.getElementById('filtroCiudadAsist').addEventListener('input', function() {
            estadoFiltrosAsistencia.ciudad = this.value;
            filtrarAsistencia();
        });
        document.getElementById('filtroCargoAsist').addEventListener('change', function() {
            estadoFiltrosAsistencia.cargo = this.value;
            filtrarAsistencia();
        });
        document.getElementById('filtroEstadoAsist').addEventListener('change', function() {
            estadoFiltrosAsistencia.estado = this.value;
            filtrarAsistencia();
        });

        function filtrarAsistencia() {
            const busqueda = estadoFiltrosAsistencia.busqueda.toLowerCase();
            const supervisor = estadoFiltrosAsistencia.supervisor.toLowerCase();
            const ciudad = estadoFiltrosAsistencia.ciudad.toLowerCase();
            const cargo = estadoFiltrosAsistencia.cargo;
            const estado = estadoFiltrosAsistencia.estado;

            let totalFiltrado = 0;
            let asisteFiltrado = 0;
            let tardeFiltrado = 0;
            let novedadFiltrado = 0;
            let noAsisteFiltrado = 0;

            document.querySelectorAll('.asistencia-row').forEach(fila => {
                const nombre = fila.dataset.nombre;
                const cedula = fila.dataset.cedula.toLowerCase();
                const sup = fila.dataset.supervisor;
                const ciu = fila.dataset.ciudad;
                const car = fila.dataset.cargo;
                const est = fila.dataset.estado;

                const visible = (nombre.includes(busqueda) || cedula.includes(busqueda)) &&
                                (!supervisor || sup.includes(supervisor)) &&
                                (!ciudad || ciu.includes(ciudad)) &&
                                (!cargo || car === cargo) &&
                                (!estado || est === estado);

                fila.style.display = visible ? '' : 'none';

                if (visible) {
                    totalFiltrado++;
                    if (est === 'ASISTE') asisteFiltrado++;
                    else if (est === 'LLEGA_TARDE') tardeFiltrado++;
                    else if (est === 'NOVEDAD') novedadFiltrado++;
                    else if (est === 'NO_ASISTE') noAsisteFiltrado++;
                }
            });

            document.getElementById('stat-total-asist').textContent = totalFiltrado;
            document.getElementById('stat-asiste').textContent = asisteFiltrado;
            document.getElementById('stat-tarde').textContent = tardeFiltrado;
            document.getElementById('stat-novedad').textContent = novedadFiltrado;
            document.getElementById('stat-no-asiste').textContent = noAsisteFiltrado;

            const ausentismo = totalFiltrado > 0 ? Math.round(((novedadFiltrado + noAsisteFiltrado) / totalFiltrado) * 100) : 0;
            document.getElementById('stat-ausentismo').textContent = ausentismo + '%';
        }

        function cargarFiltrosAsistencia() {
            const supervisores = [...new Set(datosGlobales.planPadrino.map(p => p.SUPERVISOR))].filter(s => s).sort();
            const ciudades = [...new Set(datosGlobales.planPadrino.map(p => p.CIUDAD))].filter(c => c).sort();

            const datalistSup = document.getElementById('lista-supervisores-asist');
            const datalistCiu = document.getElementById('lista-ciudades-asist');
            
            // Guardar valores actuales
            const valorActualSup = document.getElementById('filtroSupervisorAsist').value;
            const valorActualCiu = document.getElementById('filtroCiudadAsist').value;

            datalistSup.innerHTML = '';
            supervisores.forEach(s => {
                datalistSup.innerHTML += `<option value="${s}">`;
            });

            datalistCiu.innerHTML = '';
            ciudades.forEach(c => {
                datalistCiu.innerHTML += `<option value="${c}">`;
            });
            
            // Restaurar valores si exist√≠an
            if (valorActualSup) document.getElementById('filtroSupervisorAsist').value = valorActualSup;
            if (valorActualCiu) document.getElementById('filtroCiudadAsist').value = valorActualCiu;
        }

        function restaurarFiltrosAsistencia() {
            // Restaurar valores de los filtros sin recargar opciones
            document.getElementById('busquedaAsist').value = estadoFiltrosAsistencia.busqueda;
            document.getElementById('filtroSupervisorAsist').value = estadoFiltrosAsistencia.supervisor;
            document.getElementById('filtroCiudadAsist').value = estadoFiltrosAsistencia.ciudad;
            document.getElementById('filtroCargoAsist').value = estadoFiltrosAsistencia.cargo;
            document.getElementById('filtroEstadoAsist').value = estadoFiltrosAsistencia.estado;
            
            // Aplicar filtros
            filtrarAsistencia();
        }
    </script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</body>
</html>
