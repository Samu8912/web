<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asistencia - Conectar TV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f2f0f8;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0;
            margin: 0;
        }

        .container-fluid {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header-section {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .header-section h1 {
            color: #667eea;
            font-weight: bold;
        }

        .nav-tabs {
            border-bottom: 2px solid #667eea;
        }

        .nav-tabs .nav-link {
            color: #667eea;
            font-weight: 600;
            border: none;
            padding: 1rem 2rem;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border-radius: 10px 10px 0 0;
        }

        .stats-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            padding: 1.5rem;
            text-align: center;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stats-card p {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0;
        }

        .card-total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .card-asiste { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); }
        .card-novedad { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        .card-no-asiste { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .card-tarde { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }

        .table-responsive {
            background: white;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table thead th {
            border-bottom: 2px solid #667eea;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .badge {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 8px;
        }

        .estado-ASISTE { background-color: #c6f6d5 !important; color: #22543d !important; }
        .estado-NO_ASISTE { background-color: #fed7d7 !important; color: #c53030 !important; }
        .estado-NOVEDAD { background-color: #feebc8 !important; color: #c05621 !important; }
        .estado-LLEGA_TARDE { background-color: #bee3f8 !important; color: #2c5282 !important; }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .modal-content {
            border-radius: 15px;
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .container-fluid { padding: 1rem; }
            .stats-card h3 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header-section" id="header-principal" style="display:none;">
            <h1 class="text-center mb-3">üìã Sistema de Asistencia y Gesti√≥n de Personal</h1>
            <h5 class="text-center text-muted">Conectar TV</h5>
            <p class="text-center text-muted mb-0" id="fecha-actual"></p>
            <p class="text-center mb-3">
                <span class="badge bg-primary" id="usuario-rol"></span>
            </p>
            <div class="text-center mt-3">
                <button id="btnAutorizar" class="btn btn-primary btn-lg">üîê Autorizar Google Sheets</button>
                <button id="btnCerrarSesion" class="btn btn-secondary" style="display:none;">üö™ Cerrar Sesi√≥n</button>
                <button id="btnCerrarSesionUsuario" class="btn btn-danger" style="display:none;">üë§ Cerrar Sesi√≥n Usuario</button>
            </div>
        </div>

        <!-- Login -->
        <div class="header-section" id="login-section">
            <h1 class="text-center mb-4">üîê Iniciar Sesi√≥n</h1>
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Usuario:</label>
                        <input type="text" class="form-control" id="login-usuario" placeholder="Ingrese usuario">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Contrase√±a:</label>
                        <input type="password" class="form-control" id="login-password" placeholder="Ingrese contrase√±a">
                    </div>
                    <button class="btn btn-primary w-100 btn-lg" id="btnLogin">Iniciar Sesi√≥n</button>
                    <div class="alert alert-danger mt-3" id="login-error" style="display:none;"></div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist" style="display:none;">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="asistencia-tab" data-bs-toggle="tab" data-bs-target="#asistencia" type="button">
                    ‚úÖ Asistencia Diaria
                </button>
            </li>
            <li class="nav-item" role="presentation" id="tab-plan">
                <button class="nav-link" id="plan-tab" data-bs-toggle="tab" data-bs-target="#plan-padrino" type="button">
                    üë• Base de Personal
                </button>
            </li>
            <li class="nav-item" role="presentation" id="tab-valores">
                <button class="nav-link" id="valores-tab" data-bs-toggle="tab" data-bs-target="#valores" type="button">
                    ‚öôÔ∏è Valores Permitidos
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabsContent" style="display:none;">
            <!-- ASISTENCIA -->
            <div class="tab-pane fade show active" id="asistencia" role="tabpanel">
                <!-- Selector de Fecha -->
                <div class="section-card">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">üìÖ Seleccionar Fecha:</label>
                            <input type="date" id="fechaAsistencia" class="form-control">
                        </div>
                        <div class="col-md-8 text-end" id="controles-analista">
                            <button id="btnExportarAsistencia" class="btn btn-success">üì• Exportar a Excel</button>
                        </div>
                        <div class="col-md-8 text-end" id="controles-supervisor" style="display:none;">
                            <button class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#columnas-selector">
                                üëÅÔ∏è Mostrar/Ocultar Columnas
                            </button>
                            <button id="btnExportarAsistencia2" class="btn btn-success">üì• Exportar</button>
                        </div>
                    </div>
                    
                    <!-- Selector de columnas para supervisor -->
                    <div class="collapse mt-3" id="columnas-selector">
                        <div class="card card-body">
                            <h6 class="fw-bold mb-3">Seleccionar columnas visibles:</h6>
                            <div class="row">
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-cedula" data-col="0">
                                        <label class="form-check-label" for="col-cedula">C√©dula</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-nombre" data-col="1" checked disabled>
                                        <label class="form-check-label" for="col-nombre">Nombre *</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-cargo" data-col="2">
                                        <label class="form-check-label" for="col-cargo">Cargo</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-ciudad" data-col="3">
                                        <label class="form-check-label" for="col-ciudad">Ciudad</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-supervisor" data-col="4">
                                        <label class="form-check-label" for="col-supervisor">Supervisor</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-estado" data-col="5" checked>
                                        <label class="form-check-label" for="col-estado">Estado</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-hora" data-col="6">
                                        <label class="form-check-label" for="col-hora">Hora Entrada</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-tipo-novedad" data-col="7">
                                        <label class="form-check-label" for="col-tipo-novedad">Tipo Novedad</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input columna-toggle" type="checkbox" id="col-observaciones" data-col="8">
                                        <label class="form-check-label" for="col-observaciones">Observaciones</label>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted mt-2">* Columnas obligatorias que no se pueden ocultar</small>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="row mb-4">
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-total">
                            <div class="stats-icon">üë•</div>
                            <h3 id="stat-total-asist">0</h3>
                            <p>Total Personal</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-asiste">
                            <div class="stats-icon">‚úÖ</div>
                            <h3 id="stat-asiste">0</h3>
                            <p>Asiste</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-tarde">
                            <div class="stats-icon">‚è∞</div>
                            <h3 id="stat-tarde">0</h3>
                            <p>Llega Tarde</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-novedad">
                            <div class="stats-icon">‚ö†Ô∏è</div>
                            <h3 id="stat-novedad">0</h3>
                            <p>Novedad</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card card-no-asiste">
                            <div class="stats-icon">‚ùå</div>
                            <h3 id="stat-no-asiste">0</h3>
                            <p>No Asiste</p>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6 mb-3">
                        <div class="stats-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                            <div class="stats-icon">üìä</div>
                            <h3 id="stat-ausentismo">0%</h3>
                            <p>Ausentismo</p>
                        </div>
                    </div>
                </div>

                <!-- Filtros Asistencia -->
                <div class="section-card">
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6">
                            <input type="text" id="busquedaAsist" class="form-control" placeholder="üîç Buscar...">
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <input type="text" id="filtroSupervisorAsist" class="form-control" list="lista-supervisores-asist" placeholder="üìä Supervisor...">
                            <datalist id="lista-supervisores-asist"></datalist>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <input type="text" id="filtroCiudadAsist" class="form-control" list="lista-ciudades-asist" placeholder="üèôÔ∏è Ciudad...">
                            <datalist id="lista-ciudades-asist"></datalist>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <select id="filtroCargoAsist" class="form-select">
                                <option value="">üëî Todos los cargos</option>
                                <option value="TECNICO">T√©cnico</option>
                                <option value="AUXILIAR">Auxiliar</option>
                            </select>
                        </div>
                        <div class="col-lg-2 col-md-6">
                            <select id="filtroEstadoAsist" class="form-select">
                                <option value="">üìå Todos los estados</option>
                                <option value="ASISTE">‚úÖ Asiste</option>
                                <option value="LLEGA_TARDE">‚è∞ Llega Tarde</option>
                                <option value="NOVEDAD">‚ö†Ô∏è Novedad</option>
                                <option value="NO_ASISTE">‚ùå No Asiste</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabla Asistencia -->
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaAsistencia">
                        <thead class="table-dark">
                            <tr>
                                <th data-col="0">C√©dula</th>
                                <th data-col="1">Nombre</th>
                                <th data-col="2">Cargo</th>
                                <th data-col="3">Ciudad</th>
                                <th data-col="4">Supervisor</th>
                                <th data-col="5">Estado</th>
                                <th data-col="6">Hora Entrada</th>
                                <th data-col="7">Tipo Novedad</th>
                                <th data-col="8">Observaciones</th>
                                <th data-col="9">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-asistencia">
                            <!-- Din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PLAN PADRINO -->
            <div class="tab-pane fade" id="plan-padrino" role="tabpanel">
                <!-- Bot√≥n Agregar -->
                <div class="section-card" id="btn-agregar-personal-container">
                    <button id="btnAgregarPersonal" class="btn btn-success btn-lg">‚ûï Agregar Personal</button>
                    <button id="btnExportarPlan" class="btn btn-primary btn-lg">üì• Exportar a Excel</button>
                </div>

                <!-- Filtros Plan Padrino -->
                <div class="section-card">
                    <div class="row g-3">
                        <div class="col-lg-4 col-md-6">
                            <input type="text" id="busquedaPlan" class="form-control" placeholder="üîç Buscar por nombre o c√©dula...">
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <select id="filtroSupervisorPlan" class="form-select">
                                <option value="">üìä Todos los supervisores</option>
                            </select>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <select id="filtroCiudadPlan" class="form-select">
                                <option value="">üèôÔ∏è Todas las ciudades</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Tabla Plan Padrino -->
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaPlanPadrino">
                        <thead class="table-dark">
                            <tr>
                                <th>C√©dula</th>
                                <th>Nombre</th>
                                <th>Cargo</th>
                                <th>Ciudad</th>
                                <th>Supervisor</th>
                                <th>L√≠der</th>
                                <th>Analista</th>
                                <th>Auxiliares</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-plan">
                            <!-- Din√°mico -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- VALORES PERMITIDOS -->
            <div class="tab-pane fade" id="valores" role="tabpanel">
                <div class="section-card">
                    <h4 class="mb-4">‚öôÔ∏è Gesti√≥n de Valores Permitidos</h4>
                    <p class="text-muted">Configure los valores permitidos para cada campo. Estos valores se usar√°n en los formularios de Base de Personal.</p>
                </div>

                <!-- CARPETA -->
                <div class="section-card">
                    <h5 class="mb-3">üìÅ Carpetas</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevaCarpeta" placeholder="Nueva carpeta...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('CARPETA')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-carpetas" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- CIUDAD -->
                <div class="section-card">
                    <h5 class="mb-3">üèôÔ∏è Ciudades</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevaCiudad" placeholder="Nueva ciudad...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('CIUDAD')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-ciudades" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- SUPERVISOR -->
                <div class="section-card">
                    <h5 class="mb-3">üëî Supervisores</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevoSupervisor" placeholder="Nuevo supervisor...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('SUPERVISOR')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-supervisores" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- LIDER -->
                <div class="section-card">
                    <h5 class="mb-3">‚≠ê L√≠deres</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevoLider" placeholder="Nuevo l√≠der...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('LIDER')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-lideres" class="d-flex flex-wrap gap-2"></div>
                </div>

                <!-- ANALISTA -->
                <div class="section-card">
                    <h5 class="mb-3">üìä Analistas</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="nuevoAnalista" placeholder="Nuevo analista...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="agregarValor('ANALISTA')">‚ûï Agregar</button>
                        </div>
                    </div>
                    <div id="lista-analistas" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Asistencia -->
    <div class="modal fade" id="modalRegistrarAsistencia" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Asistencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="asist-cedula">
                    <input type="hidden" id="asist-nombre">
                    <input type="hidden" id="asist-cargo">
                    <input type="hidden" id="asist-ciudad">
                    <input type="hidden" id="asist-supervisor">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Estado de Asistencia:</label>
                        <select id="asist-estado" class="form-select">
                            <option value="ASISTE">‚úÖ Asiste</option>
                            <option value="LLEGA_TARDE">‚è∞ Llega Tarde</option>
                            <option value="NOVEDAD">‚ö†Ô∏è Novedad</option>
                            <option value="NO_ASISTE">‚ùå No Asiste</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="div-hora-entrada" style="display:none;">
                        <label class="form-label fw-bold">Hora de Entrada:</label>
                        <input type="time" class="form-control" id="asist-hora">
                    </div>
                    
                    <div class="mb-3" id="div-tipo-novedad" style="display:none;">
                        <label class="form-label fw-bold">Tipo de Novedad:</label>
                        <select id="asist-tipo-novedad" class="form-select">
                            <option value="">Seleccionar...</option>
                            <option value="INCAPACIDAD / EPS">INCAPACIDAD / EPS</option>
                            <option value="AUSENCIA INJUSTIFICADA">AUSENCIA INJUSTIFICADA</option>
                            <option value="VACACIONES">VACACIONES</option>
                            <option value="PERMISO">PERMISO</option>
                            <option value="RETIRO / RENUNCIA">RETIRO / RENUNCIA</option>
                            <option value="SUSPENSI√ìN">SUSPENSI√ìN</option>
                            <option value="MOTO / VEH√çCULO">MOTO / VEH√çCULO</option>
                            <option value="CALAMIDAD / LUTO">CALAMIDAD / LUTO</option>
                            <option value="APOYO OPERATIVO">APOYO OPERATIVO</option>
                            <option value="OTROS">OTROS</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="div-dias-novedad" style="display:none;">
                        <label class="form-label fw-bold">D√≠as de Novedad:</label>
                        <input type="number" class="form-control" id="asist-dias-novedad" min="1" placeholder="N√∫mero de d√≠as">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Observaciones (Opcional):</label>
                        <textarea id="asist-observaciones" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarAsistencia">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar/Editar Personal -->
    <div class="modal fade" id="modalPersonal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModalPersonal">Agregar Personal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="personal-modo">
                    <input type="hidden" id="personal-cedula-original">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">C√©dula *</label>
                            <input type="text" class="form-control" id="personal-cedula" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Nombre Completo *</label>
                            <input type="text" class="form-control" id="personal-nombre" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Cargo *</label>
                            <select class="form-select" id="personal-cargo" required>
                                <option value="TECNICO">T√©cnico</option>
                                <option value="AUXILIAR">Auxiliar</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Carpeta</label>
                            <select class="form-select" id="personal-carpeta"></select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Ciudad *</label>
                            <select class="form-select" id="personal-ciudad" required></select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-bold">Supervisor *</label>
                            <select class="form-select" id="personal-supervisor" required></select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">L√≠der</label>
                            <select class="form-select" id="personal-lider"></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Analista</label>
                            <select class="form-select" id="personal-analista"></select>
                        </div>
                    </div>
                    
                    <hr>
                    <h6 class="fw-bold">Auxiliares Asignados</h6>
                    <div id="auxiliares-container">
                        <div class="auxiliar-item mb-2">
                            <div class="row">
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" id="btnAgregarAuxiliar">‚ûï Agregar Auxiliar</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnGuardarPersonal">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Configuraci√≥n
        const CONFIG = {
            API_KEY: 'AIzaSyDB0drcnkGdqKyJhsfStbcAQ7qiBqdhc4U',
            CLIENT_ID: '965807081420-jc0gsh5umaief7s262qi22ooa64bvv14.apps.googleusercontent.com',
            SPREADSHEET_ID: '1XJg_kvifS_e3UTztx7uhaNukCsnehuIF0ZhEC7lSFhw',
            HOJA_PLAN: 'BASE',
            HOJA_ASISTENCIA: 'ASISTENCIA',
            HOJA_VALORES: 'VALORES',
            DISCOVERY_DOCS: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets'
        };

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let datosGlobales = { planPadrino: [], asistencia: [], valores: {} };
        let usuarioActual = null;
        let intervaloActualizacion = null;
        let estadoFiltrosAsistencia = {
            busqueda: '',
            supervisor: '',
            ciudad: '',
            cargo: '',
            estado: ''
        };

        // Credenciales de usuarios
        const USUARIOS = {
            analista: {
                usuario: 'GestionLider',
                password: '4658*',
                rol: 'ANALISTA'
            },
            supervisor: {
                usuario: 'GestionAsistencia',
                password: '4658*',
                rol: 'SUPERVISOR'
            }
        };

        // Inicializar fecha actual
        const hoy = new Date();
        document.getElementById('fecha-actual').textContent = hoy.toLocaleDateString('es-CO');
        document.getElementById('fechaAsistencia').valueAsDate = hoy;

        // Modales
        const modalRegistrarAsistencia = new bootstrap.Modal(document.getElementById('modalRegistrarAsistencia'));
        const modalPersonal = new bootstrap.Modal(document.getElementById('modalPersonal'));

        // ========== GESTI√ìN DE TOKEN Y PERMISOS ==========
        async function verificarYRenovarToken() {
            const token = gapi.client.getToken();
            if (!token) {
                console.log('No hay token, solicitando autorizaci√≥n...');
                return false;
            }

            // Verificar si el token est√° por expirar (menos de 5 minutos)
            const ahora = Date.now();
            const expiracion = token.expires_at || 0;
            
            if (expiracion - ahora < 5 * 60 * 1000) {
                console.log('Token por expirar, renovando...');
                try {
                    await new Promise((resolve, reject) => {
                        tokenClient.callback = (resp) => {
                            if (resp.error !== undefined) {
                                reject(resp);
                            } else {
                                guardarSesion();
                                resolve(resp);
                            }
                        };
                        tokenClient.requestAccessToken({prompt: ''});
                    });
                    return true;
                } catch (error) {
                    console.error('Error renovando token:', error);
                    return false;
                }
            }
            
            return true;
        }

        async function ejecutarConReintento(operacion, nombreOperacion = 'operaci√≥n') {
            try {
                // Verificar token antes de ejecutar
                await verificarYRenovarToken();
                
                // Intentar la operaci√≥n
                return await operacion();
            } catch (error) {
                // Si es error de permisos, intentar renovar token y reintentar
                if (error.result?.error?.message?.includes('permission') || 
                    error.result?.error?.code === 403 ||
                    error.message?.includes('permission')) {
                    
                    console.log(`Error de permisos en ${nombreOperacion}, renovando token e intentando de nuevo...`);
                    
                    // Renovar token
                    const renovado = await verificarYRenovarToken();
                    
                    if (renovado) {
                        // Reintentar la operaci√≥n
                        try {
                            return await operacion();
                        } catch (retryError) {
                            console.error(`Reintento fallido en ${nombreOperacion}:`, retryError);
                            throw retryError;
                        }
                    }
                }
                
                throw error;
            }
        }
        function guardarSesion() {
            if (usuarioActual) {
                const sesion = {
                    usuario: usuarioActual,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('sesionUsuario', JSON.stringify(sesion));
            }

            const token = gapi.client.getToken();
            if (token) {
                localStorage.setItem('googleToken', JSON.stringify(token));
            }
        }

        function cargarSesionGuardada() {
            // Cargar sesi√≥n de usuario
            const sesionGuardada = localStorage.getItem('sesionUsuario');
            if (sesionGuardada) {
                const sesion = JSON.parse(sesionGuardada);
                const ahora = new Date().getTime();
                const unDia = 24 * 60 * 60 * 1000;

                // Si la sesi√≥n tiene menos de 1 d√≠a
                if (ahora - sesion.timestamp < unDia) {
                    usuarioActual = sesion.usuario;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('header-principal').style.display = 'block';
                    document.getElementById('mainTabs').style.display = 'flex';
                    document.getElementById('mainTabsContent').style.display = 'block';
                    document.getElementById('usuario-rol').textContent = `üë§ ${sesion.usuario.rol}`;
                    document.getElementById('btnCerrarSesionUsuario').style.display = 'inline-block';
                    configurarPermisos();
                } else {
                    // Sesi√≥n expirada
                    localStorage.removeItem('sesionUsuario');
                }
            }

            // Cargar token de Google
            const tokenGuardado = localStorage.getItem('googleToken');
            if (tokenGuardado && gapiInited) {
                const token = JSON.parse(tokenGuardado);
                gapi.client.setToken(token);
                document.getElementById('btnAutorizar').style.display = 'none';
                document.getElementById('btnCerrarSesion').style.display = 'inline-block';
                
                // Cargar datos si hay usuario
                if (usuarioActual) {
                    cargarPlanPadrino();
                    cargarValores();
                    iniciarActualizacionAutomatica();
                }
            }
        }

        function cerrarSesionCompleta() {
            usuarioActual = null;
            localStorage.removeItem('sesionUsuario');
            localStorage.removeItem('googleToken');
            
            if (intervaloActualizacion) {
                clearInterval(intervaloActualizacion);
                intervaloActualizacion = null;
            }
            
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('header-principal').style.display = 'none';
            document.getElementById('mainTabs').style.display = 'none';
            document.getElementById('mainTabsContent').style.display = 'none';
            document.getElementById('btnCerrarSesionUsuario').style.display = 'none';
            
            handleSignoutClick();
        }

        // Login
        document.getElementById('btnLogin').addEventListener('click', function() {
            const usuario = document.getElementById('login-usuario').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            const errorDiv = document.getElementById('login-error');
            errorDiv.style.display = 'none';

            // Validar credenciales
            let usuarioValido = null;
            for (const key in USUARIOS) {
                if (USUARIOS[key].usuario === usuario && USUARIOS[key].password === password) {
                    usuarioValido = USUARIOS[key];
                    break;
                }
            }

            if (!usuarioValido) {
                errorDiv.textContent = 'Usuario o contrase√±a incorrectos';
                errorDiv.style.display = 'block';
                return;
            }

            // Login exitoso
            usuarioActual = usuarioValido;
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('header-principal').style.display = 'block';
            document.getElementById('mainTabs').style.display = 'flex';
            document.getElementById('mainTabsContent').style.display = 'block';
            document.getElementById('usuario-rol').textContent = `üë§ ${usuarioValido.rol}`;
            document.getElementById('btnCerrarSesionUsuario').style.display = 'inline-block';

            // Configurar permisos seg√∫n rol
            configurarPermisos();

            // Guardar sesi√≥n
            guardarSesion();

            // Limpiar campos
            document.getElementById('login-usuario').value = '';
            document.getElementById('login-password').value = '';
        });

        // Permitir login con Enter
        document.getElementById('login-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnLogin').click();
            }
        });

        // Cerrar sesi√≥n de usuario
        document.getElementById('btnCerrarSesionUsuario').addEventListener('click', function() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                cerrarSesionCompleta();
            }
        });

        function configurarPermisos() {
            if (usuarioActual.rol === 'SUPERVISOR') {
                // Ocultar tabs que no puede usar
                document.getElementById('tab-plan').style.display = 'none';
                document.getElementById('tab-valores').style.display = 'none';
                
                // Mostrar controles de supervisor y ocultar de analista
                document.getElementById('controles-supervisor').style.display = 'block';
                document.getElementById('controles-analista').style.display = 'none';
                
                // Configurar columnas por defecto (solo Nombre, Cargo y Acciones)
                aplicarColumnasVisibles();
                
                // Asegurar que est√© en Asistencia
                document.getElementById('asistencia-tab').click();
            } else {
                // Mostrar todo para ANALISTA
                document.getElementById('tab-plan').style.display = 'block';
                document.getElementById('tab-valores').style.display = 'block';
                document.getElementById('controles-supervisor').style.display = 'none';
                document.getElementById('controles-analista').style.display = 'block';
                
                // Mostrar todas las columnas para analista
                document.querySelectorAll('#tablaAsistencia th, #tablaAsistencia td').forEach(el => {
                    el.style.display = '';
                });
            }
        }

        // Aplicar visibilidad de columnas seg√∫n checkboxes
        function aplicarColumnasVisibles() {
            const checkboxes = document.querySelectorAll('.columna-toggle');
            
            checkboxes.forEach(checkbox => {
                const colIndex = checkbox.dataset.col;
                const isVisible = checkbox.checked;
                
                // Aplicar a headers
                document.querySelectorAll(`#tablaAsistencia th[data-col="${colIndex}"]`).forEach(th => {
                    th.style.display = isVisible ? '' : 'none';
                });
                
                // Aplicar a celdas
                document.querySelectorAll(`#tablaAsistencia td[data-col="${colIndex}"]`).forEach(td => {
                    td.style.display = isVisible ? '' : 'none';
                });
            });
        }

        // Event listeners para checkboxes de columnas
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.columna-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', aplicarColumnasVisibles);
            });
        });

        // Inicializar GAPI
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: CONFIG.DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('btnAutorizar').style.display = 'inline-block';
                // Intentar cargar sesi√≥n guardada
                cargarSesionGuardada();
            }
        }

        // Autorizaci√≥n
        document.getElementById('btnAutorizar').addEventListener('click', handleAuthClick);
        document.getElementById('btnCerrarSesion').addEventListener('click', handleSignoutClick);

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                document.getElementById('btnAutorizar').style.display = 'none';
                document.getElementById('btnCerrarSesion').style.display = 'inline-block';
                
                // Guardar token
                guardarSesion();
                
                await cargarPlanPadrino();
                await cargarValores();
                
                // Iniciar actualizaci√≥n autom√°tica
                iniciarActualizacionAutomatica();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('googleToken');
                document.getElementById('btnAutorizar').style.display = 'inline-block';
                document.getElementById('btnCerrarSesion').style.display = 'none';
            }
            
            if (intervaloActualizacion) {
                clearInterval(intervaloActualizacion);
                intervaloActualizacion = null;
            }
        }

        // ========== ACTUALIZACI√ìN AUTOM√ÅTICA EN TIEMPO REAL ==========
        function iniciarActualizacionAutomatica() {
            // Actualizar cada 2 segundos
            if (intervaloActualizacion) {
                clearInterval(intervaloActualizacion);
            }
            
            intervaloActualizacion = setInterval(async () => {
                try {
                    // Solo actualizar si hay token v√°lido
                    if (gapi.client.getToken()) {
                        await cargarPlanPadrino();
                        
                        // Si est√° en la vista de asistencia y hay fecha seleccionada
                        const fecha = document.getElementById('fechaAsistencia').value;
                        if (fecha && document.getElementById('asistencia').classList.contains('active')) {
                            // Cargar en modo silencioso (sin alertas, manteniendo filtros)
                            await cargarAsistencia(true);
                        }
                    }
                } catch (error) {
                    console.error('Error en actualizaci√≥n autom√°tica:', error);
                }
            }, 2000); // 2 segundos
        }

        // Cargar Plan Padrino
        async function cargarPlanPadrino() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                const rows = response.result.values || [];
                if (rows.length === 0) {
                    console.warn('La hoja BASE est√° vac√≠a');
                    datosGlobales.planPadrino = [];
                } else {
                    datosGlobales.planPadrino = procesarPlanPadrino(rows);
                }
                
                renderizarPlanPadrino(datosGlobales.planPadrino);
                cargarFiltrosPlan();
            } catch (error) {
                console.error('Error al cargar BASE:', error);
                console.error('Detalle del error:', error.result || error.message || error);
                // No mostrar alert en actualizaciones autom√°ticas
                if (!intervaloActualizacion || datosGlobales.planPadrino.length === 0) {
                    alert('Error al cargar BASE: ' + (error.result?.error?.message || error.message || 'Error desconocido'));
                }
            }
        }

        function procesarPlanPadrino(rows) {
            if (rows.length <= 1) return [];
            
            const personal = [];
            const tecnicosMap = new Map();

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cedula = row[0]?.toString().trim();
                if (!cedula) continue;

                if (!tecnicosMap.has(cedula)) {
                    tecnicosMap.set(cedula, {
                        CEDULA: cedula,
                        NOMBRE: row[1] || '',
                        CARGO: row[2] || 'TECNICO',
                        CARPETA: row[3] || '',
                        CIUDAD: row[4] || '',
                        SUPERVISOR: row[5] || '',
                        LIDER: row[8] || '',
                        ANALISTA: row[9] || '',
                        ESTADO: row[17] || 'ACTIVO',
                        auxiliares: []
                    });
                }

                const cedulaAux = row[6]?.toString().trim();
                const nombreAux = row[7]?.toString().trim();
                
                if (cedulaAux && nombreAux) {
                    tecnicosMap.get(cedula).auxiliares.push({
                        cedula: cedulaAux,
                        nombre: nombreAux
                    });
                }
            }

            return Array.from(tecnicosMap.values());
        }

        function renderizarPlanPadrino(personal) {
            const tbody = document.getElementById('tbody-plan');
            tbody.innerHTML = '';

            personal.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'personal-row';
                tr.dataset.cedula = p.CEDULA;
                tr.dataset.nombre = p.NOMBRE.toLowerCase();
                tr.dataset.supervisor = p.SUPERVISOR.toLowerCase();
                tr.dataset.ciudad = p.CIUDAD.toLowerCase();

                const auxText = p.auxiliares.length > 0 
                    ? p.auxiliares.map(a => `${a.nombre} (${a.cedula})`).join('<br>')
                    : '<em class="text-muted">Sin auxiliares</em>';

                // Botones solo para ANALISTA
                const botonesAccion = usuarioActual && usuarioActual.rol === 'ANALISTA' 
                    ? `<button class="btn btn-sm btn-primary btn-editar-personal mt-1" data-cedula="${p.CEDULA}">‚úèÔ∏è Editar</button>
                       <button class="btn btn-sm btn-danger btn-eliminar-personal mt-1" data-cedula="${p.CEDULA}">üóëÔ∏è Eliminar</button>`
                    : '<em class="text-muted">Sin permisos</em>';

                tr.innerHTML = `
                    <td>${p.CEDULA}</td>
                    <td>${p.NOMBRE}</td>
                    <td><span class="badge bg-info">${p.CARGO}</span></td>
                    <td>${p.CIUDAD}</td>
                    <td>${p.SUPERVISOR}</td>
                    <td>${p.LIDER}</td>
                    <td>${p.ANALISTA}</td>
                    <td>${auxText}</td>
                    <td>
                        <span class="badge ${p.ESTADO === 'ACTIVO' ? 'bg-success' : 'bg-secondary'}">${p.ESTADO}</span><br>
                        ${botonesAccion}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Solo agregar event listeners para ANALISTA
            if (usuarioActual && usuarioActual.rol === 'ANALISTA') {
                document.querySelectorAll('.btn-editar-personal').forEach(btn => {
                    btn.addEventListener('click', editarPersonal);
                });
                document.querySelectorAll('.btn-eliminar-personal').forEach(btn => {
                    btn.addEventListener('click', eliminarPersonal);
                });
            }
        }

        // Cargar Asistencia
        document.getElementById('fechaAsistencia').addEventListener('change', cargarAsistencia);

        async function cargarAsistencia(silencioso = false) {
            try {
                const fecha = document.getElementById('fechaAsistencia').value;
                if (!fecha) {
                    if (!silencioso) alert('Seleccione una fecha');
                    return;
                }

                // Cargar plan padrino si no est√° cargado
                if (datosGlobales.planPadrino.length === 0) {
                    await cargarPlanPadrino();
                }

                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_ASISTENCIA}!A:J`,
                });

                const rows = response.result.values || [];
                if (rows.length === 0 && !silencioso) {
                    // Crear encabezados si no existen - LIMPIAR PRIMERO TODO
                    await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_ASISTENCIA}!A:Z`,
                    });
                    
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_ASISTENCIA}!A1:J1`,
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['FECHA', 'CEDULA', 'NOMBRE', 'CARGO', 'SUPERVISOR', 'CIUDAD', 'ESTADO', 'HORA_ENTRADA', 'TIPO_NOVEDAD', 'OBSERVACIONES']]
                        }
                    });
                }

                const asistenciaHoy = procesarAsistencia(rows, fecha);
                renderizarAsistencia(asistenciaHoy);
                
                // Siempre cargar las opciones de filtros
                cargarFiltrosAsistencia();
                
                // Si es silencioso, restaurar valores guardados
                if (silencioso) {
                    restaurarFiltrosAsistencia();
                }

            } catch (error) {
                console.error('Error completo al cargar asistencia:', error);
                console.error('Detalle del error:', error.result || error.message || error);
                if (!silencioso) alert('Error al cargar asistencia: ' + (error.result?.error?.message || error.message || 'Error desconocido'));
            }
        }

        function procesarAsistencia(rows, fecha) {
            const asistenciaMap = new Map();
            
            // Cargar registros existentes del d√≠a
            if (rows.length > 1) {
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const fechaReg = row[0];
                    const cedula = row[1]?.toString().trim();
                    
                    if (fechaReg === fecha && cedula) {
                        asistenciaMap.set(cedula, {
                            CEDULA: cedula,
                            NOMBRE: row[2] || '',
                            CARGO: row[3] || '',
                            SUPERVISOR: row[4] || '',
                            CIUDAD: row[5] || '',
                            ESTADO: row[6] || 'NO_ASISTE',
                            HORA_ENTRADA: row[7] || '',
                            TIPO_NOVEDAD: row[8] || '',
                            OBSERVACIONES: row[9] || ''
                        });
                    }
                }
            }

            // Agregar personal del plan padrino que no tiene registro
            const personal = [];
            datosGlobales.planPadrino.forEach(p => {
                if (asistenciaMap.has(p.CEDULA)) {
                    personal.push(asistenciaMap.get(p.CEDULA));
                } else {
                    personal.push({
                        CEDULA: p.CEDULA,
                        NOMBRE: p.NOMBRE,
                        CARGO: p.CARGO,
                        SUPERVISOR: p.SUPERVISOR,
                        CIUDAD: p.CIUDAD,
                        ESTADO: 'NO_ASISTE',
                        HORA_ENTRADA: '',
                        TIPO_NOVEDAD: '',
                        OBSERVACIONES: ''
                    });
                }

                // Agregar auxiliares
                p.auxiliares.forEach(aux => {
                    if (asistenciaMap.has(aux.cedula)) {
                        personal.push(asistenciaMap.get(aux.cedula));
                    } else {
                        personal.push({
                            CEDULA: aux.cedula,
                            NOMBRE: aux.nombre,
                            CARGO: 'AUXILIAR',
                            SUPERVISOR: p.SUPERVISOR,
                            CIUDAD: p.CIUDAD,
                            ESTADO: 'NO_ASISTE',
                            HORA_ENTRADA: '',
                            TIPO_NOVEDAD: '',
                            OBSERVACIONES: ''
                        });
                    }
                });
            });

            return personal;
        }

        function renderizarAsistencia(personal) {
            const tbody = document.getElementById('tbody-asistencia');
            tbody.innerHTML = '';

            // Calcular estad√≠sticas
            const total = personal.length;
            const asiste = personal.filter(p => p.ESTADO === 'ASISTE').length;
            const tarde = personal.filter(p => p.ESTADO === 'LLEGA_TARDE').length;
            const novedad = personal.filter(p => p.ESTADO === 'NOVEDAD').length;
            const noAsiste = personal.filter(p => p.ESTADO === 'NO_ASISTE').length;
            const ausentismo = total > 0 ? Math.round(((novedad + noAsiste) / total) * 100) : 0;

            document.getElementById('stat-total-asist').textContent = total;
            document.getElementById('stat-asiste').textContent = asiste;
            document.getElementById('stat-tarde').textContent = tarde;
            document.getElementById('stat-novedad').textContent = novedad;
            document.getElementById('stat-no-asiste').textContent = noAsiste;
            document.getElementById('stat-ausentismo').textContent = ausentismo + '%';

            personal.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = 'asistencia-row';
                tr.dataset.cedula = p.CEDULA;
                tr.dataset.nombre = p.NOMBRE.toLowerCase();
                tr.dataset.supervisor = p.SUPERVISOR.toLowerCase();
                tr.dataset.ciudad = p.CIUDAD.toLowerCase();
                tr.dataset.cargo = p.CARGO;
                tr.dataset.estado = p.ESTADO;

                tr.innerHTML = `
                    <td data-col="0">${p.CEDULA}</td>
                    <td data-col="1">${p.NOMBRE}</td>
                    <td data-col="2"><span class="badge bg-secondary">${p.CARGO}</span></td>
                    <td data-col="3">${p.CIUDAD}</td>
                    <td data-col="4">${p.SUPERVISOR}</td>
                    <td data-col="5"><span class="badge estado-${p.ESTADO}">${p.ESTADO.replace('_', ' ')}</span></td>
                    <td data-col="6">${p.HORA_ENTRADA}</td>
                    <td data-col="7">${p.TIPO_NOVEDAD}</td>
                    <td data-col="8">${p.OBSERVACIONES}</td>
                    <td data-col="9">
                        <button class="btn btn-sm btn-primary btn-registrar-asist" 
                                data-cedula="${p.CEDULA}"
                                data-nombre="${p.NOMBRE}"
                                data-cargo="${p.CARGO}"
                                data-ciudad="${p.CIUDAD}"
                                data-supervisor="${p.SUPERVISOR}">
                            üìù Registrar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.btn-registrar-asist').forEach(btn => {
                btn.addEventListener('click', abrirModalRegistrar);
            });

            // Aplicar visibilidad de columnas si es supervisor
            if (usuarioActual && usuarioActual.rol === 'SUPERVISOR') {
                aplicarColumnasVisibles();
            }
        }

        // Modal Registrar Asistencia
        function abrirModalRegistrar() {
            document.getElementById('asist-cedula').value = this.dataset.cedula;
            document.getElementById('asist-nombre').value = this.dataset.nombre;
            document.getElementById('asist-cargo').value = this.dataset.cargo;
            document.getElementById('asist-ciudad').value = this.dataset.ciudad;
            document.getElementById('asist-supervisor').value = this.dataset.supervisor;
            
            // LIMPIAR TODOS LOS CAMPOS
            document.getElementById('asist-estado').value = 'ASISTE';
            document.getElementById('asist-hora').value = '';
            document.getElementById('asist-tipo-novedad').value = '';
            document.getElementById('asist-dias-novedad').value = '';
            document.getElementById('asist-observaciones').value = '';
            
            // OCULTAR CAMPOS CONDICIONALES
            document.getElementById('div-hora-entrada').style.display = 'none';
            document.getElementById('div-tipo-novedad').style.display = 'none';
            document.getElementById('div-dias-novedad').style.display = 'none';
            
            modalRegistrarAsistencia.show();
        }

        document.getElementById('asist-estado').addEventListener('change', function() {
            const estado = this.value;
            document.getElementById('div-hora-entrada').style.display = estado === 'LLEGA_TARDE' ? 'block' : 'none';
            document.getElementById('div-tipo-novedad').style.display = estado === 'NOVEDAD' ? 'block' : 'none';
            document.getElementById('div-dias-novedad').style.display = 'none';
        });

        document.getElementById('asist-tipo-novedad').addEventListener('change', function() {
            const tipoNovedad = this.value;
            const novedadesConDias = ['INCAPACIDAD / EPS', 'VACACIONES', 'CALAMIDAD / LUTO'];
            document.getElementById('div-dias-novedad').style.display = novedadesConDias.includes(tipoNovedad) ? 'block' : 'none';
        });

        document.getElementById('btnGuardarAsistencia').addEventListener('click', async function() {
            const fecha = document.getElementById('fechaAsistencia').value;
            const cedula = document.getElementById('asist-cedula').value;
            const nombre = document.getElementById('asist-nombre').value;
            const cargo = document.getElementById('asist-cargo').value;
            const ciudad = document.getElementById('asist-ciudad').value;
            const supervisor = document.getElementById('asist-supervisor').value;
            const estado = document.getElementById('asist-estado').value;
            const hora = document.getElementById('asist-hora').value || '';
            const tipoNovedad = document.getElementById('asist-tipo-novedad').value || '';
            const diasNovedad = document.getElementById('asist-dias-novedad').value || '';
            const observaciones = document.getElementById('asist-observaciones').value || '';

            if (estado === 'LLEGA_TARDE' && !hora) {
                alert('Debe especificar la hora de entrada');
                return;
            }

            if (estado === 'NOVEDAD' && !tipoNovedad) {
                alert('Debe especificar el tipo de novedad');
                return;
            }

            const novedadesConDias = ['INCAPACIDAD / EPS', 'VACACIONES', 'CALAMIDAD / LUTO'];
            if (estado === 'NOVEDAD' && novedadesConDias.includes(tipoNovedad) && !diasNovedad) {
                alert('Debe especificar el n√∫mero de d√≠as');
                return;
            }

            try {
                // Actualizar estado en BASE si es novedad
                if (estado === 'NOVEDAD') {
                    await actualizarEstadoEnBase(cedula, tipoNovedad);
                }

                // Buscar si ya existe registro
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_ASISTENCIA}!A:J`,
                });

                const rows = response.result.values || [];
                
                // Asegurar que existan encabezados
                if (rows.length === 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_ASISTENCIA}!A1:J1`,
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['FECHA', 'CEDULA', 'NOMBRE', 'CARGO', 'SUPERVISOR', 'CIUDAD', 'ESTADO', 'HORA_ENTRADA', 'TIPO_NOVEDAD', 'OBSERVACIONES']]
                        }
                    });
                }
                
                let filaExistente = -1;

                for (let i = 1; i < rows.length; i++) {
                    if (rows[i][0] === fecha && rows[i][1] === cedula) {
                        filaExistente = i + 1;
                        break;
                    }
                }

                const observacionesCompletas = diasNovedad ? `${observaciones} [${diasNovedad} d√≠as]`.trim() : observaciones;
                const valores = [[fecha, cedula, nombre, cargo, supervisor, ciudad, estado, hora, tipoNovedad, observacionesCompletas]];

                if (filaExistente > 0) {
                    // Actualizar - usar rango expl√≠cito A a J
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_ASISTENCIA}!A${filaExistente}:J${filaExistente}`,
                        valueInputOption: 'RAW',
                        resource: { values: valores }
                    });
                } else {
                    // Agregar - usar append pero con rango expl√≠cito
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_ASISTENCIA}!A:J`,
                        valueInputOption: 'RAW',
                        insertDataOption: 'INSERT_ROWS',
                        resource: { values: valores }
                    });
                }

                alert('‚úÖ Asistencia registrada correctamente');
                modalRegistrarAsistencia.hide();
                await cargarAsistencia();

            } catch (error) {
                console.error('Error completo al guardar:', error);
                console.error('Detalle del error:', error.result || error.message || error);
                alert('Error al guardar: ' + (error.result?.error?.message || error.message || 'Error desconocido. Revisa la consola para m√°s detalles.'));
            }
        });

        async function actualizarEstadoEnBase(cedula, tipoNovedad) {
            try {
                const mapeoEstados = {
                    'INCAPACIDAD / EPS': 'INCAPACITADO',
                    'VACACIONES': 'VACACIONES',
                    'RETIRO / RENUNCIA': 'RETIRADO',
                    'SUSPENSI√ìN': 'SUSPENDIDO',
                    'CALAMIDAD / LUTO': 'CALAMIDAD'
                };

                const nuevoEstado = mapeoEstados[tipoNovedad] || 'ACTIVO';

                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                const rows = response.result.values || [];
                
                for (let i = 1; i < rows.length; i++) {
                    if (rows[i][0] === cedula) {
                        // Asegurar que el array tenga 18 elementos
                        while (rows[i].length < 18) {
                            rows[i].push('');
                        }
                        rows[i][17] = nuevoEstado; // Columna R (√≠ndice 17)
                    }
                }

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A1:R${rows.length}`,
                    valueInputOption: 'RAW',
                    resource: { values: rows }
                });

            } catch (error) {
                console.error('Error completo al actualizar estado:', error);
                console.error('Detalle del error:', error.result || error.message || error);
            }
        }

        // Modal Personal
        document.getElementById('btnAgregarPersonal').addEventListener('click', function() {
            // Solo ANALISTA puede agregar
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            cargarDropdownsPersonal();
            
            document.getElementById('tituloModalPersonal').textContent = 'Agregar Personal';
            document.getElementById('personal-modo').value = 'agregar';
            document.getElementById('personal-cedula-original').value = '';
            
            document.getElementById('personal-cedula').value = '';
            document.getElementById('personal-nombre').value = '';
            document.getElementById('personal-cargo').value = 'TECNICO';
            document.getElementById('personal-carpeta').value = '';
            document.getElementById('personal-ciudad').value = '';
            document.getElementById('personal-supervisor').value = '';
            document.getElementById('personal-lider').value = '';
            document.getElementById('personal-analista').value = '';
            
            document.getElementById('auxiliares-container').innerHTML = `
                <div class="auxiliar-item mb-2">
                    <div class="row">
                        <div class="col-md-5">
                            <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `;
            
            modalPersonal.show();
        });

        function editarPersonal() {
            // Solo ANALISTA puede editar
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            const cedula = this.dataset.cedula;
            const persona = datosGlobales.planPadrino.find(p => p.CEDULA === cedula);
            
            if (!persona) return;

            cargarDropdownsPersonal();

            document.getElementById('tituloModalPersonal').textContent = 'Editar Personal';
            document.getElementById('personal-modo').value = 'editar';
            document.getElementById('personal-cedula-original').value = cedula;
            
            document.getElementById('personal-cedula').value = persona.CEDULA;
            document.getElementById('personal-nombre').value = persona.NOMBRE;
            document.getElementById('personal-cargo').value = persona.CARGO;
            document.getElementById('personal-carpeta').value = persona.CARPETA || '';
            document.getElementById('personal-ciudad').value = persona.CIUDAD;
            document.getElementById('personal-supervisor').value = persona.SUPERVISOR;
            document.getElementById('personal-lider').value = persona.LIDER;
            document.getElementById('personal-analista').value = persona.ANALISTA;
            
            const container = document.getElementById('auxiliares-container');
            container.innerHTML = '';
            
            if (persona.auxiliares.length > 0) {
                persona.auxiliares.forEach(aux => {
                    container.innerHTML += `
                        <div class="auxiliar-item mb-2">
                            <div class="row">
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar" value="${aux.cedula}">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar" value="${aux.nombre}">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = `
                    <div class="auxiliar-item mb-2">
                        <div class="row">
                            <div class="col-md-5">
                                <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                            </div>
                            <div class="col-md-5">
                                <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modalPersonal.show();
        }

        document.getElementById('btnAgregarAuxiliar').addEventListener('click', function() {
            const container = document.getElementById('auxiliares-container');
            const div = document.createElement('div');
            div.className = 'auxiliar-item mb-2';
            div.innerHTML = `
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" class="form-control auxiliar-cedula" placeholder="C√©dula Auxiliar">
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control auxiliar-nombre" placeholder="Nombre Auxiliar">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm w-100" onclick="eliminarAuxiliar(this)">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
        });

        function eliminarAuxiliar(btn) {
            btn.closest('.auxiliar-item').remove();
        }

        document.getElementById('btnGuardarPersonal').addEventListener('click', async function() {
            const modo = document.getElementById('personal-modo').value;
            const cedulaOriginal = document.getElementById('personal-cedula-original').value;
            
            const cedula = document.getElementById('personal-cedula').value.trim();
            const nombre = document.getElementById('personal-nombre').value.trim();
            const cargo = document.getElementById('personal-cargo').value;
            const carpeta = document.getElementById('personal-carpeta').value.trim();
            const ciudad = document.getElementById('personal-ciudad').value.trim();
            const supervisor = document.getElementById('personal-supervisor').value.trim();
            const lider = document.getElementById('personal-lider').value.trim();
            const analista = document.getElementById('personal-analista').value.trim();

            if (!cedula || !nombre || !ciudad || !supervisor) {
                alert('Complete los campos obligatorios');
                return;
            }

            try {
                // Recopilar auxiliares
                const auxiliares = [];
                document.querySelectorAll('.auxiliar-item').forEach(item => {
                    const cedAux = item.querySelector('.auxiliar-cedula').value.trim();
                    const nomAux = item.querySelector('.auxiliar-nombre').value.trim();
                    if (cedAux && nomAux) {
                        auxiliares.push({ cedula: cedAux, nombre: nomAux });
                    }
                });

                // Obtener datos actuales
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                let rows = response.result.values || [];

                // Eliminar registros antiguos si es edici√≥n
                if (modo === 'editar') {
                    rows = rows.filter((row, idx) => idx === 0 || row[0] !== cedulaOriginal);
                }

                // Agregar nuevos registros
                if (auxiliares.length === 0) {
                    const newRow = [cedula, nombre, cargo, carpeta, ciudad, supervisor, '', '', lider, analista];
                    // Rellenar hasta columna R (√≠ndice 17)
                    while (newRow.length < 18) {
                        newRow.push('');
                    }
                    newRow[17] = 'ACTIVO'; // Columna R
                    rows.push(newRow);
                } else {
                    auxiliares.forEach(aux => {
                        const newRow = [cedula, nombre, cargo, carpeta, ciudad, supervisor, aux.cedula, aux.nombre, lider, analista];
                        // Rellenar hasta columna R (√≠ndice 17)
                        while (newRow.length < 18) {
                            newRow.push('');
                        }
                        newRow[17] = 'ACTIVO'; // Columna R
                        rows.push(newRow);
                    });
                }

                // Actualizar hoja completa
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A1:R${rows.length}`,
                    valueInputOption: 'RAW',
                    resource: { values: rows }
                });

                alert('‚úÖ Personal guardado correctamente');
                modalPersonal.hide();
                await cargarPlanPadrino();

            } catch (error) {
                console.error('Error completo al guardar asistencia:', error);
                console.error('Detalle del error:', error.result || error.message || error);
                alert('Error al guardar: ' + (error.result?.error?.message || error.message || 'Error desconocido. Revisa la consola.'));
            }
        });

        async function eliminarPersonal() {
            // Solo ANALISTA puede eliminar
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            const cedula = this.dataset.cedula;
            
            console.log('=== INICIANDO ELIMINACI√ìN ===');
            console.log('C√©dula a eliminar:', cedula);
            
            if (!confirm('¬øEst√° seguro de eliminar este personal y todos sus auxiliares asociados?')) return;

            try {
                // Obtener datos
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_PLAN}!A:R`,
                });

                const rows = response.result.values || [];
                console.log('Total de filas le√≠das:', rows.length);
                
                // Encontrar todas las filas a eliminar
                const filasAEliminar = [];
                for (let i = 1; i < rows.length; i++) {
                    const cedulaFila = rows[i][0]?.toString().trim();
                    console.log(`Fila ${i}: c√©dula="${cedulaFila}" comparando con "${cedula}"`);
                    if (cedulaFila === cedula) {
                        console.log(`‚úì Coincidencia encontrada en fila ${i}`);
                        filasAEliminar.push(i);
                    }
                }

                console.log('Filas a eliminar:', filasAEliminar);

                if (filasAEliminar.length === 0) {
                    alert('No se encontr√≥ el registro. Revisa la consola para ver los datos.');
                    return;
                }

                // Obtener el sheetId
                const metadataResponse = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID
                });

                const sheets = metadataResponse.result.sheets;
                console.log('Hojas disponibles:', sheets.map(s => s.properties.title));
                
                const baseSheet = sheets.find(s => s.properties.title === CONFIG.HOJA_PLAN);
                
                if (!baseSheet) {
                    alert('No se encontr√≥ la hoja BASE');
                    return;
                }

                const sheetId = baseSheet.properties.sheetId;
                console.log('SheetId de BASE:', sheetId);

                // Crear requests para eliminar (de abajo hacia arriba)
                const requests = [];
                for (let i = filasAEliminar.length - 1; i >= 0; i--) {
                    const filaIndex = filasAEliminar[i];
                    console.log(`Preparando eliminaci√≥n de fila ${filaIndex}`);
                    requests.push({
                        deleteDimension: {
                            range: {
                                sheetId: sheetId,
                                dimension: 'ROWS',
                                startIndex: filaIndex,
                                endIndex: filaIndex + 1
                            }
                        }
                    });
                }

                console.log('Requests a ejecutar:', JSON.stringify(requests, null, 2));

                // Ejecutar eliminaci√≥n
                const deleteResponse = await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    resource: { requests: requests }
                });

                console.log('Respuesta de eliminaci√≥n:', deleteResponse);
                alert('‚úÖ Personal eliminado correctamente');
                await cargarPlanPadrino();

            } catch (error) {
                console.error('Error completo:', error);
                console.error('Error detallado:', JSON.stringify(error, null, 2));
                alert('Error al eliminar: ' + (error.result?.error?.message || error.message));
            }
        }

        // Filtros Plan Padrino
        document.getElementById('busquedaPlan').addEventListener('input', filtrarPlan);
        document.getElementById('filtroSupervisorPlan').addEventListener('change', filtrarPlan);
        document.getElementById('filtroCiudadPlan').addEventListener('change', filtrarPlan);

        function filtrarPlan() {
            const busqueda = document.getElementById('busquedaPlan').value.toLowerCase();
            const supervisor = document.getElementById('filtroSupervisorPlan').value.toLowerCase();
            const ciudad = document.getElementById('filtroCiudadPlan').value.toLowerCase();

            document.querySelectorAll('.personal-row').forEach(fila => {
                const nombre = fila.dataset.nombre;
                const cedula = fila.dataset.cedula.toLowerCase();
                const sup = fila.dataset.supervisor;
                const ciu = fila.dataset.ciudad;

                const visible = (nombre.includes(busqueda) || cedula.includes(busqueda)) &&
                                (!supervisor || sup.includes(supervisor)) &&
                                (!ciudad || ciu.includes(ciudad));

                fila.style.display = visible ? '' : 'none';
            });
        }

        function cargarFiltrosPlan() {
            const supervisores = [...new Set(datosGlobales.planPadrino.map(p => p.SUPERVISOR))].filter(s => s).sort();
            const ciudades = [...new Set(datosGlobales.planPadrino.map(p => p.CIUDAD))].filter(c => c).sort();

            const selectSup = document.getElementById('filtroSupervisorPlan');
            const selectCiu = document.getElementById('filtroCiudadPlan');

            selectSup.innerHTML = '<option value="">üìä Todos los supervisores</option>';
            supervisores.forEach(s => selectSup.innerHTML += `<option value="${s}">${s}</option>`);

            selectCiu.innerHTML = '<option value="">üèôÔ∏è Todas las ciudades</option>';
            ciudades.forEach(c => selectCiu.innerHTML += `<option value="${c}">${c}</option>`);
        }

        // ========== EXPORTAR A EXCEL ==========
        document.getElementById('btnExportarAsistencia').addEventListener('click', function() {
            exportarTablaAExcel('tablaAsistencia', 'Asistencia');
        });
        
        document.getElementById('btnExportarAsistencia2').addEventListener('click', function() {
            exportarTablaAExcel('tablaAsistencia', 'Asistencia');
        });

        document.getElementById('btnExportarPlan').addEventListener('click', function() {
            exportarTablaAExcel('tablaPlanPadrino', 'Base_Personal');
        });

        function exportarTablaAExcel(idTabla, nombreArchivo) {
            try {
                const tabla = document.getElementById(idTabla);
                const filas = tabla.querySelectorAll('tbody tr');
                
                // Verificar si hay filas visibles
                const filasVisibles = Array.from(filas).filter(fila => fila.style.display !== 'none');
                
                if (filasVisibles.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }

                // Crear datos para Excel
                const datos = [];
                
                // Obtener encabezados
                const encabezados = [];
                tabla.querySelectorAll('thead th').forEach(th => {
                    encabezados.push(th.textContent.trim());
                });
                datos.push(encabezados);

                // Obtener filas visibles
                filasVisibles.forEach(fila => {
                    const filaData = [];
                    fila.querySelectorAll('td').forEach((td, index) => {
                        // No incluir la columna de Acciones (√∫ltima columna)
                        if (index < encabezados.length - 1) {
                            // Extraer solo texto, sin HTML
                            let texto = td.textContent.trim();
                            // Limpiar espacios m√∫ltiples y saltos de l√≠nea
                            texto = texto.replace(/\s+/g, ' ');
                            filaData.push(texto);
                        }
                    });
                    datos.push(filaData);
                });

                // Crear libro de Excel
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(datos);

                // Ajustar ancho de columnas
                const colWidths = encabezados.map(() => ({wch: 15}));
                ws['!cols'] = colWidths;

                // Agregar hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Datos');

                // Generar nombre de archivo con fecha
                const fecha = new Date().toISOString().split('T')[0];
                const nombreFinal = `${nombreArchivo}_${fecha}.xlsx`;

                // Descargar archivo
                XLSX.writeFile(wb, nombreFinal);

                alert(`‚úÖ Archivo exportado: ${nombreFinal}`);
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('Error al exportar: ' + error.message);
            }
        }

        // ========== VALORES PERMITIDOS ==========
        async function cargarValores() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_VALORES}!A:E`,
                });

                const rows = response.result.values || [];
                
                if (rows.length === 0) {
                    // Crear encabezados si no existen
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CONFIG.SPREADSHEET_ID,
                        range: `${CONFIG.HOJA_VALORES}!A1:E1`,
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['CARPETA', 'CIUDAD', 'SUPERVISOR', 'LIDER', 'ANALISTA']]
                        }
                    });
                    datosGlobales.valores = {CARPETA: [], CIUDAD: [], SUPERVISOR: [], LIDER: [], ANALISTA: []};
                } else {
                    datosGlobales.valores = {
                        CARPETA: [],
                        CIUDAD: [],
                        SUPERVISOR: [],
                        LIDER: [],
                        ANALISTA: []
                    };

                    // Procesar cada columna
                    const maxRows = Math.max(...rows.map(r => r.length));
                    const numRows = rows.length;

                    for (let col = 0; col < 5; col++) {
                        const columnas = ['CARPETA', 'CIUDAD', 'SUPERVISOR', 'LIDER', 'ANALISTA'];
                        for (let row = 1; row < numRows; row++) {
                            const valor = rows[row][col]?.toString().trim();
                            if (valor) {
                                datosGlobales.valores[columnas[col]].push(valor);
                            }
                        }
                    }
                }

                renderizarValores();
            } catch (error) {
                console.error('Error cargando valores:', error);
                alert('Error al cargar valores permitidos: ' + error.message);
            }
        }

        function renderizarValores() {
            const puedeEditar = usuarioActual && usuarioActual.rol === 'ANALISTA';
            
            // Carpetas
            const listaCarpetas = document.getElementById('lista-carpetas');
            listaCarpetas.innerHTML = '';
            datosGlobales.valores.CARPETA.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('CARPETA', '${v}')">√ó</button>` : '';
                listaCarpetas.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });

            // Ciudades
            const listaCiudades = document.getElementById('lista-ciudades');
            listaCiudades.innerHTML = '';
            datosGlobales.valores.CIUDAD.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('CIUDAD', '${v}')">√ó</button>` : '';
                listaCiudades.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });

            // Supervisores
            const listaSupervisores = document.getElementById('lista-supervisores');
            listaSupervisores.innerHTML = '';
            datosGlobales.valores.SUPERVISOR.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('SUPERVISOR', '${v}')">√ó</button>` : '';
                listaSupervisores.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });

            // L√≠deres
            const listaLideres = document.getElementById('lista-lideres');
            listaLideres.innerHTML = '';
            datosGlobales.valores.LIDER.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('LIDER', '${v}')">√ó</button>` : '';
                listaLideres.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });

            // Analistas
            const listaAnalistas = document.getElementById('lista-analistas');
            listaAnalistas.innerHTML = '';
            datosGlobales.valores.ANALISTA.forEach(v => {
                const btnEliminar = puedeEditar ? `<button onclick="eliminarValor('ANALISTA', '${v}')">√ó</button>` : '';
                listaAnalistas.innerHTML += `<span class="valor-badge">${v}${btnEliminar}</span>`;
            });
        }

        async function agregarValor(tipo) {
            // Solo ANALISTA puede agregar valores
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            const inputs = {
                'CARPETA': 'nuevaCarpeta',
                'CIUDAD': 'nuevaCiudad',
                'SUPERVISOR': 'nuevoSupervisor',
                'LIDER': 'nuevoLider',
                'ANALISTA': 'nuevoAnalista'
            };

            const input = document.getElementById(inputs[tipo]);
            const valor = input.value.trim();

            if (!valor) {
                alert('Ingrese un valor');
                return;
            }

            if (datosGlobales.valores[tipo].includes(valor)) {
                alert('Este valor ya existe');
                return;
            }

            try {
                datosGlobales.valores[tipo].push(valor);
                await guardarValores();
                input.value = '';
                renderizarValores();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al agregar valor: ' + error.message);
            }
        }

        async function eliminarValor(tipo, valor) {
            // Solo ANALISTA puede eliminar valores
            if (!usuarioActual || usuarioActual.rol !== 'ANALISTA') {
                alert('No tienes permisos para realizar esta acci√≥n');
                return;
            }

            if (!confirm(`¬øEliminar "${valor}"?`)) return;

            try {
                datosGlobales.valores[tipo] = datosGlobales.valores[tipo].filter(v => v !== valor);
                await guardarValores();
                renderizarValores();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar valor: ' + error.message);
            }
        }

        async function guardarValores() {
            try {
                // Preparar datos en columnas
                const maxLength = Math.max(
                    datosGlobales.valores.CARPETA.length,
                    datosGlobales.valores.CIUDAD.length,
                    datosGlobales.valores.SUPERVISOR.length,
                    datosGlobales.valores.LIDER.length,
                    datosGlobales.valores.ANALISTA.length
                );

                const rows = [['CARPETA', 'CIUDAD', 'SUPERVISOR', 'LIDER', 'ANALISTA']];

                for (let i = 0; i < maxLength; i++) {
                    rows.push([
                        datosGlobales.valores.CARPETA[i] || '',
                        datosGlobales.valores.CIUDAD[i] || '',
                        datosGlobales.valores.SUPERVISOR[i] || '',
                        datosGlobales.valores.LIDER[i] || '',
                        datosGlobales.valores.ANALISTA[i] || ''
                    ]);
                }

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.HOJA_VALORES}!A1:E${rows.length}`,
                    valueInputOption: 'RAW',
                    resource: { values: rows }
                });
            } catch (error) {
                throw error;
            }
        }

        // Cargar dropdowns en modal de personal
        function cargarDropdownsPersonal() {
            // Carpeta
            const selectCarpeta = document.getElementById('personal-carpeta');
            selectCarpeta.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.CARPETA.forEach(v => {
                selectCarpeta.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // Ciudad
            const selectCiudad = document.getElementById('personal-ciudad');
            selectCiudad.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.CIUDAD.forEach(v => {
                selectCiudad.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // Supervisor
            const selectSupervisor = document.getElementById('personal-supervisor');
            selectSupervisor.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.SUPERVISOR.forEach(v => {
                selectSupervisor.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // L√≠der
            const selectLider = document.getElementById('personal-lider');
            selectLider.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.LIDER.forEach(v => {
                selectLider.innerHTML += `<option value="${v}">${v}</option>`;
            });

            // Analista
            const selectAnalista = document.getElementById('personal-analista');
            selectAnalista.innerHTML = '<option value="">Seleccionar...</option>';
            datosGlobales.valores.ANALISTA.forEach(v => {
                selectAnalista.innerHTML += `<option value="${v}">${v}</option>`;
            });
        }

        // Filtros Asistencia
        document.getElementById('busquedaAsist').addEventListener('input', function() {
            estadoFiltrosAsistencia.busqueda = this.value;
            filtrarAsistencia();
        });
        document.getElementById('filtroSupervisorAsist').addEventListener('input', function() {
            estadoFiltrosAsistencia.supervisor = this.value;
            filtrarAsistencia();
        });
        document.getElementById('filtroCiudadAsist').addEventListener('input', function() {
            estadoFiltrosAsistencia.ciudad = this.value;
            filtrarAsistencia();
        });
        document.getElementById('filtroCargoAsist').addEventListener('change', function() {
            estadoFiltrosAsistencia.cargo = this.value;
            filtrarAsistencia();
        });
        document.getElementById('filtroEstadoAsist').addEventListener('change', function() {
            estadoFiltrosAsistencia.estado = this.value;
            filtrarAsistencia();
        });

        function filtrarAsistencia() {
            const busqueda = estadoFiltrosAsistencia.busqueda.toLowerCase();
            const supervisor = estadoFiltrosAsistencia.supervisor.toLowerCase();
            const ciudad = estadoFiltrosAsistencia.ciudad.toLowerCase();
            const cargo = estadoFiltrosAsistencia.cargo;
            const estado = estadoFiltrosAsistencia.estado;

            let totalFiltrado = 0;
            let asisteFiltrado = 0;
            let tardeFiltrado = 0;
            let novedadFiltrado = 0;
            let noAsisteFiltrado = 0;

            document.querySelectorAll('.asistencia-row').forEach(fila => {
                const nombre = fila.dataset.nombre;
                const cedula = fila.dataset.cedula.toLowerCase();
                const sup = fila.dataset.supervisor;
                const ciu = fila.dataset.ciudad;
                const car = fila.dataset.cargo;
                const est = fila.dataset.estado;

                const visible = (nombre.includes(busqueda) || cedula.includes(busqueda)) &&
                                (!supervisor || sup.includes(supervisor)) &&
                                (!ciudad || ciu.includes(ciudad)) &&
                                (!cargo || car === cargo) &&
                                (!estado || est === estado);

                fila.style.display = visible ? '' : 'none';

                if (visible) {
                    totalFiltrado++;
                    if (est === 'ASISTE') asisteFiltrado++;
                    else if (est === 'LLEGA_TARDE') tardeFiltrado++;
                    else if (est === 'NOVEDAD') novedadFiltrado++;
                    else if (est === 'NO_ASISTE') noAsisteFiltrado++;
                }
            });

            document.getElementById('stat-total-asist').textContent = totalFiltrado;
            document.getElementById('stat-asiste').textContent = asisteFiltrado;
            document.getElementById('stat-tarde').textContent = tardeFiltrado;
            document.getElementById('stat-novedad').textContent = novedadFiltrado;
            document.getElementById('stat-no-asiste').textContent = noAsisteFiltrado;

            const ausentismo = totalFiltrado > 0 ? Math.round(((novedadFiltrado + noAsisteFiltrado) / totalFiltrado) * 100) : 0;
            document.getElementById('stat-ausentismo').textContent = ausentismo + '%';
        }

        function cargarFiltrosAsistencia() {
            const supervisores = [...new Set(datosGlobales.planPadrino.map(p => p.SUPERVISOR))].filter(s => s).sort();
            const ciudades = [...new Set(datosGlobales.planPadrino.map(p => p.CIUDAD))].filter(c => c).sort();

            const datalistSup = document.getElementById('lista-supervisores-asist');
            const datalistCiu = document.getElementById('lista-ciudades-asist');
            
            // Guardar valores actuales
            const valorActualSup = document.getElementById('filtroSupervisorAsist').value;
            const valorActualCiu = document.getElementById('filtroCiudadAsist').value;

            datalistSup.innerHTML = '';
            supervisores.forEach(s => {
                datalistSup.innerHTML += `<option value="${s}">`;
            });

            datalistCiu.innerHTML = '';
            ciudades.forEach(c => {
                datalistCiu.innerHTML += `<option value="${c}">`;
            });
            
            // Restaurar valores si exist√≠an
            if (valorActualSup) document.getElementById('filtroSupervisorAsist').value = valorActualSup;
            if (valorActualCiu) document.getElementById('filtroCiudadAsist').value = valorActualCiu;
        }

        function restaurarFiltrosAsistencia() {
            // Restaurar valores de los filtros sin recargar opciones
            document.getElementById('busquedaAsist').value = estadoFiltrosAsistencia.busqueda;
            document.getElementById('filtroSupervisorAsist').value = estadoFiltrosAsistencia.supervisor;
            document.getElementById('filtroCiudadAsist').value = estadoFiltrosAsistencia.ciudad;
            document.getElementById('filtroCargoAsist').value = estadoFiltrosAsistencia.cargo;
            document.getElementById('filtroEstadoAsist').value = estadoFiltrosAsistencia.estado;
            
            // Aplicar filtros
            filtrarAsistencia();
        }
    </script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</body>
</html>
